<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catálogo de Produtos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Incluindo a biblioteca html2pdf.js para gerar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- Incluindo a biblioteca Chart.js e o plugin de datalabels -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>

    <style>
        /* Estilos para a barra de rolagem para uma melhor estética */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Estilo para o item ativo na lista de produtos */
        .product-item.active {
            background-color: #e0f2fe; /* light-blue-100 */
        }
        /* Estilo para o link de navegação ativo */
        .nav-link.active {
            background-color: #3b82f6; /* blue-500 */
            color: white;
        }
        /* Estilo para o hover do link de navegação ativo */
        .nav-link.active:hover {
            background-color: #2563eb; /* blue-600 */
        }
        /* Animação de giro para o ícone de refresh */
        .spinning {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }
        /* Estilo para o card de status de estoque ativo */
        .status-card.active {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        /* Estilo para cabeçalho de tabela ordenável */
        .sortable-header {
            cursor: pointer;
        }
        .sortable-header:hover {
            background-color: #f0f0f0;
        }
        /* Estilo para linha de tabela de pedido clicável */
        .order-row {
            cursor: pointer;
        }
        .order-row:hover {
            background-color: #f9fafb; /* gray-50 */
        }
        /* Novas classes para cores de linha no modal */
        .row-ok {
            background-color: #dcfce7; /* green-50 */
        }
        .row-pending {
            background-color: #fff7ed; /* orange-50 */
        }
        .row-overdue { /* Novo estilo para itens atrasados */
            background-color: #fee2e2; /* red-100 */
        }
        /* NOVO: Estilos para linhas da tabela NFe no modal de impressão */
        .row-conferido {
            background-color: #dcfce7; /* green-50 */
        }
        .row-nao-conferido {
            background-color: #fee2e2; /* red-100 */
        }

        /* Estilo para a barra de ações do relatório - NÃO É MAIS FIXA */
        /* Ela agora é um elemento no fluxo normal do documento, abaixo do header e da global-filter-bar */
        .report-action-bar-style { /* Nova classe para aplicar estilos visuais */
            background-color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            z-index: 20; /* Mesmo z-index da global-filter-bar */
            border-bottom: 1px solid #e5e7eb; /* gray-200 */
        }
        .report-action-bar-style .left-buttons,
        .report-action-bar-style .right-buttons {
            display: flex;
            gap: 1rem;
        }

        /* Estilo para o tooltip personalizado */
        #custom-product-tooltip {
            pointer-events: none; /* Permite que o mouse passe por baixo do tooltip */
            transition: opacity 0.2s ease-in-out; /* Adiciona uma transição suave */
            opacity: 0; /* Começa invisível */
        }

        /* Estilos para o ícone de modo de visualização */
        #toggle-view-mode-icon {
            cursor: pointer;
            color: #3b82f6; /* blue-500 */
            transition: transform 0.3s ease-in-out;
        }
        #toggle-view-mode-icon:hover {
            transform: scale(1.1);
        }

        /* ATUALIZADO: Estilos para a tabela na PRÉ-VISUALIZAÇÃO (com coluna de Ações) */
        .print-preview-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }
        .print-preview-table th,
        .print-preview-table td {
            border: 1px solid #ccc;
            padding: 4px 6px;
            text-align: left;
            font-size: 8px;
            vertical-align: top;
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: normal; /* Permite que o texto quebre linha */
        }
        .print-preview-table th {
            background-color: #f0f0f0;
        }
        /* Larguras para a tabela de PRÉ-VISUALIZAÇÃO NFe (14 colunas) */
        .print-preview-table th:nth-child(1), .print-preview-table td:nth-child(1) { width: 5%; } /* AÇÕES */
        .print-preview-table th:nth-child(2), .print-preview-table td:nth-child(2) { width: 7%; } /* Nº DA NOTA */
        .print-preview-table th:nth-child(3), .print-preview-table td:nth-child(3) { width: 7%; } /* DATA DE EMISSÃO */
        .print-preview-table th:nth-child(4), .print-preview-table td:nth-child(4) { width: 5%; } /* SITUAÇÃO */
        .print-preview-table th:nth-child(5), .print-preview-table td:nth-child(5) { width: 7%; } /* VALOR DA NOTA */
        .print-preview-table th:nth-child(6), .print-preview-table td:nth-child(6) { width: 6%; } /* VALOR DO FRETE */
        .print-preview-table th:nth-child(7), .print-preview-table td:nth-child(7) { width: 10%; } /* NOME DO CLIENTE */
        .print-preview-table th:nth-child(8), .print-preview-table td:nth-child(8) { width: 9%; } /* CNPJ/CPF CLIENTE */
        .print-preview-table th:nth-child(9), .print-preview-table td:nth-child(9) { width: 9%; } /* NOME DO VENDEDOR */
        .print-preview-table th:nth-child(10), .print-preview-table td:nth-child(10) { width: 6%; } /* Nº PEDIDO LOJA */
        .print-preview-table th:nth-child(11), .print-preview-table td:nth-child(11) { width: 8%; } /* TRANSPORTADORA */
        .print-preview-table th:nth-child(12), .print-preview-table td:nth-child(12) { width: 5%; } /* FRETE POR CONTA */
        .print-preview-table th:nth-child(13), .print-preview-table td:nth-child(13) { width: 6%; } /* ORIGEM LOJA */
        .print-preview-table th:nth-child(14), .print-preview-table td:nth-child(14) { width: 10%; } /* OBSERVAÇÃO */


        /* ATUALIZADO: Estilos para a tabela de EXPORTAÇÃO DE PDF (sem coluna de Ações) */
        .pdf-export-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }
        .pdf-export-table th,
        .pdf-export-table td {
            border: 1px solid #ccc;
            padding: 4px 6px;
            text-align: left;
            font-size: 8px;
            vertical-align: top;
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: normal; /* Permite que o texto quebre linha */
        }
        .pdf-export-table th {
            background-color: #f0f0f0;
        }
        /* Larguras para a tabela de EXPORTAÇÃO DE PDF NFe (13 colunas) */
        .pdf-export-table th:nth-child(1), .pdf-export-table td:nth-child(1) { width: 7%; } /* Nº DA NOTA */
        .pdf-export-table th:nth-child(2), .pdf-export-table td:nth-child(2) { width: 8%; } /* DATA DE EMISSÃO */
        .pdf-export-table th:nth-child(3), .pdf-export-table td:nth-child(3) { width: 6%; } /* SITUAÇÃO */
        .pdf-export-table th:nth-child(4), .pdf-export-table td:nth-child(4) { width: 8%; } /* VALOR DA NOTA */
        .pdf-export-table th:nth-child(5), .pdf-export-table td:nth-child(5) { width: 7%; } /* VALOR DO FRETE */
        .pdf-export-table th:nth-child(6), .pdf-export-table td:nth-child(6) { width: 10%; } /* NOME DO CLIENTE */
        .pdf-export-table th:nth-child(7), .pdf-export-table td:nth-child(7) { width: 9%; } /* CNPJ/CPF CLIENTE */
        .pdf-export-table th:nth-child(8), .pdf-export-table td:nth-child(8) { width: 9%; } /* NOME DO VENDEDOR */
        .pdf-export-table th:nth-child(9), .pdf-export-table td:nth-child(9) { width: 7%; } /* Nº PEDIDO LOJA */
        .pdf-export-table th:nth-child(10), .pdf-export-table td:nth-child(10) { width: 9%; } /* TRANSPORTADORA */
        .pdf-export-table th:nth-child(11), .pdf-export-table td:nth-child(11) { width: 6%; } /* FRETE POR CONTA */
        .pdf-export-table th:nth-child(12), .pdf-export-table td:nth-child(12) { width: 7%; } /* ORIGEM LOJA */
        .pdf-export-table th:nth-child(13), .pdf-export-table td:nth-child(13) { width: 7%; } /* OBSERVAÇÃO */


        /* Estilos para o cabeçalho e rodapé flutuantes do modal de impressão */
        #print-table-modal .modal-header {
            position: sticky;
            top: 0;
            background-color: white; /* Garante que o fundo seja opaco */
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb; /* gray-200 */
            z-index: 10; /* Acima do conteúdo da tabela */
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #print-table-modal .modal-header .header-buttons {
            display: flex;
            gap: 1rem;
        }

        /* Ajusta o padding do conteúdo do modal para não ser coberto pelos elementos sticky */
        #print-table-modal #print-modal-content {
            padding-top: 1rem; /* Espaço para o cabeçalho sticky */
            padding-bottom: 1rem; /* Espaço para o rodapé sticky */
        }

        /* NOVO: Estilos para cabeçalhos de tabela fixos (sticky) */
        /* Aplica a todas as thead th dentro de um container com overflow */
        #page-gerenciar-estoque thead th,
        #orders-table-content thead th,
        #page-report-content thead th,
        #nfe-modal-table-content thead th, /* ATUALIZADO: para o novo modal da NFe */
        #nfe-diagnostic-table-content thead th, /* NOVO: para a tabela de diagnóstico */
        #modal-order-content thead th,
        .print-preview-table thead th,
        .pdf-export-table thead th {
            position: sticky;
            top: 0;
            background-color: #f9fafb; /* Cor de fundo para evitar que o conteúdo role por baixo */
            z-index: 1; /* Garante que o cabeçalho fique acima do conteúdo da tabela */
        }

        /* NOVO: Estilos para o cabeçalho do modal de pedidos de terceiros */
        #terceiros-orders-modal .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        #terceiros-orders-modal .modal-header .left-content {
            display: flex;
            align-items: center;
            gap: 1rem; /* Espaçamento entre título e botão de imprimir */
        }

        /* NOVO: Estilos para o cabeçalho do modal de detalhes da NFE */
        #nfe-details-modal .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        #nfe-details-modal .modal-header .left-content {
            display: flex;
            align-items: center;
            gap: 1rem; /* Espaçamento entre título e botão de imprimir */
        }

        /* NOVO: Ajuste de z-index para o modal de confirmação */
        #confirmation-modal {
            z-index: 70; /* Maior que o nfe-details-modal (z-index: 50) e print-table-modal (z-index: 60) */
        }
        /* NOVO: Ajuste de z-index para o modal de mensagem genérico */
        #message-modal {
            z-index: 75; /* Maior que todos os outros modais */
        }

        /* Estilos para a tabela de impressão de solicitação da fábrica */
        .fabrica-solicitacao-print-table {
            width: 100%;
            border-collapse: collapse;
        }
        .fabrica-solicitacao-print-table th,
        .fabrica-solicitacao-print-table td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
            font-size: 10px;
            vertical-align: top;
        }
        .fabrica-solicitacao-print-table th {
            background-color: #f0f0f0;
        }
        .fabrica-solicitacao-print-table .product-image {
            width: 50px;
            height: 50px;
            object-fit: contain;
            display: block;
            margin: 0 auto;
        }

        /* NOVO: Estilos para o modal de pré-visualização de impressão do navegador */
        #browser-print-fabrica-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: white; /* Fundo branco para impressão */
            z-index: 9999; /* Garante que fique acima de tudo */
            display: none; /* Escondido por padrão, será mostrado via JS */
            padding: 20px; /* Padding para o conteúdo */
            overflow-y: auto; /* Permite rolagem se o conteúdo for grande */
        }

      

        /* NOVO: Estilo para os cards do dashboard serem clicáveis */
        #dashboard-summary-cards [data-id], #nfe-overview-cards [data-id] {
            cursor: pointer;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        #dashboard-summary-cards [data-id]:hover, #nfe-overview-cards [data-id]:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        /* NOVO: Estilo para o card ativo na tela de NFe */
        #nfe-overview-cards [data-id].active {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }


        /* NOVO: Estilos para a miniatura da imagem do produto e a pré-visualização */
        .product-list-item-img {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 4px;
            margin-right: 12px;
            flex-shrink: 0; /* Impede que a imagem encolha */
            transition: transform 0.2s ease-in-out;
        }
        .product-list-item-img:hover {
            transform: scale(1.1); /* Efeito de zoom sutil ao passar o mouse */
        }
        /* ATUALIZADO: Aumentado o tamanho do zoom da imagem */
        #custom-product-tooltip img {
            max-width: 350px;
            max-height: 350px;
            border-radius: 8px;
        }

        /* NOVO: Estilo para células de vendas clicáveis */
        .clickable-sales-cell {
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }
        .clickable-sales-cell:hover {
            background-color: #e0e0e0; /* Um cinza claro para indicar hover */
        }

        @media print {
            @page {
                size: A4; /* Define o tamanho do papel, mas permite que o usuário escolha a orientação */
                margin: 0.5in;
            }

            html, body {
                height: auto !important;
                overflow: visible !important;
            }

            body > *:not(#browser-print-fabrica-modal):not(#print-area) {
                display: none !important;
            }

            /* --- Estilos para o modal de impressão da FÁBRICA --- */
            #browser-print-fabrica-modal {
                display: block !important; position: static !important; width: auto; height: auto;
                padding: 0; overflow: visible !important; background: none !important; box-shadow: none !important;
            }
            #browser-print-fabrica-modal .print-controls { display: none !important; }

            /* NOVO: Estilos para a área de impressão direta do relatório */
            #print-area {
                display: block !important;
            }
            #print-area .report-print-table,
            #print-area .orders-print-table {
                width: 100% !important;
                border-collapse: collapse !important;
                font-size: 8pt !important;
                table-layout: auto !important;
            }
            /* NOVO: Definindo larguras fixas para as colunas na impressão do relatório */
            #print-area .report-print-table th:nth-child(1), #print-area .report-print-table td:nth-child(1) { width: 45%; } /* Produto */
            #print-area .report-print-table th:nth-child(2), #print-area .report-print-table td:nth-child(2) { width: 10%; } /* Est. */
            #print-area .report-print-table th:nth-child(3), #print-area .report-print-table td:nth-child(3) { width: 15%; } /* Aguardando */
            #print-area .report-print-table th:nth-child(4), #print-area .report-print-table td:nth-child(4) { width: 10%; } /* Mín/Máx */
            #print-area .report-print-table th:nth-child(5), #print-area .report-print-table td:nth-child(5) { width: 10%; } /* Vendas 90d */
            #print-area .report-print-table th:nth-child(6), #print-area .report-print-table td:nth-child(6) { width: 10%; } /* Qtd. Req. */
            /* NOVO: Larguras para a tabela de impressão de Pedidos */
            #print-area .orders-print-table th:nth-child(1), #print-area .orders-print-table td:nth-child(1) { width: 8%; } /* REQ. */
            #print-area .orders-print-table th:nth-child(2), #print-area .orders-print-table td:nth-child(2) { width: 43%; } /* PRODUTO */
            #print-area .orders-print-table th:nth-child(3), #print-area .orders-print-table td:nth-child(3) { width: 8%; } /* LOCAL */
            #print-area .orders-print-table th:nth-child(4), #print-area .orders-print-table td:nth-child(4) { width: 5%; }  /* QTD */
            #print-area .orders-print-table th:nth-child(5), #print-area .orders-print-table td:nth-child(5) { width: 8%; }  /* SITUAÇÃO */
            #print-area .orders-print-table th:nth-child(6), #print-area .orders-print-table td:nth-child(6) { width: 8%; }  /* DATA */
            #print-area .orders-print-table th:nth-child(7), #print-area .orders-print-table td:nth-child(7) { width: 8%; }  /* DIAS COR. */
            #print-area .orders-print-table th:nth-child(8), #print-area .orders-print-table td:nth-child(8) { width: 6%; }  /* PRAZO */ /* Total 100% */
            #print-area .orders-print-table th:nth-child(9), #print-area .orders-print-table td:nth-child(9) { width: 6%; }  /* ATRASO */ /* Total 100% */
            
            /* ATUALIZADO: Estilos genéricos aplicados apenas às tabelas de lista */
            #print-area .report-print-table th,
            #print-area .report-print-table td,
            #print-area .orders-print-table th,
            #print-area .orders-print-table td {
                border: 1px solid #ccc !important;
                padding: 4px !important;
                text-align: left !important;
                word-break: break-word;
                vertical-align: middle !important;
            }
            #print-area .report-print-table th,
            #print-area .orders-print-table th {
                background-color: #f2f2f2 !important;
                font-weight: bold;
            }
            #print-area .report-print-table tbody tr:nth-child(even),
            #print-area .orders-print-table tbody tr:nth-child(even) {
                background-color: #f9f9f9 !important;
            }
            #print-area .product-list-item-img {
                display: inline-block !important;
                width: 30px !important;
                height: 30px !important;
                object-fit: cover !important;
                border-radius: 4px !important;
                margin-right: 8px !important;
                vertical-align: middle !important;
            }
            #print-area .text-center-print {
                text-align: center !important;
            }
            
            /* --- Estilos para a impressão de Solicitação --- */
            #print-area .solicitation-page {
                width: 100%;
                margin-bottom: 2rem;
                page-break-after: always;
            }
            #print-area .solicitation-page:last-child {
                page-break-after: avoid;
            }
            #print-area .solicitation-header {
                text-align: center;
                margin-bottom: 1.5rem;
                border-bottom: 2px solid #333;
                padding-bottom: 1rem;
            }
            #print-area .solicitation-header .company-name { font-size: 18pt !important; font-weight: bold !important; }
            #print-area .solicitation-header .report-title { font-size: 14pt !important; color: #555 !important; margin-top: 0.5rem !important; }
            #print-area .solicitation-header .solicitation-info { display: flex !important; justify-content: space-around !important; margin-top: 1rem !important; font-size: 10pt !important; }
            
            #print-area .solicitation-print-table {
                width: 100% !important;
                border-collapse: collapse !important;
                font-size: 10pt !important;
                table-layout: fixed !important; /* Força o navegador a respeitar as larguras definidas */
            }
            #print-area .solicitation-print-table th, 
            #print-area .solicitation-print-table td {
                border: 1px solid #ccc !important; padding: 8px !important; text-align: left !important; vertical-align: middle !important;
                word-wrap: break-word; overflow-wrap: break-word;
            }
            #print-area .solicitation-print-table th { background-color: #f2f2f2 !important; font-weight: bold !important; }
            #print-area .solicitation-print-table .photo-cell { width: 15% !important; text-align: center !important; }
            #print-area .solicitation-print-table .product-cell { width: 65% !important; }
            #print-area .solicitation-print-table .location-cell { width: 12% !important; text-align: center !important; }
            #print-area .solicitation-print-table .quantity-cell { width: 8% !important; text-align: center !important; font-weight: bold !important; font-size: 12pt !important; }
            #print-area .solicitation-product-image { max-width: 80px; max-height: 80px; object-fit: contain; display: block !important; margin: auto !important; }
        }
    </style>

    <!-- NOVO: Estilos para o modo "Somente Leitura" -->
    <style>
        body.read-only .read-only-disable {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
            background-color: #d1d5db !important; /* gray-400 */
        }
    </style>

    <!-- NOVO: Bloqueio de Rota via Script Inline -->
    <script>
        // Este script é executado antes do corpo da página ser renderizado.
        // Se não houver token de autenticação, ele redireciona para a tela de login
        // imediatamente, prevenindo o "flash" da página principal.
        if (!localStorage.getItem('authToken')) {
            window.location.replace('login.html');
        }
    </script>
</head>
<body class="bg-gray-100 font-sans flex flex-col h-screen">

<!-- OVERLAY DE CARREGAMENTO DE TELA CHEIA -->
<div id="loading-overlay" class="fixed hidden inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[80]">
    <div class="flex flex-col items-center">
        <svg class="w-16 h-16 text-white spinning" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
            <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
            </svg>
        <p class="text-white text-lg mt-4">Atualizando dados...</p>
    </div>
</div>


<!-- BARRA DE NAVEGAÇÃO SUPERIOR -->
<header class="bg-white shadow-md z-30">
    <div class="container mx-auto px-4 sm:px-6 py-3 flex items-center justify-between">
        <div class="flex items-center">
            <button id="refresh-button" title="Atualizar dados" class="p-2 rounded-full text-green-600 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors">
                <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                </svg>
            </button>
            <nav class="flex items-center space-x-2 sm:space-x-4 ml-4">
                <button type="button" id="nav-pesquisar" class="nav-link px-3 sm:px-4 py-2 rounded-lg text-sm sm:text-base text-gray-700 hover:bg-gray-100 transition-colors">Pesquisar Produto</button>
                <button type="button" id="nav-estoque" class="nav-link px-3 sm:px-4 py-2 rounded-lg text-sm sm:text-base text-gray-700 hover:bg-gray-100 transition-colors">Gerenciar Entrada</button>
                <button type="button" id="nav-gerenciar-saida" class="nav-link px-3 sm:px-4 py-2 rounded-lg text-sm sm:text-base text-gray-700 hover:bg-gray-100 transition-colors">Gerenciar Saída</button>
                <button type="button" id="nav-dashboards" class="nav-link px-3 sm:px-4 py-2 rounded-lg text-sm sm:text-base text-gray-700 hover:bg-gray-100 transition-colors">Dashboards</button>
            </nav>
        </div>
        <div class="flex items-center">
            <!-- Container para o nome do usuário -->
            <span id="user-name-display" class="hidden text-sm text-gray-700 font-medium mr-4"></span>

            <!-- NOVO: Menu Dropdown de Configurações -->
            <div id="settings-menu-container" class="relative ml-2">
                <button id="settings-button" title="Configurações" class="p-2 rounded-full text-gray-500 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.438.995s.145.755.438.995l1.003.827c.424.35.534.954.26 1.431l-1.296 2.247a1.125 1.125 0 01-1.37.49l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.063-.374-.313-.686-.645-.87a6.52 6.52 0 01-.22-.127c-.324-.196-.72-.257-1.075-.124l-1.217.456a1.125 1.125 0 01-1.37-.49l-1.296-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.437-.995s-.145-.755-.437-.995l-1.004-.827a1.125 1.125 0 01-.26-1.431l1.296-2.247a1.125 1.125 0 011.37-.49l1.217.456c.355.133.75.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                </button>
                <!-- Conteúdo do Dropdown -->
                <div id="settings-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-50 border border-gray-200">
                    <a href="#" id="user-data-link" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Dados de usuário</a>
                    <div class="border-t border-gray-100"></div>
                    <button id="logout-button" class="w-full text-left block px-4 py-2 text-sm text-red-600 hover:bg-gray-100">Sair</button>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- BARRA DE FILTRO GLOBAL -->
<div id="global-filter-bar" class="bg-gray-50 p-4 border-b border-gray-200 shadow-sm z-20 hidden">
    <div class="container mx-auto flex flex-col space-y-4">
        <div class="flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-4">
            <!-- Campos de busca e filtro globais (visibilidade controlada por JS) -->
            <div class="relative w-full">
                <input type="text" id="global-search-input" placeholder="Buscar por código ou descrição..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 pr-10">
                <button id="clear-global-search-btn" class="absolute inset-y-0 right-0 flex items-center pr-3 hidden" title="Limpar busca">
                    <svg class="h-5 w-5 text-gray-400 hover:text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="relative w-full sm:w-48" id="global-filter-menu-container">
                <button id="global-filter-button" class="flex items-center justify-between w-full px-4 py-2 border border-gray-300 rounded-lg bg-white text-left focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <span id="global-filter-button-label">Filtros</span>
                    <svg class="w-5 h-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                </button>
                <div id="global-filter-dropdown" class="absolute hidden w-72 mt-1 bg-white border border-gray-200 rounded-lg shadow-xl z-20">
                    <div id="global-category-checkboxes" class="p-4 space-y-2 text-sm"></div>
                </div>
            </div>
        </div>
        <!-- Contagem de itens selecionados e botão Criar Requisição (visível apenas para Gerenciar Estoque) -->
        <div id="stock-actions" class="flex flex-col sm:flex-row items-center justify-between w-full space-y-2 sm:space-y-0 sm:space-x-4 hidden">
            <div class="flex items-center space-x-2 text-sm text-gray-700 w-full sm:w-auto text-center sm:text-left">
                <span id="selected-items-count">Itens selecionados: 0</span>
                <button id="clear-selection-btn" class="hidden p-1 rounded-full hover:bg-gray-200" title="Limpar seleção">
                    <svg class="w-4 h-4 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="flex items-center space-x-2"> <!-- Agrupador para botões da direita -->
                <button id="view-requisitions-btn" class="px-4 py-2 bg-gray-500 text-white rounded-lg shadow-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors w-full sm:w-auto">
                    Ver Requisições
                </button>
                <button id="generate-report-button" class="read-only-disable px-4 py-2 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors disabled:opacity-50 disabled:cursor-not-allowed w-full sm:w-auto">
                    Criar Requisição
                </button>
            </div>
        </div>
        <!-- Contagem de itens selecionados e botões para Gerenciar Saída -->
        <div id="saida-actions" class="flex flex-col sm:flex-row items-center justify-between w-full space-y-2 sm:space-y-0 sm:space-x-4 hidden">
            <div class="flex items-center space-x-2 text-sm text-gray-700 w-full sm:w-auto text-center sm:text-left">
                <span id="selected-saida-items-count">Itens selecionados: 0</span>
                <button id="clear-saida-selection-btn" class="hidden p-1 rounded-full hover:bg-gray-200" title="Limpar seleção">
                    <svg class="w-4 h-4 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="flex items-center space-x-2">
                <button id="view-saidas-btn" class="px-4 py-2 bg-gray-500 text-white rounded-lg shadow-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors w-full sm:w-auto">
                    Ver Saídas
                </button>
                <button id="create-saida-btn" class="read-only-disable px-4 py-2 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors disabled:opacity-50 disabled:cursor-not-allowed w-full sm:w-auto">
                    Criar Saída
                </button>
            </div>
        </div>
    </div>
</div>

<!-- BARRA DE FILTRO DO DASHBOARD -->
<div id="dashboard-filter-bar" class="bg-gray-50 p-4 border-b border-gray-200 shadow-sm z-20 hidden">
    <div class="container mx-auto flex flex-wrap items-center justify-center gap-x-6 gap-y-4">
        <div>
            <label for="dashboard-start-date" class="block text-sm font-medium text-gray-700">Data Início:</label>
            <input type="date" id="dashboard-start-date" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
        </div>
        <div>
            <label for="dashboard-end-date" class="block text-sm font-medium text-gray-700">Data Fim:</label>
            <input type="date" id="dashboard-end-date" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
        </div>
        <!-- ATUALIZADO: Filtros de data em duas linhas -->
        <div class="flex flex-col gap-2 text-sm self-end">
            <div class="flex items-center justify-start gap-x-4">
                <label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="date-range" value="current_month" class="date-preset-radio"> Mês Atual</label>
                <label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="date-range" value="last_month" class="date-preset-radio"> Último Mês</label>
                <label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="date-range" value="last_3_months" class="date-preset-radio"> Últimos 3 Meses</label>
                <label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="date-range" value="last_6_months" class="date-preset-radio"> Últimos 6 Meses</label>
            </div>
            <div class="flex items-center justify-start gap-x-4">
                <label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="date-range" value="30" class="date-range-radio"> 30 dias</label>
                <label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="date-range" value="60" class="date-range-radio"> 60 dias</label>
                <label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="date-range" value="90" class="date-range-radio"> 90 dias</label>
                <label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="date-range" value="all" class="date-range-radio" checked> Tudo</label>
            </div>
        </div>
        <!-- NOVO BOTÃO LIMPAR -->
        <button id="dashboard-clear-filters-btn" class="self-end px-4 py-2 bg-gray-600 text-white rounded-lg shadow-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors">
            Limpar
        </button>
    </div>
</div>


<!-- BARRA DE AÇÕES DO RELATÓRIO -->
<div id="report-action-bar" class="report-action-bar-style hidden">
    <div class="left-buttons">
        <button id="report-back-btn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg shadow-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors">
            Voltar
        </button>
    </div>
    <div class="right-buttons">
        <button id="report-launch-terceiros-btn" class="read-only-disable px-4 py-2 bg-green-600 text-white rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
            Lançar Requisição - Terceiros
        </button>
        <button id="report-launch-fabrica-btn" class="read-only-disable px-4 py-2 bg-green-600 text-white rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
            Lançar Requisição - Fábrica
        </button>
        <!-- NOVO: Dropdown de Ações -->
        <div class="relative" id="report-actions-menu-container">
            <button id="report-actions-button" class="p-2 bg-gray-600 text-white rounded-full shadow-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z" /></svg>
            </button>
            <div id="report-actions-dropdown" class="absolute hidden right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-20 border border-gray-200">
                <a href="#" id="report-action-print-list" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Imprimir Lista</a>
                <a href="#" id="report-action-print-req" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Imprimir Requisição</a>
                <div class="border-t border-gray-100"></div>
                <a href="#" id="report-action-excel" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Baixar Excel</a>
            </div>
        </div>
    </div>
</div>

<!-- NOVA BARRA DE AÇÕES PARA DIAGNÓSTICO DE REQUISIÇÃO -->
<div id="requisition-action-bar" class="report-action-bar-style hidden">
    <div class="left-buttons">
        <button id="requisition-back-btn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg shadow-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors">
            Voltar
        </button>
    </div>
    <div class="right-buttons">
        <!-- Espaço para botões futuros se necessário -->
    </div>
</div>

<!-- NOVA BARRA DE AÇÕES PARA DIAGNÓSTICO DE SAÍDAS -->
<div id="saida-action-bar" class="report-action-bar-style hidden">
    <div class="left-buttons">
        <button id="saida-back-btn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg shadow-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors">
            Voltar
        </button>
    </div>
    <div class="right-buttons">
        <!-- Espaço para botões futuros se necessário -->
    </div>
</div>

<!-- NOVA BARRA DE AÇÕES PARA RELATÓRIO DE SAÍDA -->
<div id="saida-report-action-bar" class="report-action-bar-style hidden">
    <div class="left-buttons">
        <button id="saida-report-back-btn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg shadow-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors">
            Voltar
        </button>
    </div>
    <div class="right-buttons">
        <button id="launch-saida-garantia-btn" class="read-only-disable px-4 py-2 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
            Lançar Saída - Garantia
        </button>
        <button id="launch-saida-fabrica-btn" class="read-only-disable px-4 py-2 bg-green-600 text-white rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
            Lançar Saída - Fábrica
        </button>
    </div>
</div>

<!-- CONTAINER DAS PÁGINAS -->
<div class="flex-grow overflow-hidden">
    <!-- PÁGINA: PESQUISAR PRODUTO -->
    <main id="page-pesquisar-produto" class="hidden h-full">
        <div class="flex flex-col md:flex-row h-full">
            <div id="product-list-container" class="w-full md:w-1/3 max-w-md border-r border-gray-300 bg-white flex flex-col h-full overflow-y-auto"></div>
            <div id="product-details-container" class="w-full md:w-2/3 p-8 overflow-y-auto">
                <div id="details-placeholder" class="flex items-center justify-center h-full">
                    <div class="text-center text-gray-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                        <h2 class="mt-2 text-xl font-medium">Selecione um produto</h2>
                        <p class="mt-1 text-sm">Os detalhes aparecerão aqui.</p>
                    </div>
                </div>
                <div id="product-details" class="hidden"></div>
            </div>
        </div>
    </main>

    <!-- PÁGINA: GERENCIAR ESTOQUE -->
    <main id="page-gerenciar-estoque" class="hidden p-8 h-full overflow-y-auto"></main>

    <!-- NOVA PÁGINA: VISÃO GERAL DE REQUISIÇÕES -->
    <main id="page-overview-requisitions" class="hidden p-8 h-full overflow-y-auto bg-gray-100 flex flex-col items-center text-center">
        <h1 class="text-4xl font-bold text-gray-800 mb-6">Diagnóstico de Requisição</h1>
        <p class="text-lg text-gray-600 mb-8">Visão geral das suas requisições:</p>
        <div id="requisition-overview-cards" class="grid grid-cols-1 sm:grid-cols-2 gap-6 mb-8 w-full max-w-4xl">
        </div>
        <p id="no-orders-message" class="text-center text-gray-500 py-8 hidden">Nenhum pedido encontrado.</p>
    </main>

    <!-- NOVA PÁGINA: VISÃO GERAL DE SAÍDAS -->
    <main id="page-overview-saidas" class="hidden p-8 h-full overflow-y-auto bg-gray-100 flex flex-col items-center text-center">
        <h1 class="text-4xl font-bold text-gray-800 mb-6">Diagnóstico de Saídas</h1>
        <p class="text-lg text-gray-600 mb-8">Visão geral das suas saídas:</p>
        <div id="saida-overview-cards" class="grid grid-cols-1 sm:grid-cols-2 gap-6 mb-8 w-full max-w-4xl">
        </div>
        <p id="no-saidas-message" class="text-center text-gray-500 py-8 hidden">Nenhuma saída encontrada.</p>
    </main>

    <!-- PÁGINA: GERENCIAR SAÍDA -->
    <main id="page-gerenciar-saida" class="hidden p-8 h-full overflow-y-auto">
        <!-- Conteúdo será renderizado pelo JavaScript -->
    </main>

    <!-- NOVA PÁGINA: DASHBOARDS -->
    <main id="page-dashboards" class="hidden p-8 h-full overflow-y-auto">
        <div class="text-center">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">Dashboard de Vendas</h1>
            <p class="text-lg text-gray-600 mb-6">Evolução de vendas por canal.</p>
        </div>
        <div id="dashboard-content" class="w-full">
            <div id="dashboard-summary-cards" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            </div>
            <!-- ATUALIZADO: Aumentada a altura do container do gráfico -->
            <div class="bg-white p-4 rounded-lg shadow-md h-[500px]">
                <canvas id="sales-chart"></canvas>
            </div>
            <!-- NOVO: Container para a tabela de vendas -->
            <div id="sales-table-container" class="mt-8"></div>
        </div>
    </main>

    <!-- NOVA PÁGINA: RELATÓRIO DE PRODUTOS SELECIONADOS -->
    <main id="page-report" class="hidden p-8 h-full overflow-y-auto bg-gray-100">
        <div id="page-report-content" class="container mx-auto mt-4">
        </div>
    </main>

    <!-- PÁGINA: RELATÓRIO DE SAÍDA -->
    <main id="page-saida-report" class="hidden p-8 h-full overflow-y-auto bg-gray-100">
        <div id="page-saida-report-content" class="container mx-auto mt-4">
        </div>
    </main>
</div>

<!-- NOVO: Área de conteúdo para impressão direta -->
<div id="print-area" class="hidden"></div>

<!-- ... O RESTANTE DO HTML (MODAIS, ETC.) CONTINUA IGUAL ... -->
<div id="terceiros-orders-modal" class="fixed hidden inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white p-6 rounded-lg shadow-xl max-w-5xl w-full max-h-[90vh] overflow-y-auto relative">
        <div class="modal-header flex items-center justify-between">
            <div class="left-content">
                <h2 id="orders-table-title" class="text-3xl font-bold text-gray-800">Lista de Pedidos</h2>
                <!-- NOVO: Dropdown de Ações para a tabela de pedidos -->
                <div class="relative inline-block text-left ml-4" id="orders-table-actions-menu-container">
                    <button id="orders-table-actions-button" class="p-2 bg-gray-600 text-white rounded-full shadow-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z" /></svg>
                    </button>
                    <div id="orders-table-actions-dropdown" class="origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-20 hidden">
                        <div class="py-1" role="menu" aria-orientation="vertical" aria-labelledby="orders-table-actions-button">
                            <!-- Opções de Impressão -->
                            <a href="#" id="orders-table-action-print-generic" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem">Imprimir</a>
                            <a href="#" id="orders-table-action-print-list" class="hidden block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem">Imprimir Lista</a>
                            <a href="#" id="orders-table-action-print-solicitation" class="hidden block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem">Imprimir Solicitação</a>
                            <div class="border-t border-gray-100 my-1"></div>
                            <a href="#" id="orders-table-action-excel" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem">Baixar Excel</a>
                        </div>
                    </div>
                </div>
            </div>
            <button id="close-terceiros-orders-modal-btn" class="text-gray-500 hover:text-gray-800">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        
        <!-- Conteúdo da tabela de pedidos movido para cá -->
        <div id="consolidated-orders-table-container-modal" class="w-full space-y-4 text-left flex-grow flex flex-col">
            
            <div class="flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-4">
                <div class="relative w-full">
                    <input type="text" id="orders-search-input" placeholder="Buscar por Código, Descrição ou Requisição..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 pr-10">
                    <button id="clear-orders-search-btn" class="absolute inset-y-0 right-0 flex items-center pr-3 hidden" title="Limpar busca">
                        <svg class="h-5 w-5 text-gray-400 hover:text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>

                <div class="relative w-full sm:w-48" id="orders-filter-menu-container">
                    <button id="orders-filter-button" class="flex items-center justify-between w-full px-4 py-2 border border-gray-300 rounded-lg bg-white text-left focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <span id="orders-filter-button-label">Filtros de Status</span>
                        <svg class="w-5 h-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    </button>
                    <div id="orders-filter-dropdown" class="absolute hidden w-72 mt-1 bg-white border border-gray-200 rounded-lg shadow-xl z-20 right-0">
                        <div id="orders-status-checkboxes" class="p-4 space-y-2 text-sm">
                            <label class="flex items-center space-x-3 p-2 rounded-md hover:bg-gray-100 cursor-pointer">
                                <input type="checkbox" class="order-status-checkbox h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" value="dentro_prazo">
                                <span class="flex-grow text-gray-700">Pedidos Dentro do Prazo</span>
                            </label>
                            <label class="flex items-center space-x-3 p-2 rounded-md hover:bg-gray-100 cursor-pointer">
                                <input type="checkbox" class="order-status-checkbox h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" value="fora_prazo">
                                <span class="flex-grow text-gray-700">Pedidos Fora do Prazo</span>
                            </label>
                            <label class="flex items-center space-x-3 p-2 rounded-md hover:bg-gray-100 cursor-pointer">
                                <input type="checkbox" class="order-status-checkbox h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" value="entregues">
                                <span class="flex-grow text-gray-700">Pedidos Entregues</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <div id="orders-table-content" class="bg-white rounded-lg shadow-md overflow-y-auto overflow-x-auto max-h-[60vh] mt-4 flex-grow">
                <!-- Conteúdo da tabela será inserido aqui pelo JS -->
            </div>
            <p id="no-orders-message-modal" class="text-center text-gray-500 py-8 hidden">Nenhum pedido encontrado.</p>
        </div>
    </div>
</div>
<div id="order-details-modal" class="fixed hidden inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white p-6 rounded-lg shadow-xl max-w-3xl w-full max-h-[90vh] overflow-y-auto relative">
        <button id="close-order-modal-btn" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
        <h2 id="modal-order-title" class="text-2xl font-bold text-gray-800 mb-4">Detalhes do Pedido</h2>
        <div id="modal-order-content">
            <p class="text-center text-gray-500">Carregando detalhes do pedido...</p>
        </div>
    </div>
</div>
<div id="message-modal" class="fixed hidden inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[75]">
    <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center relative">
        <button id="close-message-modal-btn" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
        <h3 id="message-modal-title" class="text-xl font-bold mb-4"></h3>
        <p id="message-modal-content" class="text-gray-700 mb-6"></p>
        <button id="message-modal-ok-btn" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
            Ok
        </button>
    </div>
</div>
<div id="print-table-modal" class="fixed hidden inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] p-4">
    <div class="bg-white p-6 rounded-lg shadow-xl max-w-5xl w-full max-h-[90vh] overflow-y-auto relative">
        <div class="modal-header">
            <h2 id="print-modal-title" class="text-2xl font-bold text-gray-800">Pré-visualização para Impressão</h2>
            <div class="header-buttons">
                <button id="cancel-print-btn" class="px-6 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500">
                    Cancelar
                </button>
                <button id="confirm-print-btn" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Imprimir
                </button>
            </div>
        </div>
        <div id="print-modal-content" class="overflow-x-auto">
        </div>
    </div>
</div>
<div id="confirmation-modal" class="fixed hidden inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[70]">
    <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center relative">
        <h3 id="confirmation-modal-title" class="text-xl font-bold mb-4"></h3>
        <p id="confirmation-modal-content" class="text-gray-700 mb-6"></p>
        <div class="flex justify-end space-x-4">
            <button id="confirm-no-btn" class="px-6 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500">
                Não
            </button>
            <button id="confirm-yes-btn" class="read-only-disable px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                Sim
            </button>
        </div>
    </div>
</div>
<!-- NOVO: Modal para inserir código de requisição de Terceiros -->
<div id="terceiros-requisition-modal" class="fixed hidden inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white p-6 rounded-lg shadow-xl max-w-md w-full text-center relative">
        <button id="close-terceiros-req-modal-btn" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
        <h3 class="text-2xl font-bold mb-4 text-gray-800">Lançar Requisição - Terceiros</h3>
        <p id="terceiros-req-modal-message" class="text-gray-700 mb-6"></p>
        <div class="mb-6">
            <label for="terceiros-requisition-code-input" class="block text-left text-gray-700 text-sm font-bold mb-2">
                Código da Requisição do Phoenix:
            </label>
            <input type="text" id="terceiros-requisition-code-input" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-blue-500" placeholder="Ex: REQ12345">
        </div>
        <div class="flex justify-end space-x-4">
            <button id="cancel-terceiros-req-btn" class="px-6 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500">
                Cancelar
            </button>
            <button id="confirm-terceiros-req-btn" class="read-only-disable px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500">
                Continuar
            </button>
        </div>
    </div>
</div>
<div id="nfe-details-modal" class="fixed hidden inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white p-6 rounded-lg shadow-xl max-w-5xl w-full max-h-[90vh] overflow-y-auto relative">
        <div class="modal-header flex items-center justify-between">
            <div class="left-content">
                <h2 id="nfe-modal-title" class="text-3xl font-bold text-gray-800">Notas Fiscais</h2>
                <button id="print-nfe-modal-table-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                    Imprimir Tabela
                </button>
            </div>
            <button id="close-nfe-modal-btn" class="text-gray-500 hover:text-gray-800">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        
        <div class="w-full space-y-4 text-left flex-grow flex flex-col">
            <div class="flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-4">
                <input type="text" id="nfe-modal-search-input" placeholder="Buscar por Número, Fornecedor, Status..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>

            <div id="nfe-modal-table-content" class="bg-white rounded-lg shadow-md overflow-y-auto overflow-x-auto max-h-[60vh] mt-4 flex-grow">
            </div>
            <p id="no-nfe-message-modal" class="text-center text-gray-500 py-8 hidden">Nenhuma nota fiscal encontrada.</p>
        </div>
    </div>
</div>
<div id="browser-print-fabrica-modal" class="hidden">
    <div class="print-controls">
        <button id="close-browser-print-fabrica-modal-btn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg shadow-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors">
            Fechar Pré-visualização
        </button>
    </div>
    <div id="browser-print-fabrica-content">
    </div>
</div>

<!-- NOVO: Modal para detalhes de vendas -->
<div id="sales-details-modal" class="fixed hidden inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white p-6 rounded-lg shadow-xl max-w-5xl w-full max-h-[90vh] flex flex-col">
        <!-- Cabeçalho do Modal -->
        <div class="flex justify-between items-start pb-4 border-b mb-4">
            <h2 id="sales-details-modal-title" class="text-2xl font-bold text-gray-800 pr-8">Detalhes de Vendas</h2>
            <div class="flex items-center gap-4 flex-shrink-0">
                <button id="export-sales-details-csv-btn" class="px-4 py-2 bg-green-600 text-white rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors">
                    Exportar CSV
                </button>
                <button id="close-sales-details-modal-btn" class="text-gray-500 hover:text-gray-800">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
        </div>
        <!-- Conteúdo do Modal -->
        <div id="sales-details-modal-content" class="overflow-auto flex-grow">
            <!-- Conteúdo da tabela de vendas será inserido aqui pelo JS -->
        </div>
        <p id="no-sales-details-message" class="text-center text-gray-500 py-8 hidden">Nenhum detalhe de venda encontrado para este período.</p>
    </div>
</div>

<!-- NOVO: Modal para editar observação da NFe -->
<div id="nfe-observation-modal" class="fixed hidden inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] p-4">
    <div class="bg-white rounded-lg shadow-xl max-w-lg w-full flex flex-col max-h-[90vh]">
        <!-- Header -->
        <div class="p-4 border-b">
            <h3 class="text-xl font-bold text-gray-800">Histórico de Observações</h3>
            <p id="nfe-observation-modal-info" class="text-sm text-gray-600 mt-1"></p>
        </div>
        <!-- Chat History -->
        <div id="nfe-observation-history" class="flex-grow p-4 space-y-4 overflow-y-auto bg-gray-50">
            <!-- Chat messages will be injected here by JS -->
        </div>
        <!-- Input Area -->
        <div class="p-4 border-t bg-white">
            <textarea id="nfe-observation-textarea" maxlength="1000" class="w-full h-20 p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Adicionar nova observação..."></textarea>
            <div class="text-right text-sm text-gray-500 mt-1 transition-colors">
                <span id="nfe-observation-char-count">0</span> / 1000
            </div>
            <div class="flex justify-end space-x-4 mt-1">
                <button id="cancel-nfe-observation-btn" class="px-6 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500">Fechar</button>
                <button id="save-nfe-observation-btn" class="read-only-disable px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">Salvar</button>
            </div>
        </div>
    </div>
</div>

<!-- NOVO: Modal para observação da Requisição -->
<div id="requisition-observation-modal" class="fixed hidden inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] p-4">
    <div class="bg-white rounded-lg shadow-xl max-w-lg w-full flex flex-col max-h-[90vh]">
        <!-- Header -->
        <div class="p-4 border-b">
            <h3 class="text-xl font-bold text-gray-800">Histórico de Observações do Item</h3>
            <p id="requisition-observation-modal-info" class="text-sm text-gray-600 mt-1"></p>
        </div>
        <!-- Chat History -->
        <div id="requisition-observation-history" class="flex-grow p-4 space-y-4 overflow-y-auto bg-gray-50">
            <!-- Chat messages will be injected here by JS -->
        </div>
        <!-- Input Area -->
        <div class="p-4 border-t bg-white">
            <textarea id="requisition-observation-textarea" maxlength="1000" class="w-full h-20 p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Adicionar nova observação..."></textarea>
            <div class="text-right text-sm text-gray-500 mt-1 transition-colors">
                <span id="requisition-observation-char-count">0</span> / 1000
            </div>
            <div class="flex justify-end space-x-4 mt-1">
                <button id="cancel-requisition-observation-btn" class="px-6 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500">Fechar</button>
                <button id="save-requisition-observation-btn" class="read-only-disable px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">Salvar</button>
            </div>
        </div>
    </div>
</div>

<!-- NOVO: Modal para Ajuste de Estoque -->
<div id="stock-adjustment-modal" class="fixed hidden inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[65] p-4">
    <div class="bg-white p-6 rounded-lg shadow-xl max-w-md w-full relative">
        <button id="close-stock-adjustment-modal-btn" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
        <h3 class="text-2xl font-bold mb-4 text-gray-800">Ajuste de Estoque (Balanço)</h3>
        <p id="stock-adjustment-product-info" class="text-gray-700 mb-2 text-left"></p>
        <p id="stock-adjustment-current-stock" class="text-gray-700 mb-6 text-left"></p>
        <div class="space-y-4 text-left">
            <div>
                <label for="stock-adjustment-new-quantity" class="block text-sm font-bold text-gray-700">Nova Quantidade em Estoque:</label>
                <input type="number" id="stock-adjustment-new-quantity" class="mt-1 shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-blue-500" placeholder="0">
            </div>
        </div>
        <div class="flex justify-end space-x-4 mt-8">
            <button id="cancel-stock-adjustment-btn" class="px-6 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400">Cancelar</button>
            <button id="confirm-stock-adjustment-btn" class="read-only-disable px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Confirmar Ajuste</button>
        </div>
    </div>
</div>

<!-- ATUALIZADO: Modal de Dados do Usuário com Abas -->
<div id="user-data-modal" class="fixed hidden inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white p-6 rounded-lg shadow-xl max-w-lg w-full max-h-[90vh] overflow-y-auto relative">
        <div class="flex items-center justify-between pb-4 border-b">
            <h2 class="text-2xl font-bold text-gray-800">Dados do Usuário</h2>
            <button id="close-user-data-modal-btn" class="text-gray-500 hover:text-gray-800">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>

        <!-- Abas de Navegação do Modal -->
        <div class="border-b border-gray-200 mt-4">
            <nav id="user-modal-tabs" class="-mb-px flex space-x-6" aria-label="Tabs">
                <button id="tab-my-data" class="user-modal-tab whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">Meus Dados</button>
                <button id="tab-manage-users" class="user-modal-tab whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm hidden">Gerenciar Usuários</button>
            </nav>
        </div>

        <!-- NOVO: Container para Alertas do Modal -->
        <div id="user-modal-alert-container" class="mt-4"></div>

        <!-- Conteúdo das Abas -->
        <div class="mt-6">
            <!-- Aba: Meus Dados -->
            <div id="tab-content-my-data" class="user-modal-tab-content space-y-4">
                <div id="my-data-display"></div>
                <hr>
                <h3 class="text-lg font-semibold text-gray-700 pt-2">Alterar Dados</h3>
                <div class="space-y-4">
                    <div>
                        <label for="update-user-telefone" class="block text-sm font-medium text-gray-700">Novo Telefone</label>
                        <input type="text" id="update-user-telefone" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="(XX) XXXXX-XXXX">
                    </div>
                    <div>
                        <label for="update-user-senha" class="block text-sm font-medium text-gray-700">Nova Senha</label>
                        <input type="password" id="update-user-senha" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Deixe em branco para não alterar">
                    </div>
                    <div>
                        <label for="update-user-current-password" class="block text-sm font-medium text-gray-700">Sua Senha Atual (para confirmar)</label>
                        <input type="password" id="update-user-current-password" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Senha atual obrigatória">
                    </div>
                    <div class="text-right">
                        <button id="save-my-data-btn" class="read-only-disable inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            Salvar Alterações
                        </button>
                    </div>
                </div>
            </div>

            <!-- Aba: Gerenciar Usuários (Admin) -->
            <div id="tab-content-manage-users" class="user-modal-tab-content hidden space-y-4">
                <div>
                    <label for="manage-users-select" class="block text-sm font-medium text-gray-700">Selecione um usuário para editar</label>
                    <select id="manage-users-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                        <option>Carregando usuários...</option>
                    </select>
                </div>
                <div id="admin-edit-form-container" class="hidden space-y-4 pt-4 border-t">
                    <!-- O formulário de edição do admin será injetado aqui -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ATUALIZAÇÃO: O script pesquisarProduto.js foi movido para um bloco inline abaixo para incorporar as novas funcionalidades de imagem. -->
<script>
const PesquisarProduto = (function() {
    // --- Variáveis de estado e configuração ---
    let _allProducts = [];
    let _dom = {};
    let _utils = {};
    let _activeProductId = null;

    /**
     * Renderiza os detalhes de um produto específico no painel direito.
     * @param {object} product - O objeto do produto a ser exibido.
     */
    function _renderProductDetails(product) {
        if (!_dom.product_details || !_utils.createDetailItem) return;

        _dom.product_details.innerHTML = `
            <h2 class="text-2xl font-bold text-gray-800 mb-2">${product.descricao}</h2>
            <p class="text-sm text-gray-500 mb-6">Código: ${product.codigo}</p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4">
                ${_utils.createDetailItem('Preço', (product.preco || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }))}
                ${_utils.createDetailItem('Unidade', product.unidade || 'N/A')}
                <div class="bg-gray-50 p-3 rounded-lg flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-500">Estoque Atual</p>
                        <p class="text-lg text-gray-800 font-bold">${product.estoque || 0}</p>
                    </div>
                    <button class="read-only-disable open-stock-adjustment-modal-btn p-2 rounded-full hover:bg-gray-200" data-product-id="${product.id}" title="Ajustar Estoque">
                        <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L16.732 3.732z"></path></svg>
                    </button>
                </div>
                ${_utils.createDetailItem('Estoque Mínimo', product.estoque_minimo)}
                ${_utils.createDetailItem('Estoque Máximo', product.estoque_maximo)}
                ${_utils.createDetailItem('Localização', product.localizacao || 'N/A')}
                ${_utils.createDetailItem('Grupo de Tags', product.grupo_de_tags_tags?.join(', ') || 'N/A')}
                ${_utils.createDetailItem('Vendas (90d)', product.vendas_ultimos_90_dias || '0')}
            </div>
            
            <div class="mt-8">
                <h3 class="text-lg font-semibold text-gray-700 mb-4">Imagens do Produto</h3>
                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                    ${(product.url_imagens_externas && product.url_imagens_externas.length > 0) ? 
                        product.url_imagens_externas.map(url => `
                            <a href="${url}" target="_blank" rel="noopener noreferrer">
                                <img src="${url}" alt="Imagem do produto" class="w-full h-32 object-cover rounded-lg shadow-md hover:shadow-xl transition-shadow duration-300" 
                                     onerror="this.onerror=null;this.src='https://placehold.co/150x150/e2e8f0/64748b?text=?';">
                            </a>
                        `).join('') :
                        '<p class="text-gray-500 col-span-full">Nenhuma imagem disponível.</p>'
                    }
                </div>
            </div>
        `;
        _dom.details_placeholder.classList.add('hidden');
        _dom.product_details.classList.remove('hidden');
    }

    // NOVO: Função para renderizar detalhes, exposta para ser chamada externamente
    function renderDetails(product) {
        _renderProductDetails(product);
    }

    /**
     * Limpa o painel de detalhes e mostra o placeholder.
     */
    function _clearDetails() {
        if (!_dom.product_details || !_dom.details_placeholder) return;
        _dom.product_details.classList.add('hidden');
        _dom.details_placeholder.classList.remove('hidden');
    }
    
    /**
     * Manipula o clique em um item da lista de produtos.
     * @param {MouseEvent} event - O evento de clique.
     */
    function _handleProductClick(event) {
        const productItem = event.target.closest('.product-item');
        if (!productItem) return;

        const productId = productItem.dataset.productId;
        _activeProductId = productId;

        // Remove a classe 'active' de todos os itens e a adiciona ao item clicado
        document.querySelectorAll('.product-item').forEach(item => item.classList.remove('active'));
        productItem.classList.add('active');

        const product = _allProducts.find(p => String(p.id) === String(productId));
        if (product) {
            _renderProductDetails(product);
        }
    }

    // --- Funções Públicas ---
    
    /**
     * Renderiza a lista de produtos no painel esquerdo.
     * @param {Array<object>} products - A lista de produtos a ser renderizada.
     */
    function render(products) {
        if (!_dom.product_list_container) return;
        if (!products || products.length === 0) {
            _dom.product_list_container.innerHTML = `<div class="p-4 text-center text-gray-500">Nenhum produto encontrado.</div>`;
            _clearDetails();
            return;
        }

        let listHtml = products.map(product => {
            const imageUrl = product.url_imagens_externas && product.url_imagens_externas[0] 
                ? product.url_imagens_externas[0] 
                : 'https://placehold.co/50x50/e2e8f0/64748b?text=?';
            const isActive = String(product.id) === String(_activeProductId) ? 'active' : '';

            return `
                <div class="product-item flex items-center p-3 border-b border-gray-200 cursor-pointer hover:bg-gray-50 ${isActive}" data-product-id="${product.id}">
                    <img src="${imageUrl}" 
                         alt="${product.descricao || 'Imagem do produto'}" 
                         class="product-list-item-img" 
                         data-image-url="${imageUrl}"
                         data-product-id="${product.id}"
                         onerror="this.onerror=null;this.src='https://placehold.co/50x50/e2e8f0/64748b?text=?';">
                    <div class="flex-grow overflow-hidden">
                        <h3 class="font-semibold text-gray-800 text-sm truncate" title="${product.descricao || ''}">${product.descricao || 'Sem descrição'}</h3>
                        <p class="text-xs text-gray-500">${product.codigo || 'Sem código'}</p>
                    </div>
                </div>
            `;
        }).join('');
        _dom.product_list_container.innerHTML = listHtml;
    }

    /**
     * Inicializa o módulo, cacheando elementos do DOM e configurando listeners.
     * @param {object} config - Objeto de configuração.
     */
    function init(config) {
        _allProducts = config.allProducts;
        _dom = config.domElements;
        _utils = config.utilities;
        // NOVO: Recebe a função para abrir o modal do App principal
        _openStockAdjustmentModal = config.openStockAdjustmentModal;

        if (_dom.product_list_container) {
            // Listener para cliques nos itens da lista
            _dom.product_list_container.addEventListener('click', _handleProductClick);
            
            // Listener para pré-visualização de imagem (usando delegação de eventos)
            _dom.product_list_container.addEventListener('mouseover', (event) => {
                if (event.target.classList.contains('product-list-item-img')) {
                    _utils.showProductTooltip(event);
                }
            });
            _dom.product_list_container.addEventListener('mouseout', (event) => {
                if (event.target.classList.contains('product-list-item-img')) {
                    _utils.hideProductTooltip();
                }
            });
        }

        // NOVO: Listener delegado para o botão de ajuste de estoque dentro dos detalhes do produto
        if (_dom.product_details_container) {
            _dom.product_details_container.addEventListener('click', (event) => {
                const adjustmentBtn = event.target.closest('.open-stock-adjustment-modal-btn');
                if (adjustmentBtn && typeof _openStockAdjustmentModal === 'function') {
                    _openStockAdjustmentModal(adjustmentBtn.dataset.productId);
                }
            });
        }
    }

    // Expõe as funções públicas
    return {
        init,
        render,
        renderDetails // NOVO
    };
})();
</script>

<!-- NOVO: Script de autenticação -->
<script src="js/auth.js"></script>

<script type="module">
    // Importa as funções utilitárias do novo módulo
    import { debounce, addBusinessDays, getBusinessDaysDifference, formatCnpjCpf, createDetailItem, createStatusPill } from 'https://cdn.jsdelivr.net/gh/alankenji666/Project_service@main/utils.js';

    // URLs das suas APIs do Google Apps Script
    // ATENÇÃO: Substitua estas URLs pelas URLs de IMPLANTAÇÃO dos seus respectivos scripts
    const PRODUCTS_API_URL = "https://script.google.com/macros/s/AKfycbwLWLCM0SuAnELFllVp0uPPzOaMozMx5yN-XKmf6QLSvpYgfxOtEVtLSLOqLOWE5umY/exec";
    const ORDERS_API_URL_TERCEIROS = "https://script.google.com/macros/s/AKfycbwYWSPrgMdA5IGVYnH5EVJ3FLnU1THcI6SQa8opOHkjN_CZO-G2S7JJDuTqZQDd0Y2s/exec";
    const ORDERS_API_URL_FABRICA = "https://script.google.com/macros/s/AKfycbwKsLHoAhfLxEcq6nyu9lCHybh3EOGqEku-shgdoomSg8SAyL9VcUsWWjzVPmvcSkvOTA/exec"; // URL para requisições de fábrica
    
    // NOVO: URL para a API de consulta de Saídas para Fábrica
    const SAIDAS_API_URL_FABRICA = "https://script.google.com/macros/s/AKfycbxEJwbvF9f0NBQ_ueTsXSSXxeOrr7AiGl58v6UKgJQ1NGI9ZOwrpS8vXYkwgRWe285n/exec";
    
    // NOVO: URL para a API de consulta de Saídas para Garantia
    const SAIDAS_API_URL_GARANTIA = "https://script.google.com/macros/s/AKfycbz5szPRjcuugJ3JZjGozdXMhcUiYzmKnAMqoqvOywWCpm7935YH6p-Fay-M0CZPni89sQ/exec";

    // NOVO: URL para a API de lançamento de Saída para Fábrica
    const SAIDA_FABRICA_LAUNCH_URL = "https://bling-proxy-api-255108547424.southamerica-east1.run.app/saida-fabrica";

    // NOVO: URL para a API de lançamento de Saída para Garantia
    const SAIDA_GARANTIA_LAUNCH_URL = "https://bling-proxy-api-255108547424.southamerica-east1.run.app/saida-garantia";

    // ATUALIZADO: URL do webhook agora aponta para a sua Cloud Function
     const WEBHOOK_LAUNCH_URL = "https://bling-proxy-api-255108547424.southamerica-east1.run.app"; 

    // ATUALIZADO: URL para a API que atualiza o status do pedido e o estoque no Bling.
    // Esta é a nova Cloud Function que centraliza as duas operações.
    const ORDERS_UPDATE_API_URL = "https://bling-proxy-api-255108547424.southamerica-east1.run.app/estoque/update-stock"; 

    // NOVO: URL para a API de Conferência NFe (leitura)
   const NFE_API_URL = "https://script.google.com/macros/s/AKfycbwetL7dn2Zmsr6ZPlE6x6B2JTahGOyhfENK6AoL-2HwEvffyTejBuHvIp7S_kgHI3_t/exec"; 
    
    // NOVO: URL para a API de atualização de status de conferência da NFe (Cloud Function)
       const NFE_CONFERENCIA_API_URL = "https://bling-proxy-api-255108547424.southamerica-east1.run.app/nfe/conferencia";

    // NOVO: URL para a API de atualização de observação da NFe (Cloud Function)
    const NFE_OBSERVATION_API_URL = "https://bling-proxy-api-255108547424.southamerica-east1.run.app/nfe/conferencia/observacao";

    // ATUALIZADO: URL para a API de atualização de observação de Requisição de Terceiros
    const TERCEIROS_OBSERVATION_API_URL = "https://bling-proxy-api-255108547424.southamerica-east1.run.app/add-requisition-observation";

    // NOVO: URL para a API de atualização de observação de Requisição de Fábrica
    const FABRICA_OBSERVATION_API_URL = "https://bling-proxy-api-255108547424.southamerica-east1.run.app/add-fabrica-observation";

    // NOVO: URLs para a API de atualização de observação de Saídas.
    const SAIDA_FABRICA_OBSERVATION_API_URL = "https://bling-proxy-api-255108547424.southamerica-east1.run.app/add-fabrica-observation"; // Reutiliza a mesma API de fábrica
    const SAIDA_GARANTIA_OBSERVATION_API_URL = "https://bling-proxy-api-255108547424.southamerica-east1.run.app/add-garantia-observation"; // API específica para garantia


    // Início do padrão Revealing Module para a aplicação principal
    const App = (function() {
        // --- VARIÁVEIS DE ESTADO PRIVADAS ---
        let _allProducts = [];
        let _allOrdersTerceiros = []; 
        let _allOrdersFabrica = []; 
        let _allSaidasGarantia = [];
        let _allSaidasFabrica = [];
        let _allNFeData = []; 
        let _selectedSaidaItems = new Set();
        let _selectedStockItems = new Set(); 
        let _reportState = {
            sortColumn: 'descricao',
            sortDirection: 'asc',
            isIntelligentMode: false
        };

        let _saidaReportState = {
            sortColumn: 'descricao',
            sortDirection: 'asc'
        };
        let _saidaReportQuantities = new Map();

        let _currentSalesDetails = []; // NOVO: Armazena os dados do modal de detalhes de vendas para exportação


        let _reportQuantities = new Map();
        let _currentModalFabricaOrdersForPrint = [];
        let _salesChartInstance = null; // Para o gráfico de vendas
        
        // Estado da página de estoque
        let _stockState = {
            statusFilter: 'todos',
            currentPage: 1,
            itemsPerPage: 15,
            sortColumn: 'descricao',
            sortDirection: 'asc'
        };

        // NOVO: Estado para a página Gerenciar Saída
        let _saidaState = {
            currentPage: 1,
            itemsPerPage: 15,
            sortColumn: 'descricao',
            sortDirection: 'asc'
        };

        // Estado da tabela de pedidos
        let _ordersTableState = {
            searchTerm: '',
            sortColumn: 'descricao', 
            sortDirection: 'asc', 
            selectedType: 'terceiros',
            statusFilters: new Set() 
        };

        // ATUALIZADO: Estado da tabela de NFe com novos filtros
        let _nfeTableState = {
            sortColumn: 'data_de_emissao',
            sortDirection: 'desc',
            currentStoreFilter: 'todos', // 'todos', 'bling', 'mercado_livre', etc.
            conferenceStatusFilter: 'todos', // 'todos', 'conferidas', 'nao_conferidas'
            isInitialView: true,
            filters: {
                startDate: null,
                endDate: null
            },
            currentDateFilterValue: 'all'
        };

        // NOVO: Estado para a página de Dashboards
        let _dashboardState = {
            selectedChannel: 'total', // 'total', 'bling', 'mercado_livre', etc.
            currentDateFilterValue: 'all' // Armazena o valor do filtro de data ativo
        };

        let _itemsToPrint = [];
        let _currentPrintModalType = '';

        // --- REFERÊNCIAS PRIVADAS A ELEMENTOS DO DOM ---
        let _pagePesquisar, _pageEstoque, _pageOverviewRequisitions, _pageOverviewSaidas, _pageReport, _pageSaidaReport, _pageGerenciarSaida, _pageDashboards;
        let _navPesquisar, _navEstoque, _navGerenciarSaida, _navDashboards;
        let _refreshButton, _loadingOverlay;
        let _globalFilterBar, _globalSearchInput, _globalFilterButton, _globalFilterDropdown, _globalCategoryCheckboxesContainer, _selectedItemsCountDisplay, _generateReportButton, _stockActionsContainer, _globalFilterButtonLabel, _globalFilterMenuContainer;
        let _product_list_container, _product_details_container, _details_placeholder, _product_details, _requisitionOverviewCardsContainer, _saidaOverviewCards, _ordersTableTitle, _ordersTableContent, _noOrdersMessage, _noOrdersMessageModal, _ordersSearchInput;
        let _saidaActionsContainer, _selectedSaidaItemsCount, _clearSaidaSelectionBtn, _viewSaidasBtn, _createSaidaBtn;
        let _ordersTableActionsMenuContainer, _ordersTableActionsButton, _ordersTableActionsDropdown, _ordersTableActionPrintGeneric, _ordersTableActionPrintList, _ordersTableActionPrintSolicitation, _ordersTableActionExcel;
        let _ordersFilterMenuContainer, _ordersFilterButton, _ordersFilterButtonLabel, _ordersFilterDropdown, _ordersStatusCheckboxesContainer;
        let _clearGlobalSearchBtn, _clearOrdersSearchBtn; // NOVO: Botões para limpar busca
        let _nfeOverviewCardsContainer, _noNFeMessageOverview, _nfeFilterBar, _nfeStartDateInput, _nfeEndDateInput, _nfeClearFiltersBtn, _nfeDashboardGrid, _nfeDiagnosticTableContainer;
        let _orderDetailsModal, _closeModalBtn, _modalOrderTitle, _modalOrderContent;
        let _messageModal, _messageModalTitle, _messageModalContent, _messageModalOkBtn, _closeMessageModalBtn;
        let _reportActionBar, _reportLaunchTerceirosBtn, _reportLaunchFabricaBtn, _reportBackBtn, _pageReportContent, _reportActionsMenuContainer, _reportActionsButton, _reportActionsDropdown, _reportActionPrintList, _reportActionPrintReq, _reportActionExcel;
        let _printTableModal, _printModalTitle, _printModalContent, _cancelPrintBtn, _confirmPrintBtn;
        let _confirmationModal, _confirmationModalTitle, _confirmationModalContent, _confirmYesBtn, _confirmNoBtn, _printArea;
        let _terceirosRequisitionModal, _closeTerceirosReqModalBtn, _terceirosReqModalMessage, _terceirosRequisitionCodeInput, _confirmTerceirosReqBtn, _cancelTerceirosReqBtn; // NOVO
        let _terceirosOrdersModal, _closeTerceirosOrdersModalBtn;
        let _nfeDetailsModal, _closeNFeModalBtn, _nfeModalTitle, _printNFeModalTableBtn, _nfeModalSearchInput, _nfeModalTableContent, _noNFeMessageModal;
        let _browserPrintFabricaModal, _browserPrintFabricaContent, _closeBrowserPrintFabricaModalBtn;
        let _customProductTooltip;
        let _viewRequisitionsBtn;
        let _requisitionActionBar, _requisitionBackBtn, _saidaActionBar, _saidaBackBtn, _saidaReportActionBar, _saidaReportBackBtn, _launchSaidaGarantiaBtn, _launchSaidaFabricaBtn, _pageSaidaReportContent;
        let _dashboardFilterBar, _dashboardStartDateInput, _dashboardEndDateInput, _dashboardSummaryCards, _salesChartCanvas, _salesTableContainer, _dashboardClearFiltersBtn;
        let _currentFilteredOrderItems = []; // NOVO: Armazena os itens filtrados e ordenados da tabela de pedidos
        let _clearSelectionBtn;
        let _salesDetailsModal, _closeSalesDetailsModalBtn, _salesDetailsModalTitle, _salesDetailsModalContent, _noSalesDetailsMessage, _exportSalesDetailsCsvBtn; // Modal de Vendas
        let _nfeObservationModal, _nfeObservationModalInfo, _nfeObservationHistory, _nfeObservationTextarea, _saveNfeObservationBtn, _cancelNfeObservationBtn, _nfeObservationCharCount; // Modal de Observação NFe
        let _requisitionObservationModal, _requisitionObservationModalInfo, _requisitionObservationHistory, _requisitionObservationTextarea, _saveRequisitionObservationBtn, _cancelRequisitionObservationBtn, _requisitionObservationCharCount; // Modal de Observação Requisição
        let _stockAdjustmentModal, _closeStockAdjustmentModalBtn, _stockAdjustmentProductInfo, _stockAdjustmentCurrentStock, _stockAdjustmentNewQuantity, _stockAdjustmentReason, _confirmStockAdjustmentBtn, _cancelStockAdjustmentBtn; // NOVO: Modal de Ajuste de Estoque

        // --- FUNÇÕES DE UTILIDADE PRIVADAS ---
        
        /**
         * NOVO: Cria uma pílula de status visual para a tabela de pedidos.
         * @param {string} type - O tipo de status ('ok', 'pending', 'overdue').
         * @param {string} text - O texto a ser exibido na pílula.
         * @returns {string} O HTML da pílula.
         */
        function _createOrderStatusPill(type, text) {
            const styles = {
                ok: 'bg-green-100 text-green-800',
                pending: 'bg-yellow-100 text-yellow-800',
                overdue: 'bg-red-100 text-red-800',
                indefinido: 'bg-gray-100 text-gray-800'
            };
            const pillClass = styles[type] || styles['indefinido'];
            return `<span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${pillClass}">${text}</span>`;
        }

        /**
         * Converte uma string de data no formato dd/mm/yyyy para um objeto Date.
         * @param {string} dateString A data no formato "dd/mm/yyyy".
         * @returns {Date|null} O objeto Date ou null se o formato for inválido.
         */
        function _parsePtBrDate(dateString) {
            if (!dateString || typeof dateString !== 'string') return null;

            // Primeiro, tenta analisar o formato dd/mm/yyyy (ou dd/mm/yy)
            if (dateString.includes('/')) {
                const parts = dateString.split('/');
                if (parts.length === 3) {
                    const day = parseInt(parts[0], 10);
                    const month = parseInt(parts[1], 10) - 1; // Mês é base 0 em JS
                    const year = parseInt(parts[2], 10);
                    if (!isNaN(day) && !isNaN(month) && !isNaN(year)) {
                        const fullYear = year < 100 ? 2000 + year : year;
                        const date = new Date(fullYear, month, day);
                        if (!isNaN(date.getTime())) return date;
                    }
                }
            }

            // Se não for o formato acima, tenta analisar diretamente (lida com ISO 8601)
            const date = new Date(dateString);
            return !isNaN(date.getTime()) ? date : null;
        }

        /**
         * Normaliza uma string, removendo acentos e convertendo para minúsculas.
         * @param {string} str A string a ser normalizada.
         * @returns {string} A string normalizada.
         */
        function _normalizeString(str) {
            if (!str) return '';
            return str
                .toString()
                .normalize('NFD') // Separa acentos dos caracteres base
                .replace(/[\u0300-\u036f]/g, '') // Remove os acentos
                .toLowerCase(); // Converte para minúsculas
        }

        function _showMessageModal(title, message) {
            _messageModalTitle.textContent = title;
            _messageModalContent.innerHTML = message;
            _messageModal.classList.remove('hidden');
        }

        function _showConfirmationModal(title, message) {
            return new Promise((resolve) => {
                if (_confirmationModalTitle) _confirmationModalTitle.textContent = title;
                if (_confirmationModalContent) _confirmationModalContent.innerHTML = message;
                if (_confirmationModal) _confirmationModal.classList.remove('hidden');

                const onConfirm = () => {
                    if (_confirmYesBtn) _confirmYesBtn.removeEventListener('click', onConfirm);
                    if (_confirmNoBtn) _confirmNoBtn.removeEventListener('click', onCancel);
                    if (_confirmationModal) _confirmationModal.classList.add('hidden');
                    resolve(true);
                };

                const onCancel = () => {
                    if (_confirmYesBtn) _confirmYesBtn.removeEventListener('click', onConfirm);
                    if (_confirmNoBtn) _confirmNoBtn.removeEventListener('click', onCancel);
                    if (_confirmationModal) _confirmationModal.classList.add('hidden');
                    resolve(false);
                };

                if (_confirmYesBtn) _confirmYesBtn.addEventListener('click', onConfirm, { once: true });
                if (_confirmNoBtn) _confirmNoBtn.addEventListener('click', onCancel, { once: true });
            });
        }
        
        /**
         * Mostra um tooltip com a imagem e/ou descrição completa do produto.
         * @param {MouseEvent} event - O evento do mouse (mouseover).
         */
        function _showProductTooltip(event) {
            const targetElement = event.target;
            let imageUrl = '';
            let fullDescription = '';

            // Determina a origem do hover e obtém os dados
            if (targetElement.classList.contains('product-list-item-img')) {
                imageUrl = targetElement.dataset.imageUrl;
            } else if (targetElement.closest('.product-description-cell')) {
                const cell = targetElement.closest('.product-description-cell');
                imageUrl = cell.dataset.imageUrl;
                fullDescription = cell.dataset.fullDescription;
            } else {
                return; // Não é um alvo de hover que nos interessa
            }

            const hasImage = imageUrl && !imageUrl.includes('placehold.co');
            const hasDescription = fullDescription && fullDescription !== 'N/A';

            if (!hasImage && !hasDescription) return;

            if (_customProductTooltip) {
                let tooltipContent = '<div class="flex flex-col items-center p-2 bg-white rounded-lg shadow-xl border border-gray-200 max-w-sm">';
                if (hasImage) {
                    tooltipContent += `<img src="${imageUrl}" alt="Pré-visualização" class="max-w-xs max-h-xs rounded-md mb-2">`;
                }
                if (hasDescription) {
                    tooltipContent += `<p class="text-sm font-semibold text-gray-800 text-center break-words">${fullDescription}</p>`;
                }
                tooltipContent += '</div>';

                _customProductTooltip.innerHTML = tooltipContent;
                
                const rect = targetElement.getBoundingClientRect();
                
                _customProductTooltip.style.left = `${rect.right + 15}px`;

                _customProductTooltip.style.visibility = 'hidden';
                _customProductTooltip.classList.remove('hidden');
                const tooltipHeight = _customProductTooltip.offsetHeight;
                
                let topPos = rect.top;

                if (topPos + tooltipHeight > window.innerHeight) {
                    topPos = window.innerHeight - tooltipHeight - 10;
                }
                if (topPos < 10) topPos = 10;

                _customProductTooltip.style.top = `${topPos}px`;
                
                _customProductTooltip.style.visibility = 'visible';
                void _customProductTooltip.offsetWidth;
                _customProductTooltip.style.opacity = '1';
            }
        }


        /**
         * Esconde o tooltip do produto.
         */
        function _hideProductTooltip() {
            if (_customProductTooltip) {
                _customProductTooltip.style.opacity = '0';
                // Usa um timeout para permitir que a transição de fade-out termine antes de esconder o elemento
                setTimeout(() => {
                    if (_customProductTooltip.style.opacity === '0') {
                        _customProductTooltip.classList.add('hidden');
                        _customProductTooltip.innerHTML = ''; // Limpa o conteúdo
                    }
                }, 200);
            }
        }

        /**
         * Exporta os dados atualmente exibidos no modal de detalhes de vendas para um arquivo CSV.
         */
        function _exportSalesDetailsToCSV() {
            if (_currentSalesDetails.length === 0) {
                _showMessageModal("Nenhum Dado", "Não há dados para exportar.");
                return;
            }

            const headers = [
                "Nº da Nota", "Data de Emissão", "Cliente", "Valor da Nota", "Situação", "Link DANFE"
            ];

            // Prepara o conteúdo do CSV, tratando aspas e usando ponto e vírgula como separador para melhor compatibilidade com o Excel em português
            let csvContent = headers.join(";") + "\n";

            _currentSalesDetails.forEach(nfe => {
                const nfeDate = _parsePtBrDate(nfe.data_de_emissao);
                const row = [
                    `"${nfe.numero_da_nota || 'N/A'}"`,
                    `"${nfeDate ? nfeDate.toLocaleDateString('pt-BR') : 'N/A'}"`,
                    `"${(nfe.nome_do_cliente || 'N/A').replace(/"/g, '""')}"`, // Trata aspas no nome
                    (parseFloat(nfe.valor_da_nota) || 0).toLocaleString('pt-BR', { useGrouping: false, minimumFractionDigits: 2 }).replace('.', ','), // Formato numérico brasileiro
                    `"${nfe.situacao || 'N/A'}"`,
                    `"${nfe.link_danfe || '#'}"`
                ];
                csvContent += row.join(";") + "\n";
            });

            // Cria e dispara o download
            const blob = new Blob([`\uFEFF${csvContent}`], { type: 'text/csv;charset=utf-8;' }); // \uFEFF (BOM) para garantir a codificação correta no Excel
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "detalhes_vendas.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        /**
         * Mostra um tooltip com a observação da NFe, posicionado acima do cursor.
         * @param {MouseEvent} event - O evento do mouse (mouseover).
         */
        function _showObservationTooltip(event) {
            // CORREÇÃO: O alvo agora é o ícone de exclamação, não o botão antigo.
            const targetElement = event.target.closest('.nfe-observation-status-icon');
            if (!targetElement || !_customProductTooltip) return;

            let observationText = "Nenhuma Observação";
            try {
                const observationData = JSON.parse(targetElement.dataset.observation || '[]');
                if (Array.isArray(observationData) && observationData.length > 0) {
                    // Mostra a observação mais recente no tooltip
                    observationText = observationData[observationData.length - 1];
                }
            } catch (e) { /* Ignora erros de parse, mantém o padrão */ }

            // Define o conteúdo do tooltip com o estilo do tooltip de produto
            _customProductTooltip.innerHTML = `<div class="p-2 bg-white rounded-lg shadow-xl border border-gray-400 max-w-sm"><p class="text-sm font-semibold text-gray-800 text-center break-words">${observationText}</p></div>`;
            
            // Torna o tooltip visível, mas fora da tela, para medir suas dimensões
            _customProductTooltip.style.visibility = 'hidden';
            _customProductTooltip.classList.remove('hidden');

            const tooltipHeight = _customProductTooltip.offsetHeight;
            const tooltipWidth = _customProductTooltip.offsetWidth;

            // Calcula a posição para ficar acima e centralizado no cursor
            let top = event.pageY - tooltipHeight - 15; // 15px de espaço acima do cursor
            let left = event.pageX - (tooltipWidth / 2);

            // Ajusta a posição para não sair da tela
            if (top < window.scrollY) top = event.pageY + 25; // Se for sair pelo topo, mostra abaixo
            if (left < window.scrollX) left = window.scrollX + 5;
            if (left + tooltipWidth > window.innerWidth + window.scrollX) left = window.innerWidth + window.scrollX - tooltipWidth - 5;

            _customProductTooltip.style.top = `${top}px`;
            _customProductTooltip.style.left = `${left}px`;
            
            _customProductTooltip.style.visibility = 'visible';
            _customProductTooltip.style.opacity = '1';
        }

        /**
         * Atualiza o contador de caracteres para a nova observação.
         */
        function _updateObservationCharCount() {
            if (!_nfeObservationTextarea || !_nfeObservationCharCount) return;
            const currentLength = _nfeObservationTextarea.value.length;
            const maxLength = _nfeObservationTextarea.maxLength;
            _nfeObservationCharCount.textContent = currentLength;

            const counterContainer = _nfeObservationCharCount.parentElement;
            if (currentLength >= maxLength) {
                counterContainer.classList.add('text-red-600', 'font-bold');
            } else {
                counterContainer.classList.remove('text-red-600', 'font-bold');
            }
        }

        /**
         * Renderiza o histórico de observações em um formato de chat.
         * @param {string[]} observations - Array de strings de observação.
         */
        function _renderObservationChat(observations) {
            if (!_nfeObservationHistory) return;

            if (!observations || !Array.isArray(observations) || observations.length === 0) {
                _nfeObservationHistory.innerHTML = '<p class="text-center text-gray-500 py-4">Nenhuma observação registrada.</p>';
                return;
            }

            const chatHtml = observations.map(obsString => {
                // Divide a string em data/hora e mensagem. Ex: "26/08/2025, 12:09 - teste"
                const parts = obsString.split(' - ');
                const timestamp = parts.length > 1 ? parts[0] : '';
                const message = parts.length > 1 ? parts.slice(1).join(' - ') : obsString;

                return `
                    <div class="p-3 rounded-lg bg-blue-100 text-gray-800 max-w-md self-start">
                        <p class="text-sm whitespace-pre-wrap">${message}</p>
                        <div class="flex items-center justify-end mt-1">
                            <span class="text-xs text-gray-500 mr-1">${timestamp}</span>
                            <span title="Salvo">
                                <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                            </span>
                        </div>
                    </div>
                `;
            }).join('');

            _nfeObservationHistory.innerHTML = chatHtml;
            // Rola para a mensagem mais recente
            _nfeObservationHistory.scrollTop = _nfeObservationHistory.scrollHeight;
        }

        /**
         * Abre o modal para visualizar/editar a observação de uma NFe.
         * @param {string} nfeId - O ID da NFe.
         */
        function _openNfeObservationModal(nfeId) {
            const nfe = _allNFeData.find(n => String(n.id_nota) === String(nfeId));
            if (!nfe) {
                _showMessageModal("Erro", "Nota Fiscal não encontrada.");
                return;
            }

            if (_nfeObservationModal) {
                _nfeObservationModal.dataset.nfeId = nfeId;
                _nfeObservationModalInfo.innerHTML = `Editando observação para a NFe Nº: <a href="${nfe.link_danfe || '#'}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline font-bold">${nfe.numero_da_nota || 'N/A'}</a>`;
                _renderObservationChat(nfe.observacao); // Renderiza o histórico
                _nfeObservationTextarea.value = ''; // Limpa a área de nova mensagem
                _updateObservationCharCount(); // Reseta o contador
                _nfeObservationModal.classList.remove('hidden');
                _nfeObservationTextarea.focus();
            }
        }

        /**
         * Salva a observação da NFe e atualiza a interface.
         */
        async function _saveNfeObservation() {
            const nfeId = _nfeObservationModal.dataset.nfeId;
            const newObservation = _nfeObservationTextarea.value;

            if (!nfeId || !newObservation.trim()) return;

            const nfeToUpdate = _allNFeData.find(nfe => String(nfe.id_nota) === String(nfeId));
            if (!nfeToUpdate) {
                _showMessageModal("Erro", "Nota Fiscal não encontrada para salvar a observação.");
                return;
            }

            _saveNfeObservationBtn.disabled = true;
            _nfeObservationTextarea.value = '';
            _updateObservationCharCount();

            try {
                const payload = {
                    id_nota: nfeId,
                    observacao: newObservation
                };

                const response = await fetch(NFE_OBSERVATION_API_URL, {
                    method: 'POST', mode: 'cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Erro na API (Status: ${response.status}): ${errorText}`);
                }

                const result = await response.json();
                if (!result.data || !result.data.newObservation) {
                    throw new Error("A resposta da API não retornou a nova observação formatada.");
                }

                const newHistoryAsString = result.data.newObservation;
                nfeToUpdate.observacao = newHistoryAsString.split('\n').filter(line => line.trim() !== '');

                _renderObservationChat(nfeToUpdate.observacao);
                
                const rowToUpdate = document.getElementById(`sales-detail-row-${nfeId}`);
                if (rowToUpdate) {
                    const viewBtn = rowToUpdate.querySelector('.view-nfe-observation-btn');
                    const statusIcon = rowToUpdate.querySelector('.nfe-observation-status-icon');
                    const newObservationJson = JSON.stringify(nfeToUpdate.observacao);
                    if (viewBtn) viewBtn.dataset.observation = newObservationJson;
                    if (statusIcon) {
                        statusIcon.dataset.observation = newObservationJson;
                        const svgIcon = statusIcon.querySelector('svg');
                        if (svgIcon) {
                            svgIcon.classList.remove('text-gray-400');
                            svgIcon.classList.add('text-red-500');
                            statusIcon.title = 'Esta nota possui observações';
                        }
                    }
                }
            } catch (error) {
                _showMessageModal("Erro ao Salvar", `Não foi possível salvar a observação: ${error.message}`);
                _nfeObservationTextarea.value = newObservation;
                _updateObservationCharCount();
            } finally {
                _saveNfeObservationBtn.disabled = false;
            }
        }

        /**
         * Encontra um item de requisição específico em todas as listas de pedidos.
         * @param {string} orderCode - O código da requisição.
         * @param {string} codigoService - O código do produto (service).
         * @returns {object|null} O objeto do item ou null se não for encontrado.
         */
        function _findRequisitionItem(orderCode, codigoService) {
            // ATUALIZADO: Inclui as listas de SAÍDA na busca pelo item.
            const allOrders = [
                ..._allOrdersTerceiros, 
                ..._allOrdersFabrica,
                ..._allSaidasFabrica,
                ..._allSaidasGarantia
            ];
            const trimmedOrderCode = String(orderCode || '').trim();
            const trimmedCodigoService = String(codigoService || '').trim();
            const order = allOrders.find(o => String(o.orderCode || '').trim() === trimmedOrderCode);
            if (!order) return null;
            return order.rawItems.find(i => String(i.codigoService || '').trim() === trimmedCodigoService);
        }

        /**
         * Renderiza o histórico de observações de um item de requisição.
         * @param {string[]} observations - Array de strings de observação.
         */
        function _renderRequisitionObservationChat(observations) {
            if (!_requisitionObservationHistory) return;

            if (!observations || !Array.isArray(observations) || observations.length === 0) {
                _requisitionObservationHistory.innerHTML = '<p class="text-center text-gray-500 py-4">Nenhuma observação registrada.</p>';
                return;
            }

            const chatHtml = observations.map(obsString => {
                const parts = obsString.split(' - ');
                const timestamp = parts.length > 1 ? parts[0] : '';
                const message = parts.length > 1 ? parts.slice(1).join(' - ') : obsString;

                return `
                    <div class="p-3 rounded-lg bg-purple-100 text-gray-800 max-w-md self-start">
                        <p class="text-sm whitespace-pre-wrap">${message}</p>
                        <div class="flex items-center justify-end mt-1">
                            <span class="text-xs text-gray-500 mr-1">${timestamp}</span>
                            <span title="Salvo">
                                <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                            </span>
                        </div>
                    </div>
                `;
            }).join('');

            _requisitionObservationHistory.innerHTML = chatHtml;
            _requisitionObservationHistory.scrollTop = _requisitionObservationHistory.scrollHeight;
        }

        /**
         * Abre o modal para visualizar/editar a observação de um item de requisição.
         * @param {string} orderCode - O código da requisição.
         * @param {string} codigoService - O código do produto.
         */
        function _openRequisitionObservationModal(orderCode, codigoService) {
            const item = _findRequisitionItem(orderCode, codigoService);
            if (!item) {
                _showMessageModal("Erro", "Item de requisição não encontrado.");
                return;
            }

            if (_requisitionObservationModal) {
                _requisitionObservationModal.dataset.orderCode = orderCode;
                _requisitionObservationModal.dataset.codigoService = codigoService;
                _requisitionObservationModalInfo.innerHTML = `Observações para o item <b>${item.descricao}</b> (${item.codigoService}) na Requisição <b>${orderCode}</b>`;
                _renderRequisitionObservationChat(item.observacao);
                _requisitionObservationTextarea.value = '';
                _updateRequisitionObservationCharCount();
                _requisitionObservationModal.classList.remove('hidden');
                _requisitionObservationTextarea.focus();
            }
        }

        /**
         * Salva a observação de um item de requisição.
         */
        async function _saveRequisitionObservation() {
            const orderCode = _requisitionObservationModal.dataset.orderCode;
            const codigoService = _requisitionObservationModal.dataset.codigoService;
            const newObservation = _requisitionObservationTextarea.value;

            if (!orderCode || !codigoService || !newObservation.trim()) return;

            const itemToUpdate = _findRequisitionItem(orderCode, codigoService);
            if (!itemToUpdate) {
                _showMessageModal("Erro", "Item de requisição não encontrado para salvar.");
                return;
            }

            _saveRequisitionObservationBtn.disabled = true;
            _requisitionObservationTextarea.value = '';
            _updateRequisitionObservationCharCount();

            try {
                const payload = {
                    id_requisicao: orderCode,
                    codigo_service: codigoService,
                    observacao: newObservation
                };

                // ATUALIZADO: Determina a URL correta da API com base no tipo de requisição/saída.
                const apiUrls = {
                    'terceiros': TERCEIROS_OBSERVATION_API_URL,
                    'fabrica': FABRICA_OBSERVATION_API_URL,
                    'saidas-fabrica': SAIDA_FABRICA_OBSERVATION_API_URL,
                    'saidas-garantia': SAIDA_GARANTIA_OBSERVATION_API_URL
                };
                const apiUrl = apiUrls[itemToUpdate.requisitionType];

                const response = await fetch(apiUrl, {
                    method: 'POST', mode: 'cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Erro na API (Status: ${response.status}): ${errorText}`);
                }

                const result = await response.json();
                if (!result.data || !result.data.newObservation) {
                    throw new Error("A resposta da API de requisição não retornou a observação formatada.");
                }

                const newHistoryAsString = result.data.newObservation;
                itemToUpdate.observacao = newHistoryAsString.split('\n').filter(line => line.trim() !== '');

                _renderRequisitionObservationChat(itemToUpdate.observacao);

                // ATUALIZADO: Atualização direcionada do ícone na tabela, em vez de re-renderizar tudo.
                const tableRow = document.querySelector(`.order-item-checkbox[data-order-code="${orderCode}"][data-codigo-service="${codigoService}"]`)?.closest('tr');
                if (tableRow) {
                    const viewBtn = tableRow.querySelector('.view-requisition-observation-btn');
                    const statusIcon = tableRow.querySelector('.requisition-observation-status-icon');
                    const newObservationJson = JSON.stringify(itemToUpdate.observacao);

                    if (viewBtn) viewBtn.dataset.observation = newObservationJson;

                    if (statusIcon) {
                        statusIcon.dataset.observation = newObservationJson;
                        const svgIcon = statusIcon.querySelector('svg');
                        if (svgIcon) {
                            svgIcon.classList.remove('text-gray-400');
                            svgIcon.classList.add('text-red-500');
                            statusIcon.title = 'Este item possui observações';
                        }
                    }
                }
            } catch (error) {
                _showMessageModal("Erro ao Salvar", `Não foi possível salvar a observação: ${error.message}`);
                _requisitionObservationTextarea.value = newObservation;
                _updateRequisitionObservationCharCount();
            } finally {
                _saveRequisitionObservationBtn.disabled = false;
            }
        }

        /**
         * Atualiza o contador de caracteres para a nova observação da requisição.
         */
        function _updateRequisitionObservationCharCount() {
            if (!_requisitionObservationTextarea || !_requisitionObservationCharCount) return;
            const currentLength = _requisitionObservationTextarea.value.length;
            const maxLength = _requisitionObservationTextarea.maxLength;
            _requisitionObservationCharCount.textContent = currentLength;
            const counterContainer = _requisitionObservationCharCount.parentElement;
            if (currentLength >= maxLength) {
                counterContainer.classList.add('text-red-600', 'font-bold');
            } else {
                counterContainer.classList.remove('text-red-600', 'font-bold');
            }
        }

        /**
         * Mostra um modal com os detalhes das vendas para um mês e canal específicos.
         * @param {string} monthKey - A chave do mês no formato 'YYYY-MM'.
         * @param {string} channel - O nome do canal de vendas (ex: 'Bling', 'Mercado Livre').
         */
        function _showSalesDetailsModal(monthKey, channel) {
            if (!_salesDetailsModal || !_salesDetailsModalContent || !_salesDetailsModalTitle || !_noSalesDetailsMessage) return;

            let startFilterDate, endFilterDate;
            let titleDatePart;
            const titleChannelPart = channel === 'Total' ? 'Todos os Canais' : channel;

            if (monthKey === 'period-total') {
                const startDateValue = _dashboardStartDateInput.value;
                const endDateValue = _dashboardEndDateInput.value;
                startFilterDate = startDateValue ? new Date(startDateValue + 'T00:00:00') : null;
                endFilterDate = endDateValue ? new Date(endDateValue + 'T23:59:59') : null;

                if (startDateValue && endDateValue) {
                    const startStr = _parsePtBrDate(startDateValue).toLocaleDateString('pt-BR');
                    const endStr = _parsePtBrDate(endDateValue).toLocaleDateString('pt-BR');
                    titleDatePart = `de ${startStr} a ${endStr}`;
                } else {
                    titleDatePart = "em todo o período";
                }
            } else {
                const [year, month] = monthKey.split('-');
                startFilterDate = new Date(parseInt(year), parseInt(month) - 1, 1);
                endFilterDate = new Date(parseInt(year), parseInt(month), 0);
                titleDatePart = `em ${monthKey}`;
            }

            const filteredNFe = _allNFeData.filter(nfe => {
                const nfeDate = _parsePtBrDate(nfe.data_de_emissao);
                if (!nfeDate) return false;
                // Compara apenas a data, ignorando a hora para o range do mês
                const nfeDateOnly = new Date(nfeDate.getFullYear(), nfeDate.getMonth(), nfeDate.getDate());
                
                const channelMatch = (channel === 'Total') ? true : (nfe.origem_loja === channel);
                const startDateMatch = startFilterDate ? nfeDateOnly >= startFilterDate : true;
                const endDateMatch = endFilterDate ? nfeDateOnly <= endFilterDate : true;

                return channelMatch && startDateMatch && endDateMatch;
            });

            // Armazena os dados filtrados para a função de exportação
            _currentSalesDetails = filteredNFe;

            // Calcula o valor total e atualiza o título do modal
            const totalValue = filteredNFe.reduce((sum, nfe) => sum + (parseFloat(nfe.valor_da_nota) || 0), 0);
            const formattedTotal = totalValue.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            _salesDetailsModalTitle.textContent = `Vendas Detalhadas para ${titleChannelPart} ${titleDatePart} - Total: ${formattedTotal}`;

            if (filteredNFe.length === 0) {
                _salesDetailsModalContent.innerHTML = '';
                _noSalesDetailsMessage.classList.remove('hidden');
                _salesDetailsModal.classList.remove('hidden'); // Mostra o modal com a mensagem de "sem dados"
                return;
            }

            _noSalesDetailsMessage.classList.add('hidden');

            let tableHtml = `
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nº da Nota</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cliente / Data Emissão</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Valor da Nota</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Situação</th>
                            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Observações</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
            `;

            filteredNFe.forEach(nfe => {
                const nfeDate = _parsePtBrDate(nfe.data_de_emissao);
                const hasObservation = Array.isArray(nfe.observacao) && nfe.observacao.length > 0;
                const formattedDate = nfeDate ? nfeDate.toLocaleDateString('pt-BR') : 'N/A';
                const observacaoJson = JSON.stringify(nfe.observacao || []);

                tableHtml += `
                    <tr id="sales-detail-row-${nfe.id_nota}">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-blue-600"><a href="${nfe.link_danfe || '#'}" target="_blank" rel="noopener noreferrer">${nfe.numero_da_nota || 'N/A'}</a></td>
                        <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm font-medium text-gray-900">${nfe.nome_do_cliente || 'N/A'}</div><div class="text-xs text-gray-500">${formattedDate}</div></td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-right">${(parseFloat(nfe.valor_da_nota) || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${nfe.situacao || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                            <div class="flex items-center justify-center space-x-2">
                                <button class="view-nfe-observation-btn text-gray-500 hover:text-blue-600 p-1 rounded-full" data-nfe-id="${nfe.id_nota}" data-observation='${observacaoJson}' title="Visualizar Observações">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                                </button>
                                <!-- NOVO: Ícone de exclamação sempre presente, cor condicional -->
                                <span class="nfe-observation-status-icon cursor-pointer" data-nfe-id="${nfe.id_nota}" data-observation='${observacaoJson}' title="${hasObservation ? 'Esta nota possui observações' : 'Nenhuma observação'}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ${hasObservation ? 'text-red-500' : 'text-gray-400'}" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                                    </svg>
                                </span>
                            </div>
                        </td>
                    </tr>
                `;
            });
            tableHtml += `</tbody></table>`;
            _salesDetailsModalContent.innerHTML = tableHtml;
            _salesDetailsModal.classList.remove('hidden');
        }

        // NOVO: Abre o modal de ajuste de estoque
        function _openStockAdjustmentModal(productId) {
            const product = _allProducts.find(p => String(p.id) === String(productId));
            if (!product) {
                _showMessageModal("Erro", "Produto não encontrado para realizar o ajuste.");
                return;
            }

            if (_stockAdjustmentModal) {
                _stockAdjustmentModal.dataset.productId = product.id;
                _stockAdjustmentProductInfo.innerHTML = `<strong>Produto:</strong> ${product.descricao} (Cód: ${product.codigo})`;
                _stockAdjustmentCurrentStock.innerHTML = `<strong>Estoque Atual:</strong> ${product.estoque || 0}`;
                _stockAdjustmentNewQuantity.value = '';
                _stockAdjustmentModal.classList.remove('hidden');
                _stockAdjustmentNewQuantity.focus();
            }
        }

        // NOVO: Salva o ajuste de estoque
        async function _saveStockAdjustment() {
            const productId = _stockAdjustmentModal.dataset.productId;
            const newQuantityStr = _stockAdjustmentNewQuantity.value;

            const newQuantity = parseFloat(String(newQuantityStr || '0').replace(',', '.'));

            if (isNaN(newQuantity) || newQuantity < 0) {
                _showMessageModal("Valor Inválido", "Por favor, insira uma nova quantidade de estoque válida (número maior ou igual a zero).");
                return;
            }

            const product = _allProducts.find(p => String(p.id) === String(productId));
            if (!product) {
                _showMessageModal("Erro", "Produto não encontrado para salvar o ajuste.");
                return;
            }

            const payload = {
                produto: { id: product.id, codigo: product.codigo },
                operacaoBling: "B", // "B" para Balanço
                quantidadeMovimento: 0, // Não aplicável para balanço
                quantidadeFinal: newQuantity,
                tipoEntrada: "Balanço", // Tipo para identificar a operação
                observacoes: `Ajuste de balanço via sistema`,
                // Dados para a Planilha (não aplicável para balanço, mas mantemos a estrutura)
                orderCode: 'BALANCO',
                codigoService: product.codigo,
                newStatus: 'N/A',
                requisitionType: 'balanco',
                dataEntrega: new Date().toLocaleDateString('pt-BR'),
                diasCorridos: '0'
            };

            _loadingOverlay.classList.remove('hidden');
            try {
                const response = await fetch(ORDERS_UPDATE_API_URL, { method: 'POST', mode: 'cors', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
                if (!response.ok) { const errorText = await response.text(); throw new Error(`Erro na API (Status: ${response.status}): ${errorText}`); }
                
                product.estoque = newQuantity;
                _stockAdjustmentModal.classList.add('hidden');
                _showMessageModal("Sucesso!", `Estoque do produto <strong>${product.descricao}</strong> ajustado para <strong>${newQuantity}</strong>.`);
                
                // ATUALIZADO: Re-renderiza a lista e os detalhes do produto
                if (typeof PesquisarProduto !== 'undefined' && PesquisarProduto.renderDetails) {
                    PesquisarProduto.renderDetails(product);
                }
            } catch (error) {
                _showMessageModal("Erro no Ajuste", `Falha ao ajustar o estoque: ${error.message}`);
            } finally {
                _loadingOverlay.classList.add('hidden');
            }
        }

        // --- FUNÇÕES DE LÓGICA PRINCIPAL PRIVADAS ---
        function _showPage(pageId) {
            _pagePesquisar.classList.add('hidden');
            _pageEstoque.classList.add('hidden');
            _pageOverviewSaidas.classList.add('hidden');
            _pageOverviewRequisitions.classList.add('hidden');
            _pageSaidaReport.classList.add('hidden');
            _pageReport.classList.add('hidden');
            _pageGerenciarSaida.classList.add('hidden');
            _pageDashboards.classList.add('hidden');

            _navPesquisar.classList.remove('active');
            _navEstoque.classList.remove('active');
            _navGerenciarSaida.classList.remove('active');
            _navDashboards.classList.remove('active');

            // Esconde todas as barras de filtro por padrão
            if (_globalFilterBar) _globalFilterBar.classList.add('hidden');
            if (_dashboardFilterBar) _dashboardFilterBar.classList.add('hidden');
            if (_nfeFilterBar) _nfeFilterBar.classList.add('hidden'); // Esconde a nova barra
            if (_reportActionBar) _reportActionBar.classList.add('hidden');
            if (_requisitionActionBar) _requisitionActionBar.classList.add('hidden'); // Add this line to hide by default
            if (_saidaReportActionBar) _saidaReportActionBar.classList.add('hidden');
            if (_saidaActionBar) _saidaActionBar.classList.add('hidden');

            if (pageId === 'pesquisar') {
                _pagePesquisar.classList.remove('hidden');
                _navPesquisar.classList.add('active');
                if (_globalFilterBar) {
                    _globalFilterBar.classList.remove('hidden');
                    _globalSearchInput.classList.remove('hidden');
                    _globalFilterButton.classList.remove('hidden');
                    _stockActionsContainer.classList.add('hidden'); // Explicitly hide stock actions
                    _saidaActionsContainer.classList.add('hidden');
                }
                if (typeof PesquisarProduto !== 'undefined') {
                    PesquisarProduto.render(_allProducts);
                }
            } else if (pageId === 'estoque') {
                _pageEstoque.classList.remove('hidden');
                _navEstoque.classList.add('active');
                if (_globalFilterBar) {
                    _globalFilterBar.classList.remove('hidden');
                    _globalSearchInput.classList.remove('hidden');
                    _globalFilterButton.classList.remove('hidden');
                    _stockActionsContainer.classList.remove('hidden'); // Explicitly show stock actions
                    _saidaActionsContainer.classList.add('hidden');
                }
                _updateSelectedCountDisplay();
            } else if (pageId === 'overview-requisitions') {
                _pageOverviewRequisitions.classList.remove('hidden');
                if (_requisitionActionBar) _requisitionActionBar.classList.remove('hidden'); // Add this to show the bar
                _renderRequisitionOverviewPage();
            } else if (pageId === 'report') {
                _pageReport.classList.remove('hidden');
                if (_reportActionBar) _reportActionBar.classList.remove('hidden');
            } else if (pageId === 'saida-report') {
                _pageSaidaReport.classList.remove('hidden');
                if (_saidaReportActionBar) _saidaReportActionBar.classList.remove('hidden');
            } else if (pageId === 'gerenciar-saida') {
                // Quando o usuário clica na navegação, ele vê a lista de produtos para selecionar.
                // A tela de diagnóstico é uma sub-página.
                _pageGerenciarSaida.classList.remove('hidden');
                _pageOverviewSaidas.classList.add('hidden');
                _pageGerenciarSaida.classList.remove('hidden');
                _navGerenciarSaida.classList.add('active');
                if (_globalFilterBar) {
                    _globalFilterBar.classList.remove('hidden');
                    _globalSearchInput.classList.remove('hidden');
                    _globalFilterButton.classList.remove('hidden');
                    _stockActionsContainer.classList.add('hidden');
                    _saidaActionsContainer.classList.remove('hidden');
                }
            } else if (pageId === 'overview-saidas') {
                // Esta é a página de diagnóstico, acessada pelo botão "Ver Saídas".
                _pageOverviewSaidas.classList.remove('hidden');
                if (_saidaActionBar) _saidaActionBar.classList.remove('hidden');
                _renderSaidaOverviewPage();
            } else if (pageId === 'dashboards') {
                _pageDashboards.classList.remove('hidden');
                _navDashboards.classList.add('active');
                if (_dashboardFilterBar) _dashboardFilterBar.classList.remove('hidden');
                _renderDashboardsPage();
            }
            _applyGlobalFilters();
        }

        function _processRawOrdersData(rawData, type) {
            // ATUALIZADO: Validação para o novo formato (array de objetos)
            if (!Array.isArray(rawData) || (rawData.length > 0 && typeof rawData[0] !== 'object')) {
                console.warn(`Estrutura de dados de pedidos inválida (${type}). Esperado um array de objetos. Recebido:`, rawData);
                return [];
            }
            if (rawData.length === 0) {
                return [];
            }

            // O rawData já é um array de objetos, não precisa mais de mapeamento de cabeçalho.
            const itemRows = rawData;

            const ordersMap = new Map(); 
            itemRows.forEach(row => {
                // Acessa as propriedades diretamente do objeto 'row'
                const orderCode = row.requisicao;
                if (!orderCode) return; 

                if (!ordersMap.has(orderCode)) {
                    ordersMap.set(orderCode, {
                        orderCode: orderCode,
                        dataPedido: row.data_pedido, 
                        totalItems: 0,
                        totalAtendido: 0,
                        totalPendente: 0,
                        rawItems: [], 
                        // itemHeaders não é mais necessário
                    });
                }
                const order = ordersMap.get(orderCode);
                const itemStatus = (row.situacao || '').toLowerCase();

                // Adiciona o item ao array de itens brutos do pedido
                order.rawItems.push({
                    orderCode: orderCode,
                    codigoService: row.codigo_service || '',
                    codigoMksEquipamentos: row.codigo_mks_equipamentos || '', 
                    descricao: row.descricao || '',
                    localizacao: row.localizacao || 0,
                    quantidadePedido: row.quantidade_pedido || 0,
                    situacao: itemStatus,
                    dataPedido: row.data_pedido,
                    dataConclusao: row.data_entrega || null, // ATUALIZADO: Captura a data de entrega
                    diasCorridosRaw: row.dias_corridos || 0, 
                    observacao: row.observacao || [], // Já vem como array
                    prazoEntregaRaw: row.prazo_entrega || '',
                    requisitionType: type
                });

                // Atualiza os contadores do pedido
                order.totalItems++;
                if (itemStatus === 'ok') {
                    order.totalAtendido++;
                } else {
                    order.totalPendente++;
                }
            });

            // Define o status geral de cada pedido
            return Array.from(ordersMap.values()).map(order => {
                if (order.totalItems === 0) order.situacao = 'Sem Itens';
                else if (order.totalPendente === 0) order.situacao = 'Atendido';
                else if (order.totalAtendido > 0) order.situacao = 'Parcialmente Atendido';
                else order.situacao = 'Pendente';
                return order;
            });
        }
        
        // NOVO: Processa os dados brutos de SAÍDAS da fábrica
        function _processRawSaidasData(rawData, type) {
            if (!Array.isArray(rawData) || (rawData.length > 0 && typeof rawData[0] !== 'object')) {
                console.warn(`Estrutura de dados de saídas inválida (${type}). Esperado um array de objetos. Recebido:`, rawData);
                return [];
            }
            if (rawData.length === 0) return [];

            const saidasMap = new Map();
            rawData.forEach(row => {
                const saidaCode = row.requisicao;
                if (!saidaCode) return;

                if (!saidasMap.has(saidaCode)) {
                    saidasMap.set(saidaCode, {
                        orderCode: saidaCode,
                        dataPedido: row.data_pedido,
                        totalItems: 0,
                        totalAtendido: 0,
                        totalPendente: 0,
                        rawItems: [],
                    });
                }
                const saida = saidasMap.get(saidaCode);
                const itemStatus = (row.situacao || '').toLowerCase();

                saida.rawItems.push({
                    orderCode: saidaCode,
                    codigoService: row.codigo_service || '', // CORRIGIDO: Garante que o campo correto seja mapeado.
                    descricao: row.descricao || '',
                    localizacao: row.localizacao || 0,
                    quantidadePedido: row.quantidade || 0, // Mapeia 'quantidade' para 'quantidadePedido'
                    situacao: itemStatus,
                    dataPedido: row.data_pedido,
                    dataConclusao: row.data_envio || null, // Mapeia 'data_envio' para 'dataConclusao'
                    observacao: row.observacao || [],
                    responsavel: row.responsavel || '',
                    requisitionType: type // 'saidas-fabrica'
                });

                saida.totalItems++;
                if (itemStatus === 'ok') saida.totalAtendido++; else saida.totalPendente++;
            });
            return Array.from(saidasMap.values());
        }
        
        async function _fetchData() {
            _loadingOverlay.classList.remove('hidden');
            try {
                const [productsRes, ordersTerceirosRes, ordersFabricaRes, nfeRes, saidasFabricaRes, saidasGarantiaRes] = await Promise.all([
                    fetch(`${PRODUCTS_API_URL}?t=${new Date().getTime()}`, { mode: 'cors' }),
                    fetch(`${ORDERS_API_URL_TERCEIROS}?t=${new Date().getTime()}`, { mode: 'cors' }),
                    fetch(`${ORDERS_API_URL_FABRICA}?t=${new Date().getTime()}`, { mode: 'cors' }),
                    fetch(`${NFE_API_URL}?t=${new Date().getTime()}`, { mode: 'cors' }),
                    fetch(`${SAIDAS_API_URL_FABRICA}?t=${new Date().getTime()}`, { mode: 'cors' }),
                    fetch(`${SAIDAS_API_URL_GARANTIA}?t=${new Date().getTime()}`, { mode: 'cors' })
                ]);

                if (!productsRes.ok) throw new Error(`Erro na API de Produtos: ${productsRes.statusText}`);
                const productsData = await productsRes.json();
                if (productsData.error || !productsData.data) throw new Error(`Erro nos dados de Produtos: ${productsData.message || 'Formato inválido'}`);
                _allProducts.length = 0;
                Array.prototype.push.apply(_allProducts, productsData.data);

                if (!ordersTerceirosRes.ok) throw new Error(`Erro na API de Pedidos Terceiros: ${ordersTerceirosRes.statusText}`);
                const ordersTerceirosData = await ordersTerceirosRes.json();
                if (ordersTerceirosData.error || !ordersTerceirosData.data) throw new Error(`Erro nos dados de Pedidos Terceiros: ${ordersTerceirosData.message || 'Formato inválido'}`);
                _allOrdersTerceiros = _processRawOrdersData(ordersTerceirosData.data, 'terceiros');

                if (!ordersFabricaRes.ok) throw new Error(`Erro na API de Pedidos Fábrica: ${ordersFabricaRes.statusText}`);
                const ordersFabricaData = await ordersFabricaRes.json();
                if (ordersFabricaData.error || !ordersFabricaData.data) throw new Error(`Erro nos dados de Pedidos Fábrica: ${ordersFabricaData.message || 'Formato inválido'}`);
                _allOrdersFabrica = _processRawOrdersData(ordersFabricaData.data, 'fabrica');

                if (!nfeRes.ok) throw new Error(`Erro na API de NFe: ${nfeRes.statusText}`);
                const nfeData = await nfeRes.json();
                if (nfeData.error || !nfeData.data) throw new Error(`Erro nos dados de NFe: ${nfeData.message || 'Formato inválido'}`);
                _allNFeData = nfeData.data;

                if (!saidasFabricaRes.ok) throw new Error(`Erro na API de Saídas Fábrica: ${saidasFabricaRes.statusText}`);
                const saidasFabricaData = await saidasFabricaRes.json();
                if (saidasFabricaData.error || !saidasFabricaData.data) throw new Error(`Erro nos dados de Saídas Fábrica: ${saidasFabricaData.message || 'Formato inválido'}`);
                _allSaidasFabrica = _processRawSaidasData(saidasFabricaData.data, 'saidas-fabrica');

                if (!saidasGarantiaRes.ok) throw new Error(`Erro na API de Saídas Garantia: ${saidasGarantiaRes.statusText}`);
                const saidasGarantiaData = await saidasGarantiaRes.json();
                if (saidasGarantiaData.error || !saidasGarantiaData.data) throw new Error(`Erro nos dados de Saídas Garantia: ${saidasGarantiaData.message || 'Formato inválido'}`);
                _allSaidasGarantia = _processRawSaidasData(saidasGarantiaData.data, 'saidas-garantia');

                _renderCategoryFilters();
                _applyGlobalFilters();
                _updateSelectedCountDisplay();
                if (!_pageOverviewRequisitions.classList.contains('hidden')) _renderRequisitionOverviewPage();
                if (!_pageGerenciarSaida.classList.contains('hidden')) _renderNFeOverviewPage();
                if (!_pageDashboards.classList.contains('hidden')) _renderDashboardsPage();

            } catch (error) {
                let userFacingErrorMessage = `Falha ao carregar dados: ${error.message}.`;
                if (error instanceof TypeError && error.message === 'Failed to fetch') {
                    userFacingErrorMessage = `Falha ao conectar com o servidor. Verifique as URLs das APIs, problemas de rede ou CORS.`;
                }
                const errorHtml = `<div class="text-red-500 p-4"><b>${userFacingErrorMessage}</b></div>`;
                _product_list_container.innerHTML = errorHtml;
                _pageEstoque.innerHTML = errorHtml;
                _pageReport.innerHTML = errorHtml;
                _pageOverviewRequisitions.innerHTML = errorHtml;
                if (_noNFeMessageOverview) _noNFeMessageOverview.classList.remove('hidden');
            } finally {
                if (_loadingOverlay) _loadingOverlay.classList.add('hidden');
            }
        }

        function _applyGlobalFilters() {
            if (!_globalSearchInput || !_globalCategoryCheckboxesContainer) return; // Guard clause
            const searchTerm = _normalizeString(_globalSearchInput.value);
            const selectedCategories = [..._globalCategoryCheckboxesContainer.querySelectorAll('.category-checkbox:checked')].map(cb => cb.value);
            
            if (_globalFilterButtonLabel) _globalFilterButtonLabel.textContent = `Filtro (${selectedCategories.length})`;

            let filteredProducts = _allProducts.filter(product => {
                const normalizedCodigo = _normalizeString(product.codigo);
                const normalizedDescricao = _normalizeString(product.descricao);
                const searchMatch = (normalizedCodigo.includes(searchTerm) || normalizedDescricao.includes(searchTerm));
                
                let categoryMatch = selectedCategories.length === 0 ? true : selectedCategories.some(categoryKey => {
                    switch (categoryKey) {
                        case 'consumo': return product.grupo_de_tags_tags?.includes('Estoque - Consumo');
                        case 'fabrica': return product.grupo_de_tags_tags?.includes('Estoque - Fábrica');
                        case 'terceiros': return product.grupo_de_tags_tags?.includes('Estoque - Terceiros');
                        case 'demanda': return product.grupo_de_tags_tags?.includes('Sob Demanda - Fábrica');
                        case 'servicos': return product.codigo?.startsWith('7');
                        case 'em_branco': return !product.grupo_de_tags_tags || product.grupo_de_tags_tags.length === 0 || (product.grupo_de_tags_tags.length === 1 && product.grupo_de_tags_tags[0] === '');
                        default: return false;
                    }
                });
                return searchMatch && categoryMatch;
            });
            
            // ATUALIZADO: Adiciona a ordenação alfabética
            filteredProducts.sort((a, b) => {
                const descA = a.descricao || '';
                const descB = b.descricao || '';
                return descA.localeCompare(descB, 'pt-BR');
            });


            if (!_pagePesquisar.classList.contains('hidden')) {
                if (typeof PesquisarProduto !== 'undefined') {
                    PesquisarProduto.render(filteredProducts);
                }
            }
            if (!_pageEstoque.classList.contains('hidden')) {
                const stockPageProducts = filteredProducts.filter(p => !p.codigo?.startsWith('7'));
                _renderStockPage(stockPageProducts);
            }
            if (!_pageGerenciarSaida.classList.contains('hidden')) {
                const saidaPageProducts = filteredProducts.filter(p => !p.codigo?.startsWith('7')); // Por enquanto, mesma regra do estoque
                _renderSaidaPage(saidaPageProducts);
            }
        }

        function _renderCategoryFilters() {
            const container = _globalCategoryCheckboxesContainer;
            if (!container) return; 
            const categories = {
                consumo: { label: 'Estoque - Consumo', check: p => p.grupo_de_tags_tags?.includes('Estoque - Consumo') },
                fabrica: { label: 'Estoque - Fábrica', check: p => p.grupo_de_tags_tags?.includes('Estoque - Fábrica') },
                terceiros: { label: 'Estoque - Terceiros', check: p => p.grupo_de_tags_tags?.includes('Estoque - Terceiros') },
                demanda: { label: 'Sob Demanda - Fábrica', check: p => p.grupo_de_tags_tags?.includes('Sob Demanda - Fábrica') },
                servicos: { label: 'Serviços', check: p => p.codigo?.startsWith('7') },
                em_branco: { label: 'Grupo de Tags em Branco', check: p => !p.grupo_de_tags_tags || p.grupo_de_tags_tags.length === 0 || (p.grupo_de_tags_tags.length === 1 && p.grupo_de_tags_tags[0] === '') }
            };
            const counts = Object.keys(categories).reduce((acc, key) => { acc[key] = _allProducts.filter(categories[key].check).length; return acc; }, {});
            container.innerHTML = Object.keys(categories).map(key => {
                if (counts[key] === 0) return '';
                return `<label class="flex items-center space-x-3 p-2 rounded-md hover:bg-gray-100 cursor-pointer"><input type="checkbox" class="category-checkbox h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" value="${key}"><span class="flex-grow text-gray-700">${categories[key].label}</span><span class="text-gray-500 text-xs font-mono">(${counts[key]})</span></label>`;
            }).join('');
        }

        function _renderStockSortIcon(column) {
            if (_stockState.sortColumn !== column) return '';
            return _stockState.sortDirection === 'asc' ? '▲' : '▼';
        }

        function _renderReportSortIcon(column) {
            if (_reportState.sortColumn !== column) return '';
            return _reportState.sortDirection === 'asc' ? '▲' : '▼';
        }

        function _renderSaidaSortIcon(column) {
            if (_saidaState.sortColumn !== column) return '';
            return _saidaState.sortDirection === 'asc' ? '▲' : '▼';
        }


        function _createStatusCard(status, title, count, color) {
            return `<div data-status="${status}" class="status-card ${color} text-white p-3 rounded-lg shadow-lg cursor-pointer transform transition-transform duration-300 hover:scale-105 ${status === _stockState.statusFilter ? 'active' : ''}"><h3 class="text-sm font-semibold">${title}</h3><p class="text-2xl font-bold mt-2">${count}</p></div>`;
        }
        
        function _toggleProductSelection(productId, isChecked) {
            if (isChecked) {
                _selectedStockItems.add(productId);
            } else {
                _selectedStockItems.delete(productId);
            }
            _updateSelectedCountDisplay();
        }
        
        function _clearSelection() {
            _selectedStockItems.clear();
            _updateSelectedCountDisplay();
            _applyGlobalFilters(); // Re-renderiza a tabela para desmarcar os checkboxes
        }

        function _updateSelectedCountDisplay() {
            if (_selectedItemsCountDisplay) {
                _selectedItemsCountDisplay.textContent = `Itens selecionados: ${_selectedStockItems.size}`;
            }
            if (_generateReportButton) {
                _generateReportButton.disabled = _selectedStockItems.size === 0;
            }
            if (_clearSelectionBtn) {
                if (_selectedStockItems.size > 0) {
                    _clearSelectionBtn.classList.remove('hidden');
                } else {
                    _clearSelectionBtn.classList.add('hidden');
                }
            }
        }

        function _toggleSaidaSelection(productId, isChecked) {
            if (isChecked) {
                _selectedSaidaItems.add(productId);
            } else {
                _selectedSaidaItems.delete(productId);
            }
            _updateSelectedSaidaCountDisplay();
        }

        function _clearSaidaSelection() {
            _selectedSaidaItems.clear();
            _updateSelectedSaidaCountDisplay();
            _applyGlobalFilters(); // Re-renderiza a tabela para desmarcar os checkboxes
        }

        function _updateSelectedSaidaCountDisplay() {
            if (_selectedSaidaItemsCount) {
                _selectedSaidaItemsCount.textContent = `Itens selecionados: ${_selectedSaidaItems.size}`;
            }
            if (_createSaidaBtn) {
                _createSaidaBtn.disabled = _selectedSaidaItems.size === 0;
            }
            if (_clearSaidaSelectionBtn) {
                _clearSaidaSelectionBtn.classList.toggle('hidden', _selectedSaidaItems.size === 0);
            }
        }
        
        function _calculateAguardandoChegarMap() {
            const aguardandoMap = new Map();
            const allOrderItems = [
                ..._allOrdersTerceiros.flatMap(o => o.rawItems),
                ..._allOrdersFabrica.flatMap(o => o.rawItems)
            ];

            for (const item of allOrderItems) {
                if (item.situacao.toLowerCase() !== 'ok' && item.codigoService) {
                    const currentQty = aguardandoMap.get(item.codigoService) || 0;
                    const itemQty = parseInt(item.quantidadePedido, 10) || 0;
                    aguardandoMap.set(item.codigoService, currentQty + itemQty);
                }
            }
            return aguardandoMap;
        }

        function _renderStockPage(productsToRender) {
            if (!productsToRender) return;

            const aguardandoMap = _calculateAguardandoChegarMap();

            const productsWithStatus = productsToRender.map(p => {
                const aguardandoChegar = aguardandoMap.get(p.codigo) || 0;
                const estoqueAtual = p.estoque ?? 0;
                const estoqueEfetivo = estoqueAtual + aguardandoChegar;

                let status = 'ok';
                if (p.estoque_minimo !== null && estoqueEfetivo <= p.estoque_minimo) status = 'baixo';
                else if (p.estoque_maximo !== null && estoqueEfetivo > p.estoque_maximo) status = 'excesso';
                else if (estoqueAtual < 0) status = 'indefinido';

                return { ...p, stockStatus: status, aguardandoChegar: aguardandoChegar };
            });
            
            const statusFilteredProducts = productsWithStatus.filter(p => _stockState.statusFilter === 'todos' ? true : p.stockStatus === _stockState.statusFilter);
            
            statusFilteredProducts.sort((a, b) => {
                const sortKey = _stockState.sortColumn;
                const valA = a[sortKey];
                const valB = b[sortKey];

                let comparison = 0;
                if (['estoque', 'estoque_minimo', 'estoque_maximo', 'vendas_ultimos_90_dias', 'aguardandoChegar'].includes(sortKey)) {
                    const numA = parseFloat(valA) || 0;
                    const numB = parseFloat(valB) || 0;
                    comparison = numA - numB;
                } else {
                    const strA = String(valA || '').trim();
                    const strB = String(valB || '').trim();
                    comparison = strA.localeCompare(strB, 'pt-BR', { numeric: true });
                }
                
                return _stockState.sortDirection === 'asc' ? comparison : -comparison;
            });

            const totalItems = statusFilteredProducts.length;
            const totalPages = Math.ceil(totalItems / _stockState.itemsPerPage);
            _stockState.currentPage = Math.min(_stockState.currentPage, totalPages) || 1;
            const startIndex = (_stockState.currentPage - 1) * _stockState.itemsPerPage;
            const endIndex = startIndex + _stockState.itemsPerPage;
            const paginatedProducts = statusFilteredProducts.slice(startIndex, endIndex);

            let html = `
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-800">Diagnóstico de Estoque</h1>
                </div>
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-8">
                    ${_createStatusCard('todos', 'Itens Filtrados', productsToRender.length, 'bg-blue-500')}
                    ${_createStatusCard('baixo', 'Estoque Baixo', productsWithStatus.filter(p=>p.stockStatus==='baixo').length, 'bg-yellow-500')}
                    ${_createStatusCard('ok', 'Estoque OK', productsWithStatus.filter(p=>p.stockStatus==='ok').length, 'bg-green-500')}
                    ${_createStatusCard('excesso', 'Excesso de Estoque', productsWithStatus.filter(p=>p.stockStatus==='excesso').length, 'bg-red-500')}
                </div>
                <div class="bg-white rounded-lg shadow-md overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 read-only-disable"><tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                <input type="checkbox" id="select-all-checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" data-sort="descricao">
                                <div class="flex items-center">Produto ${_renderStockSortIcon('descricao')}</div>
                            </th>
                            <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" data-sort="estoque">
                                <div class="flex items-center justify-center">Estoque Atual ${_renderStockSortIcon('estoque')}</div>
                            </th>
                            <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" data-sort="aguardandoChegar">
                                <div class="flex items-center justify-center">Aguardando Chegar ${_renderStockSortIcon('aguardandoChegar')}</div>
                            </th>
                            <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" data-sort="vendas_ultimos_90_dias">
                                <div class="flex items-center justify-center">Vendas 90d ${_renderStockSortIcon('vendas_ultimos_90_dias')}</div>
                            </th>
                            <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Mín / Máx</th>
                            <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        </tr></thead>
                        <tbody class="bg-white divide-y divide-gray-200">`;

            if(paginatedProducts.length === 0) {
                html += `<tr><td colspan="7" class="text-center py-8 text-gray-500">Nenhum item encontrado.</td></tr>`;
            } else {
                paginatedProducts.forEach(p => {
                    const isChecked = _selectedStockItems.has(p.id) ? 'checked' : '';
                    const imageUrl = p.url_imagens_externas && p.url_imagens_externas[0] 
                        ? p.url_imagens_externas[0] 
                        : 'https://placehold.co/50x50/e2e8f0/64748b?text=?';
                    html += `<tr>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <input type="checkbox" class="stock-checkbox h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" data-product-id="${p.id}" ${isChecked}>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <img src="${imageUrl}" 
                                             alt="${p.descricao || 'Imagem do produto'}" 
                                             class="product-list-item-img" 
                                             data-image-url="${imageUrl}"
                                             onerror="this.onerror=null;this.src='https://placehold.co/50x50/e2e8f0/64748b?text=?';">
                                        <div class="ml-4">
                                            <div class="text-sm font-medium text-gray-900">${p.descricao}</div>
                                            <div class="text-sm text-gray-500">${p.codigo}</div>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-bold text-gray-800">${p.estoque ?? 0}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-bold text-blue-600">${p.aguardandoChegar}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-bold text-gray-600">${p.vendas_ultimos_90_dias ?? 0}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500">${p.estoque_minimo ?? 0} / ${p.estoque_maximo ?? 0}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">${createStatusPill(p.stockStatus)}</td>
                            </tr>`;
                });
            }
            html += `</tbody></table></div>
                <!-- Controles de Paginação -->
                <div class="flex items-center justify-between mt-4">
                    <button id="prev-page-btn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">Anterior</button>
                    <span class="text-sm text-gray-700">Página ${_stockState.currentPage} de ${totalPages || 1}</span>
                    <button id="next-page-btn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">Próximo</button>
                </div>
            `;
            _pageEstoque.innerHTML = html;
            
            // Adiciona listeners para os elementos da página de estoque
            const stockTable = _pageEstoque.querySelector('table');
            if (stockTable) {
                stockTable.addEventListener('mouseover', (event) => {
                    if (event.target.classList.contains('product-list-item-img')) {
                        _showProductTooltip(event);
                    }
                });
                stockTable.addEventListener('mouseout', (event) => {
                    if (event.target.classList.contains('product-list-item-img')) {
                        _hideProductTooltip();
                    }
                });
            }

            document.querySelectorAll('.status-card').forEach(card => card.addEventListener('click', () => { _stockState.statusFilter = card.dataset.status; _stockState.currentPage = 1; _applyGlobalFilters(); }));
            document.querySelectorAll('.sortable-header').forEach(header => header.addEventListener('click', () => {
                const sortKey = header.dataset.sort;
                if (_stockState.sortColumn === sortKey) {
                    _stockState.sortDirection = _stockState.sortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    _stockState.sortColumn = sortKey;
                    _stockState.sortDirection = 'asc';
                }
                _applyGlobalFilters();
            }));
            const prevBtn = document.getElementById('prev-page-btn');
            const nextBtn = document.getElementById('next-page-btn');
            if (prevBtn) {
                prevBtn.disabled = _stockState.currentPage === 1;
                prevBtn.addEventListener('click', () => { if(_stockState.currentPage > 1) { _stockState.currentPage--; _applyGlobalFilters(); } });
            }
            if (nextBtn) {
                nextBtn.disabled = _stockState.currentPage === totalPages || totalPages === 0;
                nextBtn.addEventListener('click', () => { if(_stockState.currentPage < totalPages) { _stockState.currentPage++; _applyGlobalFilters(); } });
            }

            document.querySelectorAll('.stock-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', (event) => {
                    _toggleProductSelection(event.target.dataset.productId, event.target.checked);
                });
            });

            const selectAllCheckbox = document.getElementById('select-all-checkbox');
            if (selectAllCheckbox) {
                selectAllCheckbox.addEventListener('change', (event) => {
                    const isChecked = event.target.checked;
                    const currentPaginatedProductIds = paginatedProducts.map(p => p.id);
                    document.querySelectorAll('.stock-checkbox').forEach(checkbox => {
                        if (currentPaginatedProductIds.includes(checkbox.dataset.productId)) { 
                            checkbox.checked = isChecked;
                            _toggleProductSelection(checkbox.dataset.productId, isChecked);
                        }
                    });
                });
            }
            if (selectAllCheckbox) {
                const allCheckboxes = document.querySelectorAll('.stock-checkbox');
                const allVisibleProductIds = paginatedProducts.map(p => p.id);
                const allVisibleChecked = allVisibleProductIds.every(id => _selectedStockItems.has(id));
                selectAllCheckbox.checked = allVisibleChecked && allVisibleProductIds.length > 0;
            }
        }

        function _renderSaidaPage(productsToRender) {
            if (!productsToRender) return;

            productsToRender.sort((a, b) => {
                const sortKey = _saidaState.sortColumn;
                const valA = a[sortKey];
                const valB = b[sortKey];

                let comparison = 0;
                if (['estoque'].includes(sortKey)) {
                    const numA = parseFloat(valA) || 0;
                    const numB = parseFloat(valB) || 0;
                    comparison = numA - numB;
                } else {
                    const strA = String(valA || '').trim();
                    const strB = String(valB || '').trim();
                    comparison = strA.localeCompare(strB, 'pt-BR', { numeric: true });
                }
                
                return _saidaState.sortDirection === 'asc' ? comparison : -comparison;
            });

            const totalItems = productsToRender.length;
            const totalPages = Math.ceil(totalItems / _saidaState.itemsPerPage);
            _saidaState.currentPage = Math.min(_saidaState.currentPage, totalPages) || 1;
            const startIndex = (_saidaState.currentPage - 1) * _saidaState.itemsPerPage;
            const endIndex = startIndex + _saidaState.itemsPerPage;
            const paginatedProducts = productsToRender.slice(startIndex, endIndex);

            let html = `
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-800">Gerenciar Saída de Produtos</h1>
                </div>
                <div class="bg-white rounded-lg shadow-md overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 read-only-disable"><tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">&nbsp;</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" data-sort="descricao">
                                <div class="flex items-center">Produto ${_renderSaidaSortIcon('descricao')}</div>
                            </th>
                            <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" data-sort="estoque">
                                <div class="flex items-center justify-center">Estoque Atual ${_renderSaidaSortIcon('estoque')}</div>
                            </th>
                        </tr></thead>
                        <tbody class="bg-white divide-y divide-gray-200">`;

            if(paginatedProducts.length === 0) {
                html += `<tr><td colspan="3" class="text-center py-8 text-gray-500">Nenhum item encontrado.</td></tr>`;
            } else {
                paginatedProducts.forEach(p => {
                    const isChecked = _selectedSaidaItems.has(p.id) ? 'checked' : '';
                    const imageUrl = p.url_imagens_externas && p.url_imagens_externas[0] 
                        ? p.url_imagens_externas[0] 
                        : 'https://placehold.co/50x50/e2e8f0/64748b?text=?';
                    html += `<tr>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <input type="checkbox" class="saida-checkbox h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" data-product-id="${p.id}" ${isChecked}>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <img src="${imageUrl}" 
                                             alt="${p.descricao || 'Imagem do produto'}" 
                                             class="product-list-item-img" 
                                             data-image-url="${imageUrl}"
                                             onerror="this.onerror=null;this.src='https://placehold.co/50x50/e2e8f0/64748b?text=?';">
                                        <div class="ml-4">
                                            <div class="text-sm font-medium text-gray-900">${p.descricao}</div>
                                            <div class="text-sm text-gray-500">${p.codigo}</div>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-bold text-gray-800">${p.estoque ?? 0}</td>
                            </tr>`;
                });
            }
            html += `</tbody></table></div>
                <!-- Controles de Paginação -->
                <div class="flex items-center justify-between mt-4">
                    <button id="prev-saida-page-btn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">Anterior</button>
                    <span class="text-sm text-gray-700">Página ${_saidaState.currentPage} de ${totalPages || 1}</span>
                    <button id="next-saida-page-btn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">Próximo</button>
                </div>
            `;
            _pageGerenciarSaida.innerHTML = html;
            
            // Adiciona listeners para os elementos da página de saída
            _pageGerenciarSaida.querySelectorAll('.sortable-header').forEach(header => header.addEventListener('click', () => {
                const sortKey = header.dataset.sort;
                if (_saidaState.sortColumn === sortKey) _saidaState.sortDirection = _saidaState.sortDirection === 'asc' ? 'desc' : 'asc';
                else { _saidaState.sortColumn = sortKey; _saidaState.sortDirection = 'asc'; }
                _applyGlobalFilters();
            }));
            _pageGerenciarSaida.querySelectorAll('.saida-checkbox').forEach(cb => cb.addEventListener('change', (e) => _toggleSaidaSelection(e.target.dataset.productId, e.target.checked)));
        }

        function _createRequisitionCard(id, title, count, color) {
            const isActive = id === _ordersTableState.selectedType ? 'active' : '';
            return `<div data-id="${id}" class="status-card ${color} text-white p-3 rounded-lg shadow-lg cursor-pointer transform transition-transform duration-300 hover:scale-105 ${isActive}">
                        <h3 class="text-sm font-semibold">${title}</h3>
                        <p class="text-2xl font-bold mt-2">${count}</p>
                    </div>`;
        }

        // ATUALIZADO: Função para renderizar a página de Diagnóstico de Requisição
        function _renderRequisitionOverviewPage() {
            _ordersTableState.statusFilters.clear();
            if (_ordersFilterButtonLabel) _ordersFilterButtonLabel.textContent = `Filtro (0)`; 
            if (_ordersStatusCheckboxesContainer) _ordersStatusCheckboxesContainer.querySelectorAll('.order-status-checkbox').forEach(cb => cb.checked = false);

            // ATUALIZADO: Calcula a contagem de ITENS PENDENTES, ignorando os já entregues.
            const terceirosItemsCount = _allOrdersTerceiros.reduce((acc, order) => acc + order.totalPendente, 0);
            const fabricaItemsCount = _allOrdersFabrica.reduce((acc, order) => acc + order.totalPendente, 0); 

            let cardsHtml = `
                ${_createRequisitionCard('terceiros', 'Itens Pendentes (Terceiros)', terceirosItemsCount, 'bg-purple-500')}
                ${_createRequisitionCard('fabrica', 'Itens Pendentes (Fábrica)', fabricaItemsCount, 'bg-indigo-500')}
            `;
            if (_requisitionOverviewCardsContainer) _requisitionOverviewCardsContainer.innerHTML = cardsHtml;

            if (_requisitionOverviewCardsContainer) { 
                _requisitionOverviewCardsContainer.querySelectorAll('.status-card').forEach(card => {
                    card.addEventListener('click', () => {
                        _ordersTableState.selectedType = card.dataset.id;
                        _ordersTableState.searchTerm = '';
                        
                        if (_terceirosOrdersModal) _terceirosOrdersModal.classList.remove('hidden');
                        _renderConsolidatedOrdersTable();
                    });
                });
            }
        }

        // NOVO: Renderiza a página de diagnóstico de saídas
        function _renderSaidaOverviewPage() {
            // ATUALIZADO: Usa os dados reais para a contagem
            const fabricaItemsCount = _allSaidasFabrica.reduce((acc, saida) => acc + (saida.totalPendente || 0), 0);
            const garantiaItemsCount = _allSaidasGarantia.reduce((acc, saida) => acc + (saida.totalPendente || 0), 0);

            // Reutiliza a função de criar card para manter o estilo
            let cardsHtml = `
                ${_createRequisitionCard('saidas-fabrica', 'Itens para Fábrica', fabricaItemsCount, 'bg-green-500')}
                ${_createRequisitionCard('saidas-garantia', 'Itens para Garantia', garantiaItemsCount, 'bg-blue-500')}
            `;
            if (_saidaOverviewCards) _saidaOverviewCards.innerHTML = cardsHtml;

            if (_saidaOverviewCards) {
                _saidaOverviewCards.querySelectorAll('.status-card').forEach(card => {
                    card.addEventListener('click', () => {
                        _ordersTableState.selectedType = card.dataset.id;
                        _ordersTableState.searchTerm = '';
                        if (_terceirosOrdersModal) _terceirosOrdersModal.classList.remove('hidden');
                        _renderConsolidatedOrdersTable();
                    });
                });
            }
        }

        function _renderOrderSortIcon(column) {
            if (_ordersTableState.sortColumn !== column) return '';
            return _ordersTableState.sortDirection === 'asc' ? '▲' : '▼';
        }

        function _renderConsolidatedOrdersTable() {
            let ordersToProcess = [];
            let tableTitleSuffix = '';

            // ATUALIZADO: Unifica as opções de impressão para Fábrica e Terceiros
            if (_ordersTableActionPrintGeneric) _ordersTableActionPrintGeneric.classList.add('hidden');
            if (_ordersTableActionPrintList) _ordersTableActionPrintList.classList.remove('hidden');
            if (_ordersTableActionPrintSolicitation) _ordersTableActionPrintSolicitation.classList.remove('hidden');

            if (_ordersTableState.selectedType === 'terceiros') {
                ordersToProcess = _allOrdersTerceiros;
                tableTitleSuffix = ' - Terceiros';
            } else if (_ordersTableState.selectedType === 'fabrica') {
                ordersToProcess = _allOrdersFabrica;
                tableTitleSuffix = ' - Fábrica';
            } else if (_ordersTableState.selectedType === 'saidas-fabrica') {
                ordersToProcess = _allSaidasFabrica;
                tableTitleSuffix = ' - Saídas Fábrica';
            } else if (_ordersTableState.selectedType === 'saidas-garantia') {
                ordersToProcess = _allSaidasGarantia;
                tableTitleSuffix = ' - Saídas Garantia';
            } else { 
                ordersToProcess = [..._allOrdersTerceiros, ..._allOrdersFabrica];
                tableTitleSuffix = ' - Todos';
            }

            if (_ordersTableTitle) _ordersTableTitle.textContent = `Lista de Pedidos${tableTitleSuffix}`;
            // _currentFilteredOrderItems will be populated by _renderOrdersByItemView
            _renderOrdersByItemView(ordersToProcess);
        }

        function _renderOrdersByItemView(orders) {
            let allIndividualItems = orders.flatMap(order => order.rawItems);

            if (allIndividualItems.length === 0) {
                if (_noOrdersMessageModal) _noOrdersMessageModal.classList.remove('hidden'); 
                if (_ordersTableContent) _ordersTableContent.innerHTML = '';
                return; 
            }

            const searchTerm = _normalizeString(_ordersTableState.searchTerm);
            let filteredItems = allIndividualItems.filter(item => {
                return _normalizeString(item.codigoService).includes(searchTerm) ||
                       _normalizeString(item.descricao).includes(searchTerm) ||
                       _normalizeString(item.orderCode).includes(searchTerm); 
            });

            const selectedStatusFilters = [..._ordersTableState.statusFilters];
            // ATUALIZADO: Lógica de filtro de status
            if (selectedStatusFilters.length > 0) {
                // Se houver filtros de status ativos, aplica-os
                filteredItems = filteredItems.filter(item => {
                    const itemStatus = (item.situacao || '').toLowerCase();
                    const isOk = itemStatus === 'ok';
                    
                    let daysOverdue = 0;
                    if (!isOk && item.dataPedido) {
                        const orderDate = _parsePtBrDate(item.dataPedido);
                        if (orderDate) {
                            orderDate.setHours(0,0,0,0);
                            const today = new Date();
                            today.setHours(0,0,0,0);
                            const prazoEntregaDias = parseInt(item.prazoEntregaRaw) || 15; 
                            const deliveryDueDate = addBusinessDays(orderDate, prazoEntregaDias);
                            if (today > deliveryDueDate) {
                                daysOverdue = getBusinessDaysDifference(deliveryDueDate, today);
                            }
                        }
                    }

                    return selectedStatusFilters.some(filter => {
                        switch (filter) {
                            case 'entregues': return isOk;
                            case 'dentro_prazo': return !isOk && daysOverdue === 0;
                            case 'fora_prazo': return !isOk && daysOverdue > 0;
                            default: return false;
                        }
                    });
                });
            } else {
                // Por padrão, se nenhum filtro estiver selecionado, esconde os itens já entregues ('ok')
                filteredItems = filteredItems.filter(item => (item.situacao || '').toLowerCase() !== 'ok');
            }
            
            if (_ordersFilterButtonLabel) _ordersFilterButtonLabel.textContent = `Filtro (${selectedStatusFilters.length})`;

            filteredItems.sort((a, b) => {
                const sortKey = _ordersTableState.sortColumn; 
                let valA, valB;

                if (sortKey === 'dataPedido') {
                    const parseDate = (dateString) => {
                        if (!dateString || dateString === 'N/A') return new Date(0);
                        const [day, month, year] = dateString.split('/');
                        return new Date(year, month - 1, day);
                    };
                    valA = parseDate(a.dataPedido);
                    valB = parseDate(b.dataPedido);
                    return _ordersTableState.sortDirection === 'asc' ? (valA.getTime() - valB.getTime()) : (valB.getTime() - valA.getTime());
                } else if (['quantidadePedido'].includes(sortKey)) {
                    valA = parseInt(a[sortKey]) || 0;
                    valB = parseInt(b[sortKey]) || 0;
                    return _ordersTableState.sortDirection === 'asc' ? (valA - valB) : (valB - valA);
                } else {
                    valA = a[sortKey] || '';
                    valB = b[sortKey] || '';
                }

                const comparison = String(valA).localeCompare(String(valB), 'pt-BR', { numeric: true });
                return _ordersTableState.sortDirection === 'asc' ? comparison : -comparison;
            });

            if (_ordersTableState.selectedType === 'fabrica') {
                _currentModalFabricaOrdersForPrint = filteredItems;
            } else {
                _currentModalFabricaOrdersForPrint = [];
            }

            if (filteredItems.length === 0) {
                if (_noOrdersMessageModal) _noOrdersMessageModal.classList.remove('hidden');
                if (_ordersTableContent) _ordersTableContent.innerHTML = '';
            } else {
                if (_noOrdersMessageModal) _noOrdersMessageModal.classList.add('hidden');
                _currentFilteredOrderItems = filteredItems; // Popula a variável global com os itens filtrados e ordenados

                const showResponsavelColumn = _ordersTableState.selectedType === 'saidas-fabrica' || _ordersTableState.selectedType === 'saidas-garantia';

                const itemDisplayHeaders = [
                    { label: '', sortable: false, key: 'checkbox' },
                    { label: 'REQ.', sortable: true, key: 'orderCode' },
                    { label: 'DESCRIÇÃO / CÓDIGO SERVICE', sortable: true, key: 'descricao' },
                    { label: 'LOCALIZAÇÃO', sortable: false, key: 'localizacao' },
                    { label: 'QTD. PEDIDO', sortable: true, key: 'quantidadePedido' },
                    { label: 'DATA PEDIDO', sortable: true, key: 'dataPedido' }, // Mantido
                    { label: 'PREVISÃO', sortable: false, key: 'dataPrevista' }, // Coluna separada
                    { label: 'RECEBIMENTO', sortable: true, key: 'dataConclusao' }, // Coluna separada
                    { label: 'DIAS ATRASADOS', sortable: false, key: 'diasAtrasados' }, // NOVO
                    { label: 'STATUS', sortable: false, key: 'status' } // RE-ADICIONADO
                ];

                if (showResponsavelColumn) {
                    itemDisplayHeaders.splice(3, 0, { label: 'RESPONSÁVEL', sortable: true, key: 'responsavel' });
                }

                let itemsHtml = `
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 read-only-disable">
                            <tr>
                                ${itemDisplayHeaders.map(header => `
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider ${header.sortable ? 'sortable-header' : ''}" data-sort="${header.key}">
                                        <div class="flex items-center">${header.label} ${header.sortable ? _renderOrderSortIcon(header.key) : ''}</div>
                                    </th>
                                `).join('')}
                            </tr>
                        </thead>
                        <tbody id="orders-table-body-items" class="bg-white divide-y divide-gray-200">`;

                filteredItems.forEach(item => {
                    const itemStatus = (item.situacao || '').toLowerCase();
                    const isOk = itemStatus === 'ok';
                    const orderDate = _parsePtBrDate(item.dataPedido);
                    const prazoEntregaDias = parseInt(item.prazoEntregaRaw) || 15; // Prazo padrão de 15 dias
                    
                    let deliveryDueDate = null;
                    let formattedDueDate = 'N/A';
                    let diasAtrasadosUteis = 0;
                    let diasAtrasadosDisplay = '';
                    let statusHtml = '';
                    let rowClass = 'row-pending';

                    // ATUALIZADO: Lógica condicional para datas
                    if (item.requisitionType === 'saidas-fabrica' || item.requisitionType === 'saidas-garantia') {
                        formattedDueDate = 'N/A';
                        diasAtrasadosDisplay = '-';
                    } else {
                        if (orderDate) {
                            deliveryDueDate = addBusinessDays(orderDate, prazoEntregaDias);
                            formattedDueDate = deliveryDueDate.toLocaleDateString('pt-BR');
                            if (!isOk) {
                                const today = new Date();
                                today.setHours(0, 0, 0, 0);
                                if (today > deliveryDueDate) {
                                    diasAtrasadosUteis = getBusinessDaysDifference(deliveryDueDate, today);
                                }
                            }
                        }
                        diasAtrasadosDisplay = diasAtrasadosUteis > 0 ? diasAtrasadosUteis : (isOk ? '-' : '0');
                        if (!orderDate) diasAtrasadosDisplay = '-';
                    }

                    // --- Lógica de Status e Cor da Linha ---
                    const statusText = (item.situacao && item.situacao.trim() !== '') 
                        ? item.situacao.charAt(0).toUpperCase() + item.situacao.slice(1).toLowerCase() 
                        : 'Pendente';

                    if (itemStatus === 'ok') {
                        statusHtml = _createOrderStatusPill('ok', 'OK');
                        rowClass = 'row-ok';
                    } else { // Para 'PENDENTE' ou qualquer outro status não-OK
                        if (diasAtrasadosUteis > 0) {
                            statusHtml = _createOrderStatusPill('overdue', statusText);
                            rowClass = 'row-overdue';
                        } else {
                            statusHtml = _createOrderStatusPill('pending', statusText);
                            rowClass = 'row-pending';
                        }
                    }


                    const correspondingProduct = _allProducts.find(p => p.codigo === item.codigoService);
                    const imageUrl = correspondingProduct?.url_imagens_externas?.[0] || '';
                    const hasObservation = Array.isArray(item.observacao) && item.observacao.length > 0;
                    const truncatedDescription = item.descricao && item.descricao.length > 50 ? item.descricao.substring(0, 47) + '...' : item.descricao || 'N/A';

                    itemsHtml += `
                        <tr class="${rowClass}">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center space-x-2">
                                    <input type="checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 order-item-checkbox" data-order-code="${item.orderCode}" data-codigo-service="${item.codigoService}" data-requisition-type="${item.requisitionType}" ${isOk ? 'checked disabled' : ''}>
                                    <button class="view-requisition-observation-btn text-gray-500 hover:text-blue-600 p-1 rounded-full" data-order-code="${item.orderCode}" data-codigo-service="${item.codigoService}" title="Visualizar Observações">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                                    </button>
                                    <span class="requisition-observation-status-icon cursor-pointer" data-order-code="${item.orderCode}" data-codigo-service="${item.codigoService}" data-observation='${JSON.stringify(item.observacao || [])}' title="${hasObservation ? 'Este item possui observações' : 'Nenhuma observação'}">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ${hasObservation ? 'text-red-500' : 'text-gray-400'}" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                                        </svg>
                                    </span>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.orderCode}</td>
                            <td class="px-6 py-4 text-sm text-gray-900 max-w-xs overflow-hidden text-ellipsis whitespace-nowrap product-description-cell" data-full-description="${item.descricao || 'N/A'}" data-image-url="${imageUrl}">
                                <strong>${truncatedDescription}</strong><br><span class="text-xs text-gray-500">${item.codigoService || 'N/A'}</span>
                            </td>
                            ${showResponsavelColumn ? `<td class="px-6 py-4 whitespace-nowrap text-sm text-center text-gray-900">${item.responsavel || ''}</td>` : ''}
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-center text-gray-900">${item.localizacao}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-center text-gray-900">${item.quantidadePedido}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-center text-gray-900">${item.dataPedido || 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-center font-medium text-gray-900">${formattedDueDate}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-center font-medium ${isOk ? 'text-green-700 font-bold' : 'text-gray-500'}">${isOk ? (item.dataConclusao || 'Recebido') : 'Pendente'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-center font-bold ${diasAtrasadosUteis > 0 ? 'text-red-600' : 'text-gray-900'}">${diasAtrasadosDisplay}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-center">${statusHtml}</td>
                        </tr>
                    `;
                });
                itemsHtml += `</tbody></table>`;
                if (_ordersTableContent) _ordersTableContent.innerHTML = itemsHtml;

                _ordersTableContent.querySelectorAll('.sortable-header').forEach(header => {
                    header.addEventListener('click', () => {
                        _ordersTableState.sortColumn = header.dataset.sort;
                        _ordersTableState.sortDirection = _ordersTableState.sortDirection === 'asc' ? 'desc' : 'asc';
                        _renderConsolidatedOrdersTable(); 
                    });
                });

                _ordersTableContent.querySelectorAll('.order-item-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', (event) => {
                        const { orderCode, codigoService, requisitionType } = event.target.dataset;
                        _handleItemStatusChange(orderCode, codigoService, requisitionType, event.target);
                    });
                });

                // Adiciona listeners para o tooltip de produto na tabela de pedidos
                const tableBody = _ordersTableContent.querySelector('#orders-table-body-items');
                if (tableBody) {
                    tableBody.addEventListener('mouseover', (event) => {
                        if (event.target.closest('.product-description-cell')) {
                            _showProductTooltip(event);
                        }
                    });
                    tableBody.addEventListener('mouseout', (event) => {
                        if (event.target.closest('.product-description-cell')) {
                            _hideProductTooltip();
                        }
                    });

                    // NOVO: Listeners para observações de requisição
                    tableBody.addEventListener('click', (event) => {
                        const viewBtn = event.target.closest('.view-requisition-observation-btn');
                        if (viewBtn) {
                            const { orderCode, codigoService } = viewBtn.dataset;
                            _openRequisitionObservationModal(orderCode, codigoService);
                        }
                    });

                    tableBody.addEventListener('mouseover', (event) => {
                        const statusIcon = event.target.closest('.requisition-observation-status-icon');
                        if (statusIcon) _showObservationTooltip(event);
                    });

                    tableBody.addEventListener('mouseout', (event) => {
                        const statusIcon = event.target.closest('.requisition-observation-status-icon');
                        if (statusIcon) _hideProductTooltip();
                    });
                }
            }
        }

        function _printOrdersTableDirectly() {
            if (_currentFilteredOrderItems.length === 0) {
                _showMessageModal("Nenhum Item", "Não há itens na tabela para imprimir.");
                return;
            }

            // Reutiliza a mesma área de impressão e CSS do relatório
            const itemsToPrint = _currentFilteredOrderItems;
            const tableTitle = _ordersTableTitle ? _ordersTableTitle.textContent : 'Lista de Pedidos';
            let printHtml = `
                <h1 style="font-size: 16pt; font-weight: bold; text-align: center; margin-bottom: 20px;">${tableTitle}</h1>
                <table class="orders-print-table">
                    <thead>
                        <tr>
                            <th>REQ.</th>
                            <th>PRODUTO</th>
                            <th>LOCAL</th>
                            <th class="text-center-print">QTD</th>
                            <th>SITUAÇÃO</th>
                            <th>DATA</th>
                            <th class="text-center-print">DIAS COR.</th>
                            <th class="text-center-print">PRAZO</th>
                            <th class="text-center-print">ATRASO</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            itemsToPrint.forEach(item => {
                const isOk = (item.situacao || '').toLowerCase() === 'ok';
                let daysOverdue = '0';
                if (!isOk && item.dataPedido) {
                    const orderDate = _parsePtBrDate(item.dataPedido);
                    if (orderDate) {
                        const today = new Date();
                        const prazoEntregaDias = parseInt(item.prazoEntregaRaw) || 15;
                        const deliveryDueDate = addBusinessDays(orderDate, prazoEntregaDias);
                        if (today > deliveryDueDate) {
                            daysOverdue = getBusinessDaysDifference(deliveryDueDate, today);
                        }
                    }
                }
                const correspondingProduct = _allProducts.find(p => p.codigo === item.codigoService);
                const imageUrl = correspondingProduct?.url_imagens_externas?.[0] || 'https://placehold.co/50x50/e2e8f0/64748b?text=?';
                
                const orderDateObj = _parsePtBrDate(item.dataPedido);
                const formattedDate = orderDateObj 
                    ? `${String(orderDateObj.getDate()).padStart(2, '0')}/${String(orderDateObj.getMonth() + 1).padStart(2, '0')}/${String(orderDateObj.getFullYear()).slice(-2)}`
                    : 'N/A';

                printHtml += `
                    <tr>
                        <td>${item.orderCode}</td>
                        <td>
                            <div style="display: flex; align-items: center;">
                                <img src="${imageUrl}" alt="" class="product-list-item-img" onerror="this.style.display='none'">
                                <div style="margin-left: 8px;">
                                    <div style="font-weight: 500;">${item.descricao || 'N/A'}</div>
                                    <div style="font-size: 0.8em; color: #6b7280;">${item.codigoService || 'N/A'}</div>
                                </div>
                            </div>
                        </td>
                        <td>${item.localizacao}</td>
                        <td class="text-center-print">${item.quantidadePedido}</td>
                        <td>${item.situacao}</td>
                        <td>${formattedDate}</td>
                        <td class="text-center-print">${item.diasCorridosRaw || '0'}</td>
                        <td class="text-center-print">${item.prazoEntregaRaw || '15'}</td>
                        <td class="text-center-print">${daysOverdue}</td>
                    </tr>
                `;
            });
            printHtml += `</tbody></table>`;

            if (_printArea) {
                _printArea.innerHTML = printHtml;
                window.print();
                _printArea.innerHTML = ''; // Clear the area after printing
            }
        }

        function _exportOrdersTableToCSV() {
            if (_currentFilteredOrderItems.length === 0) {
                _showMessageModal("Nenhum Item", "Não há itens na tabela para exportar.");
                return;
            }

            const headers = [
                "REQUISIÇÃO", "DESCRIÇÃO", "CÓDIGO SERVICE", "LOCALIZAÇÃO", "QTD. PEDIDO",
                "SITUAÇÃO", "DATA PEDIDO", "DIAS CORRIDOS", "PRAZO ENTREGA", "DIAS ATRASADOS",
                "TIPO REQUISIÇÃO" // Add requisition type for context
            ];
            let csvContent = headers.join(";") + "\n";

            _currentFilteredOrderItems.forEach(item => {
                const isOk = (item.situacao || '').toLowerCase() === 'ok';
                let daysOverdue = '0';
                if (!isOk && item.dataPedido) {
                    const orderDate = _parsePtBrDate(item.dataPedido);
                    if (orderDate) {
                        const today = new Date();
                        const prazoEntregaDias = parseInt(item.prazoEntregaRaw) || 15;
                        const deliveryDueDate = addBusinessDays(orderDate, prazoEntregaDias);
                        if (today > deliveryDueDate) {
                            daysOverdue = getBusinessDaysDifference(deliveryDueDate, today);
                        }
                    }
                }

                const escapeCSV = (field) => `"${String(field || '').replace(/"/g, '""')}"`;

                const row = [
                    escapeCSV(item.orderCode),
                    escapeCSV(item.descricao),
                    escapeCSV(item.codigoService),
                    escapeCSV(item.localizacao),
                    item.quantidadePedido,
                    escapeCSV(item.situacao),
                    escapeCSV(item.dataPedido),
                    item.diasCorridosRaw || '0',
                    item.prazoEntregaRaw || '15',
                    daysOverdue,
                    escapeCSV(item.requisitionType)
                ].join(";");
                csvContent += row + "\n";
            });

            const blob = new Blob([`\uFEFF${csvContent}`], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "lista_pedidos.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function _handleItemStatusChange(orderCode, codigoService, requisitionType, checkboxElement) {
            if (!checkboxElement.checked) {
                if (checkboxElement.disabled) { 
                    checkboxElement.checked = true;
                    _showMessageModal("Item Já Entregue", "Este item já foi marcado como 'Entregue' e não pode ser desmarcado.");
                }
                return;
            }

            // ATUALIZADO: Mensagem de confirmação dinâmica com campo de quantidade para devoluções
            const isSaida = requisitionType.startsWith('saida');
            const item = _findRequisitionItem(orderCode, codigoService);
            if (!item) {
                _showMessageModal("Erro", "Item não encontrado para processar a operação.");
                checkboxElement.checked = false;
                return;
            }

            const originalQuantity = item.quantidadePedido || 1;
            let confirmationTitle = isSaida ? "Confirmar Devolução" : "Confirmar Entrega";
            let confirmationMessage = isSaida 
                ? `
                    <p>Confirmar a devolução do item ao estoque?</p>
                    <div class="mt-4 text-left">
                        <label for="devolucao-quantity-input" class="block text-sm font-medium text-gray-700">Quantidade a ser devolvida:</label>
                        <input type="number" id="devolucao-quantity-input" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" value="${originalQuantity}" min="1">
                    </div>
                `
                : "Deseja marcar o item como 'Entregue' (OK)?";

            const confirmed = await _showConfirmationModal(confirmationTitle, confirmationMessage);
            if (!confirmed) {
                checkboxElement.checked = false;
                return;
            }

            const parentDiv = checkboxElement.parentElement;
            const spinner = document.createElement('div');
            spinner.className = 'w-4 h-4 border-2 border-gray-400 border-t-blue-500 rounded-full spinning';
            
            checkboxElement.style.display = 'none';
            if(parentDiv) parentDiv.insertBefore(spinner, checkboxElement);

            try {
                const product = _allProducts.find(p => p.codigo === codigoService);
                if (!product) throw new Error("Produto correspondente não encontrado localmente.");

                // DEBUG: Imprime os valores brutos para análise, conforme solicitado.
                console.log('--- DEBUG: Valores para cálculo de estoque ---');
                console.log(`Estoque Atual (product.estoque): '${product.estoque}' (tipo: ${typeof product.estoque})`);
                console.log(`Qtd. Requisição (item.quantidadePedido): '${item.quantidadePedido}' (tipo: ${typeof item.quantidadePedido})`);
                console.log('-------------------------------------------');

                // 2. Preparar o payload combinado para a Cloud Function
                // CORREÇÃO DEFINITIVA: Lógica de parse robusta para tratar números formatados como texto (ex: "1.234,56" ou "2,00").
                // 1. Converte para string.
                // 2. Remove pontos de milhar.
                // 3. Troca a vírgula decimal por ponto.
                // 4. Converte para número.
                let quantidadeMovimento;
                if (isSaida) {
                    const inputQty = document.getElementById('devolucao-quantity-input')?.value;
                    quantidadeMovimento = parseFloat(String(inputQty || '0').replace(/\./g, '').replace(',', '.')) || 0;
                } else {
                    quantidadeMovimento = parseFloat(String(item.quantidadePedido || '0').replace(/\./g, '').replace(',', '.')) || 0;
                }

                const estoqueAtualBruto = parseFloat(String(product.estoque || '0').replace(/\./g, '').replace(',', '.')) || 0;
                // CORREÇÃO: Usa o valor absoluto do estoque para corrigir o problema de valores negativos inesperados.
                const estoqueAtual = Math.abs(estoqueAtualBruto);
                const quantidadeFinal = estoqueAtual + quantidadeMovimento; // A operação é sempre de entrada no estoque

                // ATUALIZADO: Define o tipo de entrada e observação com base no tipo de requisição
                let tipoEntrada = '';
                let observacoes = `Recebimento referente à requisição ${orderCode}`;

                if (requisitionType === 'saidas-fabrica') {
                    tipoEntrada = 'Devolução - Fábrica';
                    observacoes = `Devolução de item da fabrica - Responsável: ${item.responsavel || 'N/A'}`;
                } else if (requisitionType === 'saidas-garantia') {
                    tipoEntrada = 'Devolução - Garantia';
                    observacoes = `Devolução de item de garantia - Responsável: ${item.responsavel || 'N/A'}`;
                } else { // Requisições de compra
                    tipoEntrada = requisitionType === 'fabrica' ? 'Recebimento da Fábrica' : 'Recebimento de Terceiros';
                }

                const today = new Date();
                const formattedDate = `${String(today.getDate()).padStart(2, '0')}/${String(today.getMonth() + 1).padStart(2, '0')}/${today.getFullYear()}`;

                // ATUALIZADO: Payload combinado com todos os dados no nível raiz, conforme a necessidade da API.
                const payload = {
                    // Dados para o Bling (formato principal)
                    produto: {
                        id: product.id,
                        codigo: product.codigo
                    },
                    operacaoBling: "E",
                    quantidadeMovimento: quantidadeMovimento,
                    quantidadeFinal: quantidadeFinal,
                    tipoEntrada: tipoEntrada,
                    observacoes: observacoes,

                    // Dados para a Planilha (agora no nível raiz)
                    orderCode: orderCode,
                    codigoService: codigoService, // Adicionado conforme erro da API
                    newStatus: 'OK', // ATUALIZADO: Para 'OK' maiúsculo, conforme exemplo funcional
                    requisitionType: requisitionType,
                    dataEntrega: formattedDate,
                    diasCorridos: item?.diasCorridosRaw || '0'
                };

                // ATENDENDO AO PEDIDO: Imprime o JSON que será enviado para o backend.
                console.log('--- JSON a ser enviado para o backend ---');
                console.log(JSON.stringify(payload, null, 2));
                console.log('---------------------------------------');

                // 3. Enviar a requisição para a API
                const response = await fetch(ORDERS_UPDATE_API_URL, {
                    method: 'POST', mode: 'cors', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Erro na API (Status: ${response.status}): ${errorText}`);
                }

                // 4. Atualizar os dados locais e a interface
                if (item) {
                    item.situacao = 'ok';
                    item.dataConclusao = formattedDate;
                    
                    // ATUALIZAÇÃO: Encontra o pedido pai e ajusta os contadores de itens pendentes/atendidos.
                    let ordersArray;
                    if (requisitionType === 'terceiros') ordersArray = _allOrdersTerceiros;
                    else if (requisitionType === 'fabrica') ordersArray = _allOrdersFabrica;
                    else if (requisitionType === 'saidas-fabrica') ordersArray = _allSaidasFabrica;
                    else if (requisitionType === 'saidas-garantia') ordersArray = _allSaidasGarantia;
                    else ordersArray = [];

                    const order = ordersArray.find(o => o.orderCode === orderCode);
                    if (order) {
                        order.totalPendente = Math.max(0, order.totalPendente - 1);
                        order.totalAtendido++;
                    }
                }
                if (product) { product.estoque = quantidadeFinal; }
                
                // Re-renderiza a tabela do modal para refletir a mudança do item
                _renderConsolidatedOrdersTable();
                // ATUALIZAÇÃO: Re-renderiza os cards da página de diagnóstico para atualizar a contagem
                if (isSaida) _renderSaidaOverviewPage(); else _renderRequisitionOverviewPage();

                _showMessageModal("Sucesso!", isSaida ? "Item devolvido ao estoque com sucesso." : "Item marcado como 'Entregue' e estoque atualizado.");
            } catch (error) {
                _showMessageModal("Erro na Atualização", `Falha ao processar a operação: ${error.message}.`);
                checkboxElement.checked = false; 
            } finally {
                // A re-renderização da tabela já cuida de remover o spinner, mas garantimos aqui por segurança.
                if (spinner && spinner.parentElement) spinner.remove();
                if (checkboxElement) checkboxElement.style.display = 'block';
            }
        }

        function _handleIntelligentToggleChange(event) {
            _reportState.isIntelligentMode = event.target.checked;
            // Limpa as quantidades existentes para forçar o recálculo de todos os itens
            _reportQuantities.clear();
            _generateReport();
        }

        // ATUALIZADO: Lida com o clique nos botões de lançamento da tela de "Criar Saída"
        async function _handleLaunchSaida(type) {
             const itemsToLaunch = Array.from(_saidaReportQuantities.entries())
                 .filter(([productId, qty]) => qty > 0)
                 .map(([productId, qty]) => {
                     const product = _allProducts.find(p => p.id === productId);
                     return { product, quantity: qty };
                 });
 
             if (itemsToLaunch.length === 0) {
                 _showMessageModal("Nenhum Item", "Por favor, defina a quantidade para ao menos um item.");
                 return;
             }
 
             const itemsWithInsufficientStock = itemsToLaunch
                 .filter(item => item.quantity > item.product.estoque)
                 .map(item => item.product.descricao);
 
             if (itemsWithInsufficientStock.length > 0) {
                 const confirmationMessage = `
                     <p class="mb-2">Os seguintes itens têm quantidade de saída maior que o estoque:</p>
                     <ul class="list-disc list-inside text-left mb-4">${itemsWithInsufficientStock.map(name => `<li>${name}</li>`).join('')}</ul>
                     <p>Deseja continuar mesmo assim?</p>`;
                 const confirmed = await _showConfirmationModal("Estoque Insuficiente", confirmationMessage);
                 if (!confirmed) return;
             }
 
            if (type === 'garantia') {
                const today = new Date();
                const ddmmaa = `${String(today.getDate()).padStart(2, '0')}${String(today.getMonth() + 1).padStart(2, '0')}${String(today.getFullYear()).slice(-2)}`;
                const todayStr = today.toLocaleDateString('pt-BR');
                const saidasTodayCodes = new Set(
                    [..._allSaidasFabrica, ..._allSaidasGarantia]
                        .filter(s => {
                            const parsedDate = _parsePtBrDate(s.dataPedido);
                            return parsedDate && parsedDate.toLocaleDateString('pt-BR') === todayStr;
                        })
                        .map(s => s.orderCode)
                );
                const nextSequence = saidasTodayCodes.size + 1;
                const requisitionCode = `${ddmmaa}-${nextSequence}`;

                const confirmationMessage = `
                    <p>Confirmar o lançamento de <b>${itemsToLaunch.length}</b> itens para a Garantia?</p>
                    <p class="mt-2">Será gerada a requisição de saída: <b>${requisitionCode}</b>.</p>
                    <div class="mt-4 text-left">
                        <label for="saida-responsavel-input" class="block text-sm font-medium text-gray-700">Responsável:</label>
                        <input type="text" id="saida-responsavel-input" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Nome do responsável">
                    </div>
                `;
                const confirmed = await _showConfirmationModal("Confirmar Lançamento de Saída", confirmationMessage);
                if (!confirmed) return;

                const responsavel = document.getElementById('saida-responsavel-input')?.value.trim() || '';
                if (!responsavel) {
                    _showMessageModal("Campo Obrigatório", "Por favor, preencha o nome do responsável.");
                    return;
                }

                const todayForPayload = `${String(today.getDate()).padStart(2, '0')}/${String(today.getMonth() + 1).padStart(2, '0')}/${today.getFullYear()}`;
                const payloadData = itemsToLaunch.map(item => ({
                    requisicao: requisitionCode, codigo_service: item.product.codigo || '', codigo_mks_equipamentos: '',
                    descricao: item.product.descricao || '', localizacao: item.product.localizacao || '', quantidade: item.quantity,
                    situacao: 'Pendente', data_pedido: todayForPayload, data_envio: '', observacao: [], responsavel: responsavel
                }));

                _loadingOverlay.classList.remove('hidden');
                try {
                    const response = await fetch(SAIDA_GARANTIA_LAUNCH_URL, { method: 'POST', mode: 'cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ data: payloadData }) });
                    if (!response.ok) { const errorText = await response.text(); throw new Error(`Erro na API (Status: ${response.status}): ${errorText}`); }
                    await response.json();

                    const newSaida = {
                        orderCode: requisitionCode, dataPedido: payloadData[0].data_pedido, totalItems: payloadData.length, totalAtendido: 0, totalPendente: payloadData.length,
                        rawItems: payloadData.map(item => ({ orderCode: item.requisicao, codigoService: item.codigo_service, descricao: item.descricao, localizacao: item.localizacao, quantidadePedido: item.quantidade, situacao: 'pendente', dataPedido: item.data_pedido, dataConclusao: null, observacao: [], responsavel: item.responsavel, requisitionType: 'saidas-garantia' }))
                    };
                    _allSaidasGarantia.push(newSaida);

                    itemsToLaunch.forEach(item => {
                        if (item.product) {
                            const currentStock = parseFloat(String(item.product.estoque || '0').replace(/\./g, '').replace(',', '.')) || 0;
                            const quantityToDebit = parseFloat(String(item.quantity || '0').replace(/\./g, '').replace(',', '.')) || 0;
                            item.product.estoque = currentStock - quantityToDebit;
                        }
                    });

                    _showMessageModal("Sucesso!", `Saída para garantia lançada com a requisição <b>${requisitionCode}</b>.`);
                    _selectedSaidaItems.clear(); _saidaReportQuantities.clear(); _updateSelectedSaidaCountDisplay(); _showPage('gerenciar-saida');
                } catch (error) { _showMessageModal("Erro no Lançamento", `Falha ao lançar saída: ${error.message}.`); } finally { _loadingOverlay.classList.add('hidden'); }
                return;
             }
 
             if (type === 'fabrica') {
                 const today = new Date();
                 const ddmmaa = `${String(today.getDate()).padStart(2, '0')}${String(today.getMonth() + 1).padStart(2, '0')}${String(today.getFullYear()).slice(-2)}`;
                 const todayStr = today.toLocaleDateString('pt-BR');
                 const saidasTodayCodes = new Set(
                    [..._allSaidasFabrica, ..._allSaidasGarantia]
                        .filter(s => {
                            const parsedDate = _parsePtBrDate(s.dataPedido);
                            return parsedDate && parsedDate.toLocaleDateString('pt-BR') === todayStr;
                        })
                        .map(s => s.orderCode)
                );
                 const nextSequence = saidasTodayCodes.size + 1;
                 const requisitionCode = `${ddmmaa}-${nextSequence}`;
 
                 const confirmationMessage = `
                    <p>Confirmar o lançamento de <b>${itemsToLaunch.length}</b> itens para a Fábrica?</p>
                    <p class="mt-2">Será gerada a requisição de saída: <b>${requisitionCode}</b>.</p>
                    <div class="mt-4 text-left">
                        <label for="saida-responsavel-input" class="block text-sm font-medium text-gray-700">Responsável:</label>
                        <input type="text" id="saida-responsavel-input" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Nome do responsável">
                    </div>
                 `;
                 const confirmed = await _showConfirmationModal("Confirmar Lançamento de Saída", confirmationMessage);
                 if (!confirmed) return;
 
                 const responsavel = document.getElementById('saida-responsavel-input')?.value.trim() || '';
                 if (!responsavel) {
                     _showMessageModal("Campo Obrigatório", "Por favor, preencha o nome do responsável.");
                     return;
                 }

                 const todayForPayload = `${String(today.getDate()).padStart(2, '0')}/${String(today.getMonth() + 1).padStart(2, '0')}/${today.getFullYear()}`;
                 const payloadData = itemsToLaunch.map(item => ({
                     requisicao: requisitionCode, codigo_service: item.product.codigo || '', codigo_mks_equipamentos: '',
                     descricao: item.product.descricao || '', localizacao: item.product.localizacao || '', quantidade: item.quantity,
                     situacao: 'Pendente', data_pedido: todayForPayload, data_envio: '', observacao: [], responsavel: responsavel
                 }));
 
                 _loadingOverlay.classList.remove('hidden');
                 try {
                     const response = await fetch(SAIDA_FABRICA_LAUNCH_URL, { method: 'POST', mode: 'cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ data: payloadData }) });
                     if (!response.ok) { const errorText = await response.text(); throw new Error(`Erro na API (Status: ${response.status}): ${errorText}`); }
                     await response.json();

                     // ATUALIZADO: Atualiza os dados locais em vez de fazer um novo fetch
                     const newSaida = {
                         orderCode: requisitionCode,
                         dataPedido: payloadData[0].data_pedido,
                         totalItems: payloadData.length,
                         totalAtendido: 0,
                         totalPendente: payloadData.length,
                         rawItems: payloadData.map(item => ({
                             orderCode: item.requisicao,
                             codigoService: item.codigo_service,
                             descricao: item.descricao,
                             localizacao: item.localizacao,
                             quantidadePedido: item.quantidade,
                             situacao: 'pendente',
                             dataPedido: item.data_pedido,
                             dataConclusao: null,
                             observacao: [],
                             responsavel: item.responsavel,
                             requisitionType: 'saidas-fabrica'
                         }))
                     };
                     _allSaidasFabrica.push(newSaida);

                     // NOVO: Debita o estoque dos produtos no frontend
                     itemsToLaunch.forEach(item => {
                         if (item.product) {
                             // Garante que o estoque seja tratado como número
                             const currentStock = parseFloat(String(item.product.estoque || '0').replace(/\./g, '').replace(',', '.')) || 0;
                             const quantityToDebit = parseFloat(String(item.quantity || '0').replace(/\./g, '').replace(',', '.')) || 0;
                             item.product.estoque = currentStock - quantityToDebit;
                         }
                     });

                     _showMessageModal("Sucesso!", `Saída para fábrica lançada com a requisição <b>${requisitionCode}</b>.`);
                     _selectedSaidaItems.clear();
                     _saidaReportQuantities.clear();
                     _updateSelectedSaidaCountDisplay();
                     _showPage('gerenciar-saida');
                 } catch (error) {
                     _showMessageModal("Erro no Lançamento", `Falha ao lançar saída: ${error.message}.`);
                 } finally {
                     _loadingOverlay.classList.add('hidden');
                 }
             }
        }
 // NOVO: Atualiza a quantidade de um item no relatório de saída
        function _updateSaidaReportQuantity(productId, newQuantity) {
            const parsedQuantity = parseInt(newQuantity, 10);
            if (!isNaN(parsedQuantity) && parsedQuantity >= 0) {
                _saidaReportQuantities.set(productId, parsedQuantity);
            } else {
                _saidaReportQuantities.set(productId, 0);
            }
            _updateSaidaReportActionButtonsState();
        }

        // NOVO: Atualiza o estado dos botões de ação do relatório de saída
        function _updateSaidaReportActionButtonsState() {
            const hasItems = Array.from(_saidaReportQuantities.values()).some(qty => qty > 0);
            if (_launchSaidaGarantiaBtn) _launchSaidaGarantiaBtn.disabled = !hasItems;
            if (_launchSaidaFabricaBtn) _launchSaidaFabricaBtn.disabled = !hasItems;
        }

        // NOVO: Gera o relatório para a tela de "Criar Saída"
        function _generateSaidaReport() {
            if (_selectedSaidaItems.size === 0) {
                _showMessageModal("Nenhum Item Selecionado", "Por favor, selecione ao menos um item para criar a saída.");
                return;
            }
            const selectedProducts = _allProducts.filter(p => _selectedSaidaItems.has(p.id));

            // Lógica de ordenação (simplificada para o relatório de saída)
            selectedProducts.sort((a, b) => {
                const sortKey = _saidaReportState.sortColumn;
                const valA = a[sortKey] || '';
                const valB = b[sortKey] || '';
                const comparison = String(valA).localeCompare(String(valB), 'pt-BR', { numeric: true });
                return _saidaReportState.sortDirection === 'asc' ? comparison : -comparison;
            });

            // Inicializa as quantidades se não existirem
            selectedProducts.forEach(p => {
                if (!_saidaReportQuantities.has(p.id)) {
                    _saidaReportQuantities.set(p.id, 1); // Padrão 1 para saída
                }
            });

            // Remove itens do mapa de quantidades que não estão mais selecionados
            _saidaReportQuantities.forEach((value, key) => {
                if (!_selectedSaidaItems.has(key)) _saidaReportQuantities.delete(key);
            });

            _updateSaidaReportActionButtonsState();

            let reportContentHtml = `
                <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Criar Saída de Estoque</h1>
                <div class="bg-white rounded-lg shadow-md overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                                <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-full sortable-header" data-sort="descricao">Produto</th>
                                <th scope="col" class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" data-sort="estoque">Estoque</th>
                                <th scope="col" class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Qtd. Saída</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
            `;
            selectedProducts.forEach(p => {
                const currentQuantity = _saidaReportQuantities.get(p.id) || 0;
                const imageUrl = p.url_imagens_externas?.[0] || 'https://placehold.co/50x50/e2e8f0/64748b?text=?';
                reportContentHtml += `
                    <tr data-product-id="${p.id}">
                        <td class="px-4 py-2 whitespace-nowrap text-center text-xs font-medium">
                            <button class="remove-saida-item-btn text-red-600 hover:text-red-800 p-1 rounded-full" title="Remover item" data-product-id="${p.id}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                            </button>
                        </td>
                        <td class="px-4 py-2 whitespace-nowrap">
                            <div class="flex items-center">
                                <img src="${imageUrl}" alt="${p.descricao || 'Imagem do produto'}" class="product-list-item-img" data-image-url="${imageUrl}" onerror="this.onerror=null;this.src='https://placehold.co/50x50/e2e8f0/64748b?text=?';">
                                <div class="ml-4">
                                    <div class="text-xs font-medium text-gray-900">${p.descricao}</div>
                                    <div class="text-xs text-gray-500">${p.codigo}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-4 py-2 whitespace-nowrap text-center text-xs font-bold text-gray-800">${p.estoque ?? 0}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-center text-xs font-medium">
                            <input type="number" value="${currentQuantity}" data-product-id="${p.id}" class="w-20 px-2 py-1 border border-gray-300 rounded-md text-center text-xs saida-report-quantity-input" min="0">
                        </td>
                    </tr>
                `;
            });
            reportContentHtml += `</tbody></table></div>`;

            if (_pageSaidaReportContent) _pageSaidaReportContent.innerHTML = reportContentHtml;
            _showPage('saida-report');

            // Adiciona listeners
            _pageSaidaReportContent.querySelectorAll('.remove-saida-item-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const productIdToRemove = event.currentTarget.dataset.productId;
                    _selectedSaidaItems.delete(productIdToRemove);
                    _saidaReportQuantities.delete(productIdToRemove);
                    _generateSaidaReport();
                    _updateSelectedSaidaCountDisplay();
                });
            });
            _pageSaidaReportContent.querySelectorAll('.saida-report-quantity-input').forEach(input => {
                input.addEventListener('input', (event) => {
                    _updateSaidaReportQuantity(event.target.dataset.productId, event.target.value);
                });
            });
        }
        // NOVO: Função para atualizar o estado dos botões de ação do relatório
        function _updateReportActionButtonsState() {
            const hasFabricaItems = Array.from(_reportQuantities.entries()).some(([productId, qty]) => {
                if (qty <= 0) return false;
                const product = _allProducts.find(p => p.id === productId);
                return product?.codigo?.startsWith('6');
            });

            const hasTerceirosItems = Array.from(_reportQuantities.entries()).some(([productId, qty]) => {
                if (qty <= 0) return false;
                const product = _allProducts.find(p => p.id === productId);
                return !product?.codigo?.startsWith('6');
            });

            if (_reportLaunchTerceirosBtn) _reportLaunchTerceirosBtn.disabled = !hasTerceirosItems;
            if (_reportLaunchFabricaBtn) _reportLaunchFabricaBtn.disabled = !hasFabricaItems;
        }

        function _prepareRequisition() {
            if (_selectedStockItems.size === 0) {
                _showMessageModal("Nenhum Item Selecionado", "Por favor, selecione ao menos um item para gerar o relatório.");
                return;
            }
            const selectedProducts = _allProducts.filter(p => _selectedStockItems.has(p.id));
            const aguardandoMap = _calculateAguardandoChegarMap();

            // Lógica de ordenação
            selectedProducts.sort((a, b) => {
                const sortKey = _reportState.sortColumn;
                let valA, valB;

                if (sortKey === 'aguardandoChegar') {
                    valA = aguardandoMap.get(a.codigo) || 0;
                    valB = aguardandoMap.get(b.codigo) || 0;
                } else if (['estoque', 'estoque_minimo', 'estoque_maximo', 'vendas_ultimos_90_dias'].includes(sortKey)) {
                    valA = a[sortKey] || 0;
                    valB = b[sortKey] || 0;
                } else if (sortKey === 'quantidadeRequisitar') {
                    valA = _reportQuantities.get(a.id) || 0;
                    valB = _reportQuantities.get(b.id) || 0;
                } else { // Default para comparação de string (ex: 'descricao')
                    valA = a[sortKey] || '';
                    valB = b[sortKey] || '';
                }

                let comparison = 0;
                if (typeof valA === 'number' && typeof valB === 'number') {
                    comparison = valA - valB;
                } else {
                    comparison = String(valA).localeCompare(String(valB), 'pt-BR', { numeric: true });
                }

                return _reportState.sortDirection === 'asc' ? comparison : -comparison;
            });
            
            selectedProducts.forEach(p => {
                if (!_reportQuantities.has(p.id)) {
                    let initialQty = 0;
                    if (_reportState.isIntelligentMode) {
                        // --- CÁLCULO INTELIGENTE (ATÉ FIM DO ANO + ESTOQUE MÍNIMO) ---
                        const estoqueMin = p.estoque_minimo || 0; // Adicionado: estoque mínimo
                        const vendas90d = p.vendas_ultimos_90_dias || 0;
                        const estoqueAtual = p.estoque || 0;
                        const aguardandoChegar = aguardandoMap.get(p.codigo) || 0;
                        const estoqueEfetivo = estoqueAtual + aguardandoChegar;

                        const avgDailySales = vendas90d / 90;

                        const today = new Date();
                        const endOfYear = new Date(today.getFullYear(), 11, 31); // 31 de Dezembro
                        const timeDiff = endOfYear.getTime() - today.getTime();
                        const daysRemaining = Math.max(0, Math.ceil(timeDiff / (1000 * 3600 * 24)));

                        const demandUntilYearEnd = avgDailySales * daysRemaining;
                        const targetStock = demandUntilYearEnd + estoqueMin; // O alvo é a demanda + o estoque de segurança
                        const calculatedQty = targetStock - estoqueEfetivo;
                        initialQty = Math.round(Math.max(0, calculatedQty));

                    } else {
                        // --- CÁLCULO PADRÃO (REQUISIÇÃO MENSAL BASEADA EM VENDAS) ---
                        const estoqueMin = p.estoque_minimo || 0; // Adicionado: estoque mínimo
                        const vendas90d = p.vendas_ultimos_90_dias || 0;
                        const estoqueAtual = p.estoque || 0;
                        const aguardandoChegar = aguardandoMap.get(p.codigo) || 0;
                        const estoqueEfetivo = estoqueAtual + aguardandoChegar;

                        // Calcula a média de vendas mensais (90 dias = 3 meses)
                        const avgMonthlySales = vendas90d / 3;

                        // A quantidade a requisitar é o que falta para atingir o estoque mínimo
                        // MAIS a demanda mensal, considerando o estoque efetivo.
                        const targetStock = estoqueMin + avgMonthlySales;
                        let calculatedQty = targetStock - estoqueEfetivo;

                        // Garante que a quantidade não seja negativa
                        initialQty = Math.round(Math.max(0, calculatedQty));
                    }
                    _reportQuantities.set(p.id, initialQty);
                }
            });

            _reportQuantities.forEach((value, key) => {
                if (!_selectedStockItems.has(key)) _reportQuantities.delete(key);
            });

            _updateReportActionButtonsState();

            let reportContentHtml = `
                <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Preparar Requisição para Lançamento</h1>
                <!-- NOVO: Alternador de cálculo de requisição -->
                <div class="flex items-center justify-end mb-4">
                    <label for="intelligent-requisition-toggle" class="flex items-center cursor-pointer">
                        <span class="mr-3 text-sm font-medium text-gray-700">Requisição Padrão</span>
                        <div class="relative">
                            <input type="checkbox" id="intelligent-requisition-toggle" class="sr-only peer" ${_reportState.isIntelligentMode ? 'checked' : ''}>
                            <div class="w-14 h-8 bg-gray-300 rounded-full peer peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-1 after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-blue-600"></div>
                        </div>
                        <span class="ml-3 text-sm font-medium text-gray-700">Requisição Inteligente (Até Fim do Ano)</span>
                    </label>
                </div>
                <div class="bg-white rounded-lg shadow-md overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 read-only-disable">
                            <tr>
                                <th scope="col" class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                                <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-full sortable-header" data-sort="descricao">Produto ${_renderReportSortIcon('descricao')}</th>
                                <th scope="col" class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" data-sort="estoque">Estoque ${_renderReportSortIcon('estoque')}</th>
                                <th scope="col" class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" data-sort="aguardandoChegar">Aguardando Chegar ${_renderReportSortIcon('aguardandoChegar')}</th>
                                <th scope="col" class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" data-sort="estoque_minimo">Mín/Máx ${_renderReportSortIcon('estoque_minimo')}</th>
                                <th scope="col" class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" data-sort="vendas_ultimos_90_dias">Vendas 90d ${_renderReportSortIcon('vendas_ultimos_90_dias')}</th>
                                <th scope="col" class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" data-sort="quantidadeRequisitar">Qtd. a Requisitar ${_renderReportSortIcon('quantidadeRequisitar')}</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
            `;
            selectedProducts.forEach(p => {
                const currentQuantity = _reportQuantities.get(p.id) || 0;
                const aguardandoChegar = aguardandoMap.get(p.codigo) || 0;
                const imageUrl = p.url_imagens_externas && p.url_imagens_externas[0] 
                    ? p.url_imagens_externas[0] 
                    : 'https://placehold.co/50x50/e2e8f0/64748b?text=?';
                reportContentHtml += `
                    <tr data-product-id="${p.id}">
                        <td class="px-4 py-2 whitespace-nowrap text-center text-xs font-medium">
                            <button class="remove-item-btn text-red-600 hover:text-red-800 p-1 rounded-full" title="Remover item" data-product-id="${p.id}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                            </button>
                        </td>
                        <td class="px-4 py-2 whitespace-nowrap">
                            <div class="flex items-center">
                                <img src="${imageUrl}"
                                     alt="${p.descricao || 'Imagem do produto'}"
                                     class="product-list-item-img"
                                     data-image-url="${imageUrl}"
                                     onerror="this.onerror=null;this.src='https://placehold.co/50x50/e2e8f0/64748b?text=?';">
                                <div class="ml-4">
                                    <div class="text-xs font-medium text-gray-900">${p.descricao}</div>
                                    <div class="text-xs text-gray-500">${p.codigo}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-4 py-2 whitespace-nowrap text-center text-xs font-bold text-gray-800">${p.estoque ?? 0}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-center text-xs font-bold text-blue-600">${aguardandoChegar}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-center text-xs text-gray-500">${p.estoque_minimo ?? 0} / ${p.estoque_maximo ?? 0}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-center text-xs font-bold text-gray-600">${p.vendas_ultimos_90_dias ?? 0}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-center text-xs font-medium">
                            <input type="number" value="${currentQuantity}" data-product-id="${p.id}" class="report-quantity-input w-20 px-2 py-1 border border-gray-300 rounded-md text-center text-xs" min="0">
                        </td>
                    </tr>
                `;
            });
            reportContentHtml += `</tbody></table></div>`;

            if (_pageReportContent) _pageReportContent.innerHTML = reportContentHtml; 
            _showPage('report'); 

            _pageReportContent.querySelectorAll('.remove-item-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const productIdToRemove = event.currentTarget.dataset.productId;
                    _selectedStockItems.delete(productIdToRemove); 
                    _reportQuantities.delete(productIdToRemove); 
                    _generateReport(); 
                    _updateSelectedCountDisplay(); 
                });
            });

            // Adiciona listeners para os cabeçalhos ordenáveis do relatório
            _pageReportContent.querySelectorAll('.sortable-header').forEach(header => {
                header.addEventListener('click', () => {
                    const sortKey = header.dataset.sort;
                    if (_reportState.sortColumn === sortKey) {
                        _reportState.sortDirection = _reportState.sortDirection === 'asc' ? 'desc' : 'asc';
                    } else {
                        _reportState.sortColumn = sortKey;
                        _reportState.sortDirection = 'asc';
                    }
                    _generateReport(); // Re-renderiza o relatório com a nova ordenação
                });
            });

            // NOVO: Adiciona listeners para os inputs de quantidade
            _pageReportContent.querySelectorAll('.report-quantity-input').forEach(input => {
                input.addEventListener('input', (event) => {
                    App.updateReportQuantity(event.target.dataset.productId, event.target.value);
                });
            });

            // Adiciona listener para o novo alternador
            const toggle = _pageReportContent.querySelector('#intelligent-requisition-toggle');
            if (toggle) toggle.addEventListener('change', _handleIntelligentToggleChange);

            if (_pageReportContent) {
                _pageReportContent.addEventListener('mouseover', (event) => {
                    if (event.target.classList.contains('product-list-item-img')) {
                        _showProductTooltip(event);
                    }
                });
                _pageReportContent.addEventListener('mouseout', (event) => {
                    if (event.target.classList.contains('product-list-item-img')) {
                        _hideProductTooltip();
                    }
                });
            }
        }

        /**
         * ATUALIZADO: Lida com o lançamento da requisição para Fábrica ou Terceiros.
         */
        async function _handleLaunchRequisition(type) {
            // 1. Verifica se há itens da fábrica em uma requisição de terceiros e pede confirmação.
            if (type === 'terceiros') {
                const anyFabricaItemSelected = Array.from(_reportQuantities.keys()).some(productId => {
                    const product = _allProducts.find(p => p.id === productId);
                    return (_reportQuantities.get(productId) || 0) > 0 && product?.codigo?.startsWith('6');
                });
                if (anyFabricaItemSelected) {
                    const confirmed = await _showConfirmationModal("Atenção", "Sua seleção contém itens da Fábrica (código iniciado com '6'). Eles não serão incluídos nesta requisição de Terceiros. Deseja continuar?");
                    if (!confirmed) return;
                }
            }

            // 2. Filtra os itens a serem lançados com base no tipo (fábrica/terceiros).
            const itemsToLaunch = Array.from(_reportQuantities.entries())
                .filter(([productId, qty]) => {
                    if (qty <= 0) return false;
                    const product = _allProducts.find(p => p.id === productId);
                    if (!product) return false;
                    const isFabricaItem = product.codigo?.startsWith('6');
                    return (type === 'fabrica' && isFabricaItem) || (type === 'terceiros' && !isFabricaItem);
                })
                .map(([productId, qty]) => {
                    const product = _allProducts.find(p => p.id === productId);
                    return {
                        id: product.id, codigo: product.codigo, descricao: product.descricao, quantidade: qty,
                        unidade: product.unidade || 'UN', preco: product.preco || 0,
                        situacao: 'PENDENTE' // Adiciona o status padrão ao criar o item
                    };
                });

            // 3. Verifica se há itens para lançar.
            if (itemsToLaunch.length === 0) {
                _showMessageModal("Nenhum Item", `Não há itens do tipo '${type}' para lançar.`);
                return;
            }

            // 4. Lógica de lançamento específica por tipo
            if (type === 'fabrica') {
                // Gera o código da requisição para fábrica
                const today = new Date();
                const ddmmaa = `${String(today.getDate()).padStart(2, '0')}${String(today.getMonth() + 1).padStart(2, '0')}${String(today.getFullYear()).slice(-2)}`;
                const todayStr = today.toLocaleDateString('pt-BR');
                const requisitionsToday = new Set(
                    _allOrdersFabrica
                        .filter(order => {
                            const orderDate = _parsePtBrDate(order.dataPedido);
                            return orderDate && orderDate.toLocaleDateString('pt-BR') === todayStr;
                        })
                        .map(order => order.orderCode)
                );
                const nextSequence = requisitionsToday.size + 1;
                const requisitionCode = `${ddmmaa}-${nextSequence}`;

                // Mostra o modal de confirmação final.
                const confirmationMessage = `Confirmar lançamento de <b>${itemsToLaunch.length}</b> itens?<br><br>Requisição <b>${type.toUpperCase()}</b> com o código <b>${requisitionCode}</b>.`;
                const confirmed = await _showConfirmationModal("Confirmar Lançamento", confirmationMessage);
                if (!confirmed) return;

                // Se confirmado, executa o lançamento.
                _executeLaunch(type, requisitionCode, itemsToLaunch);

            } else {
                // Abre o modal para inserir o código
                if (_terceirosReqModalMessage) _terceirosReqModalMessage.textContent = `Você está lançando uma requisição para ${itemsToLaunch.length} itens de Terceiros.`;
                if (_terceirosRequisitionCodeInput) _terceirosRequisitionCodeInput.value = '';
                if (_terceirosRequisitionModal) {
                    _terceirosRequisitionModal.classList.remove('hidden');
                    _terceirosRequisitionCodeInput.focus();
                }
            }
        }

        // NOVO: Função para confirmar e prosseguir com a requisição de terceiros
        async function _confirmTerceirosRequisition() {
            const requisitionCode = _terceirosRequisitionCodeInput.value.trim();
            if (!requisitionCode) {
                _showMessageModal("Código Necessário", "Por favor, insira o código da requisição do Phoenix.");
                return;
            }

            // Esconde o primeiro modal
            if (_terceirosRequisitionModal) _terceirosRequisitionModal.classList.add('hidden');

            // Filtra os itens novamente (para garantir)
            const itemsToLaunch = Array.from(_reportQuantities.entries())
                .filter(([productId, qty]) => {
                    if (qty <= 0) return false;
                    const product = _allProducts.find(p => p.id === productId);
                    if (!product) return false;
                    const isFabricaItem = product.codigo?.startsWith('6');
                    return !isFabricaItem; // Apenas itens de terceiros
                })
                .map(([productId, qty]) => {
                    const product = _allProducts.find(p => p.id === productId);
                    return {
                        id: product.id, codigo: product.codigo, descricao: product.descricao, quantidade: qty,
                        unidade: product.unidade || 'UN', preco: product.preco || 0,
                        situacao: 'PENDENTE' // Adiciona o status padrão ao criar o item
                    };
                });

            if (itemsToLaunch.length === 0) {
                _showMessageModal("Nenhum Item", `Não há itens do tipo 'terceiros' para lançar.`);
                return;
            }

            // Mostra o modal de confirmação final.
            const confirmationMessage = `Confirmar lançamento de <b>${itemsToLaunch.length}</b> itens?<br><br>Requisição <b>TERCEIROS</b> com o código <b>${requisitionCode}</b>.`;
            const confirmed = await _showConfirmationModal("Confirmar Lançamento", confirmationMessage);
            if (!confirmed) return;

            // Se confirmado, executa o lançamento.
            _executeLaunch('terceiros', requisitionCode, itemsToLaunch);
        }

        /**
         * NOVO: Função centralizada que envia a requisição para a API de lançamento.
         */
        async function _executeLaunch(type, requisitionCode, itemsToLaunch) {
            _loadingOverlay.classList.remove('hidden');
            const targetLaunchUrl = type === 'fabrica' ? `${WEBHOOK_LAUNCH_URL}/launch-fabrica` : WEBHOOK_LAUNCH_URL;

            try {
                const response = await fetch(targetLaunchUrl, {
                    method: 'POST', mode: 'cors', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ phoenixCode: requisitionCode, items: itemsToLaunch })
                });
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Erro na rede (Status: ${response.status}): ${errorText}`);
                }
                const resultJson = await response.json();
                if (resultJson.requisitionData) {
                    if (type === 'terceiros') _allOrdersTerceiros.push(resultJson.requisitionData);
                    else if (type === 'fabrica') _allOrdersFabrica.push(resultJson.requisitionData);
                }
                _showMessageModal("Sucesso!", `Requisição lançada!`);
                
                itemsToLaunch.forEach(launchedItem => {
                    _selectedStockItems.delete(launchedItem.id);
                    _reportQuantities.delete(launchedItem.id);
                });
                _updateSelectedCountDisplay();
                _showPage('estoque'); 
                _renderRequisitionOverviewPage(); 
                if (!_terceirosOrdersModal.classList.contains('hidden')) _renderConsolidatedOrdersTable();
            } catch (error) {
                _showMessageModal("Erro no Lançamento", `Falha: ${error.message}.`);
            } finally {
                _loadingOverlay.classList.add('hidden');
            }
        }

        function _removeItemFromPrintPreview(index) {
            _itemsToPrint.splice(index, 1);
            _renderPrintPreviewTable();
        }

        function _openPrintPreviewModal(items, type) {
            _itemsToPrint = JSON.parse(JSON.stringify(items));
            _currentPrintModalType = type;
            const titles = {
                orders: 'Pré-visualização para Impressão de Pedidos',
                nfe: 'Pré-visualização para Impressão de Notas Fiscais',
                fabrica_solicitacao: 'Pré-visualização para Impressão de Solicitação Fábrica'
            };
            if (_printModalTitle) _printModalTitle.textContent = titles[type] || 'Pré-visualização';
            _renderPrintPreviewTable();
            if (_printTableModal) _printTableModal.classList.remove('hidden');
        }

        function _renderPrintPreviewTable() {
            if (_itemsToPrint.length === 0) {
                if (_printModalContent) _printModalContent.innerHTML = '<p class="text-center text-gray-500 py-8">Nenhum item para imprimir.</p>';
                return;
            }

            let tableHtml = '';
            if (_currentPrintModalType === 'nfe') {
                const headers = [
                    { label: 'AÇÕES', key: 'actions' }, { label: 'Nº DA NOTA', key: 'numero_da_nota' },
                    { label: 'DATA DE EMISSÃO', key: 'data_de_emissao' }, { label: 'SITUAÇÃO', key: 'situacao' },
                    { label: 'VALOR DA NOTA', key: 'valor_da_nota' }, { label: 'VALOR DO FRETE', key: 'valor_do_frete' },
                    { label: 'NOME DO CLIENTE', key: 'nome_do_cliente' }, { label: 'CNPJ/CPF CLIENTE', key: 'cnpjcpf_cliente' },
                    { label: 'NOME DO VENDEDOR', key: 'nome_do_vendedor' }, { label: 'Nº PEDIDO LOJA', key: 'numero_pedido_loja' },
                    { label: 'TRANSPORTADORA', key: 'transportadora' }, { label: 'FRETE POR CONTA', key: 'frete_por_conta' },
                    { label: 'ORIGEM LOJA', key: 'origem_loja' }, { label: 'OBSERVÇÃO', key: 'observacao' }
                ];
                tableHtml = `<table class="print-preview-table"><thead><tr>${headers.map(h => `<th>${h.label}</th>`).join('')}</tr></thead><tbody>`;
                _itemsToPrint.forEach((nfe, index) => {
                    const nfeDate = _parsePtBrDate(nfe.data_de_emissao);
                    const dataEmissao = nfeDate ? nfeDate.toLocaleDateString('pt-BR') : 'N/A';
                    const rowClass = nfe.conferido === 'Sim' ? 'row-conferido' : 'row-nao-conferido';
                    tableHtml += `<tr class="${rowClass}">
                        <td><button class="remove-print-item-btn text-red-600" data-index="${index}">Remover</button></td>
                        <td>${nfe.numero_da_nota || 'N/A'}</td>
                        <td>${dataEmissao}</td>
                        <td>${nfe.situacao || 'N/A'}</td>
                        <td>${(nfe.valor_da_nota || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td>
                        <td>${(nfe.valor_do_frete || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td>
                        <td>${nfe.nome_do_cliente || 'N/A'}</td>
                        <td>${formatCnpjCpf(nfe.cnpjcpf_cliente)}</td>
                        <td>${nfe.nome_do_vendedor || 'N/A'}</td>
                        <td>${nfe.numero_pedido_loja || 'N/A'}</td>
                        <td>${nfe.transportadora || 'N/A'}</td>
                        <td>${nfe.frete_por_conta || 'N/A'}</td>
                        <td>${nfe.origem_loja || 'N/A'}</td>
                        <td>${nfe.observacao || ''}</td>
                    </tr>`;
                });
                tableHtml += '</tbody></table>';
            }
            // Add other _currentPrintModalType conditions if necessary...

            if (_printModalContent) _printModalContent.innerHTML = tableHtml;
            _printModalContent.querySelectorAll('.remove-print-item-btn').forEach(button => {
                button.addEventListener('click', (event) => _removeItemFromPrintPreview(parseInt(event.target.dataset.index, 10)));
            });
        }

        async function _confirmPrintPreview() {
            // A lógica de gerar PDF com html2pdf foi removida.
            // Agora, simplesmente acionamos a caixa de diálogo de impressão do navegador.
            // As regras de CSS @media print cuidarão de formatar o conteúdo corretamente.
            window.print();
        }
        
        function _printReportDirectly() {
            // Pega apenas os produtos que estão no relatório e têm quantidade > 0
            const productsToPrint = _allProducts
                .filter(p => _selectedStockItems.has(p.id) && (_reportQuantities.get(p.id) || 0) > 0);

            if (productsToPrint.length === 0) {
                _showMessageModal("Nenhum Item", "Não há itens com quantidade a requisitar maior que zero para imprimir.");
                return;
            }
            
            const aguardandoMap = _calculateAguardandoChegarMap();

            // Re-usa a lógica de ordenação do relatório
            productsToPrint.sort((a, b) => {
                const sortKey = _reportState.sortColumn;
                let valA, valB;
                if (sortKey === 'aguardandoChegar') { valA = aguardandoMap.get(a.codigo) || 0; valB = aguardandoMap.get(b.codigo) || 0; } 
                else if (['estoque', 'estoque_minimo', 'estoque_maximo', 'vendas_ultimos_90_dias'].includes(sortKey)) { valA = a[sortKey] || 0; valB = b[sortKey] || 0; } 
                else if (sortKey === 'quantidadeRequisitar') { valA = _reportQuantities.get(a.id) || 0; valB = _reportQuantities.get(b.id) || 0; } 
                else { valA = a[sortKey] || ''; valB = b[sortKey] || ''; }
                let comparison = 0;
                if (typeof valA === 'number' && typeof valB === 'number') { comparison = valA - valB; } 
                else { comparison = String(valA).localeCompare(String(valB), 'pt-BR', { numeric: true }); }
                return _reportState.sortDirection === 'asc' ? comparison : -comparison;
            });

            // --- Coleta de informações adicionais para o cabeçalho ---
            const requisitionModeText = _reportState.isIntelligentMode ? 'Requisição Inteligente (Até Fim do Ano)' : 'Requisição Padrão';
            const currentDateText = new Date().toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });

            const hasFabricaItems = productsToPrint.some(p => p.codigo?.startsWith('6'));
            const hasTerceirosItems = productsToPrint.some(p => !p.codigo?.startsWith('6'));
            
            let modelTypeText = '';
            if (hasFabricaItems && hasTerceirosItems) {
                modelTypeText = 'Modelo: Terceiros e Fábrica';
            } else if (hasFabricaItems) {
                modelTypeText = 'Modelo: Fábrica';
            } else if (hasTerceirosItems) {
                modelTypeText = 'Modelo: Terceiros';
            }

            // Constrói o HTML para impressão do relatório
            let printHtml = `
                <h1 style="font-size: 16pt; font-weight: bold; text-align: center; margin-bottom: 5px;">Relatório de Requisição</h1>
                <div style="display: flex; justify-content: space-between; align-items: center; font-size: 9pt; margin-bottom: 20px; border-bottom: 1px solid #ccc; padding-bottom: 10px;">
                    <span style="font-weight: bold;">${requisitionModeText}</span>
                    <span style="font-weight: bold;">${modelTypeText}</span>
                    <span>Data: ${currentDateText}</span>
                </div>
                <table class="report-print-table">
                    <thead>
                        <tr>
                            <th>Produto</th> <!-- Coluna 1 -->
                            <th class="text-center-print">Est.</th> <!-- Coluna 2 -->
                            <th class="text-center-print">Aguardando</th> <!-- Coluna 3 -->
                            <th class="text-center-print">Mín/Máx</th> <!-- Coluna 4 -->
                            <th class="text-center-print">Vendas 90d</th> <!-- Coluna 5 -->
                            <th class="text-center-print">Qtd. Req.</th> <!-- Coluna 6 -->
                        </tr>
                    </thead>
                    <tbody>
            `;

            productsToPrint.forEach(p => {
                const currentQuantity = _reportQuantities.get(p.id) || 0;
                const aguardandoChegar = aguardandoMap.get(p.codigo) || 0;
                const imageUrl = p.url_imagens_externas?.[0] || 'https://placehold.co/50x50/e2e8f0/64748b?text=?';
                printHtml += `
                    <tr>
                        <td><div style="display: flex; align-items: center;"><img src="${imageUrl}" alt="" class="product-list-item-img" onerror="this.style.display='none'"><div style="margin-left: 8px;"><div style="font-weight: 500;">${p.descricao || ''}</div><div style="font-size: 0.875rem; color: #6b7280;">${p.codigo || ''}</div></div></div></td> <!-- Coluna 1 -->
                        <td class="text-center-print">${p.estoque ?? 0}</td> <!-- Coluna 2 -->
                        <td class="text-center-print">${aguardandoChegar}</td> <!-- Coluna 3 -->
                        <td class="text-center-print">${p.estoque_minimo ?? 0} / ${p.estoque_maximo ?? 0}</td> <!-- Coluna 4 -->
                        <td class="text-center-print">${p.vendas_ultimos_90_dias ?? 0}</td> <!-- Coluna 5 -->
                        <td class="text-center-print" style="font-weight: bold;">${currentQuantity}</td> <!-- Coluna 6 -->
                    </tr>
                `;
            });
            printHtml += `</tbody></table>`;

            if (_printArea) {
                _printArea.innerHTML = printHtml;
                window.print();
                _printArea.innerHTML = ''; // Limpa a área após a impressão
            }
        }

        /**
         * ATUALIZADO: Imprime a "Solicitação" a partir da Lista de Pedidos em uma única folha.
         */
        function _printRequisitionSolicitation() {
            if (_currentFilteredOrderItems.length === 0) {
                _showMessageModal("Nenhum Item", "Não há itens na tabela para imprimir a solicitação.");
                return;
            }

            const itemsToPrint = _currentFilteredOrderItems;
            const currentDate = new Date().toLocaleDateString('pt-br');

            // NOVO: Define o título dinamicamente com base no tipo de lista
            let reportTitle = 'Itens de Reposição'; // Título padrão para requisições de compra
            if (_ordersTableState.selectedType === 'saidas-fabrica') {
                reportTitle = 'Saída para Fábrica';
            } else if (_ordersTableState.selectedType === 'saidas-garantia') {
                reportTitle = 'Itens de Garantia';
            }

            let printHtml = '';

            printHtml += `
                <div class="solicitation-page">
                    <div class="solicitation-header">
                        <div class="company-name">MKS Service</div>
                        <div class="report-title">${reportTitle}</div>
                        <div class="solicitation-info">
                            <div><strong>Data da Impressão:</strong> ${currentDate}</div>
                        </div>
                    </div>
                    <table class="solicitation-print-table">
                        <thead>
                            <tr>
                                <th>Requisição / Foto</th>
                                <th>Produto / Código</th>
                                <th>Localização</th>
                                <th>Qtd. Solicitada</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            itemsToPrint.forEach(item => {
                const product = _allProducts.find(p => p.codigo === item.codigoService);
                const imageUrl = product?.url_imagens_externas?.[0];
                const imageHtml = imageUrl
                    ? `<img src="${imageUrl}" class="solicitation-product-image" onerror="this.style.display='none'">`
                    : `<span style="font-size: 9pt; color: #6b7280;">Sem Imagem</span>`;

                printHtml += `
                    <tr>
                        <td class="photo-cell">
                            <strong style="display: block; margin-bottom: 5px;">${item.orderCode}</strong>
                            ${imageHtml}
                        </td>
                        <td class="product-cell">
                            <strong>${item.descricao}</strong><br>
                            <small>Código: ${item.codigoService}</small>
                        </td>
                        <td class="location-cell">${item.localizacao || 'N/A'}</td>
                        <td class="quantity-cell">${item.quantidadePedido}</td>
                    </tr>
                `;
            });

            printHtml += `</tbody></table></div>`;

            if (_printArea) {
                _printArea.innerHTML = printHtml;
                window.print();
                _printArea.innerHTML = '';
            }
        }

        /**
         * NOVO: Imprime a "Solicitação" a partir da tela de Relatório/Preparação.
         */
        function _printReportSolicitation() {
            // CORREÇÃO: Usa os produtos já filtrados na tela do relatório, em vez de buscar na lista completa.
            // A chave do mapa de quantidades é o 'id' do produto.
            const productsToPrint = Array.from(_reportQuantities.keys())
                .filter(productId => (_reportQuantities.get(productId) || 0) > 0)
                .map(productId => _allProducts.find(p => String(p.id) === String(productId)));

            if (productsToPrint.length === 0) {
                _showMessageModal("Nenhum Item", "Não há itens com quantidade a requisitar maior que zero para imprimir.");
                return;
            }

            const requisitionModeText = _reportState.isIntelligentMode ? 'Requisição Inteligente' : 'Requisição Padrão';
            const currentDateText = new Date().toLocaleDateString('pt-BR');

            let printHtml = `
                <div class="solicitation-page">
                    <div class="solicitation-header">
                        <div class="company-name">MKS Service</div>
                        <div class="report-title">Itens de Reposição</div>
                        <div class="solicitation-info">
                            <div><strong>Modo:</strong> ${requisitionModeText}</div>
                            <div><strong>Data da Solicitação:</strong> ${currentDateText}</div>
                        </div>
                    </div>
                    <table class="solicitation-print-table">
                        <thead><tr><th>Foto</th><th>Produto / Código</th><th>Localização</th><th>Qtd. Solicitada</th></tr></thead>
                        <tbody>`;

            productsToPrint.forEach(p => {
                const requestedQty = _reportQuantities.get(p.id) || 0;
                const imageUrl = p.url_imagens_externas?.[0];
                const imageHtml = imageUrl
                        ? `<img src="${imageUrl}" class="solicitation-product-image" onerror="this.style.display='none'">`
                        : `<span style="font-size: 9pt; color: #6b7280;">Sem Imagem</span>`;
                printHtml += `<tr>
                    <td class="photo-cell">${imageHtml}</td>
                    <td class="product-cell"><strong>${p.descricao}</strong><br><small>Código: ${p.codigo}</small></td>
                    <td class="location-cell">${p.localizacao || 'N/A'}</td>
                    <td class="quantity-cell">${requestedQty}</td>
                </tr>`;
            });
            printHtml += `</tbody></table></div>`;

            if (_printArea) {
                _printArea.innerHTML = printHtml;
                window.print();
                _printArea.innerHTML = '';
            }
        }

        function _exportReportToCSV() {
            if (_selectedStockItems.size === 0) {
                _showMessageModal("Nenhum Item", "Não há itens no relatório para exportar.");
                return;
            }

            const selectedProducts = _allProducts.filter(p => _selectedStockItems.has(p.id));
            const aguardandoMap = _calculateAguardandoChegarMap();

            const headers = ["Código", "Descrição", "Estoque", "Aguardando Chegar", "Estoque Mínimo", "Estoque Máximo", "Vendas 90d", "Qtd. a Requisitar"];
            let csvContent = headers.join(";") + "\n";

            selectedProducts.forEach(p => {
                const aguardandoChegar = aguardandoMap.get(p.codigo) || 0;
                const quantidadeRequisitar = _reportQuantities.get(p.id) || 0;
                const escapeCSV = (field) => `"${String(field || '').replace(/"/g, '""')}"`;

                const row = [
                    escapeCSV(p.codigo), escapeCSV(p.descricao), p.estoque ?? 0, aguardandoChegar,
                    p.estoque_minimo ?? 0, p.estoque_maximo ?? 0, p.vendas_ultimos_90_dias ?? 0, quantidadeRequisitar
                ].join(";");
                csvContent += row + "\n";
            });

            const blob = new Blob([`\uFEFF${csvContent}`], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "relatorio_requisicao.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }


        /**
         * ATUALIZADO: Cria um card de resumo para a tela de NFe.
         */
        function _createNFeCard(id, title, count, totalValue, color, isActive = false) {
            const valueFormatted = (totalValue || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            const activeClass = isActive ? 'active ring-4 ring-offset-2 ring-blue-400' : '';
            return `<div data-id="${id}" class="${color} text-white p-4 rounded-lg shadow-lg flex flex-col justify-between ${activeClass}">
                        <div>
                            <h3 class="text-md font-semibold">${title}</h3>
                            <p class="text-sm">Total de Notas: ${count}</p>
                        </div>
                        <p class="text-2xl font-bold mt-2 self-end">${valueFormatted}</p>
                    </div>`;
        }
        
        function _createNFeDashboardCard(storeName, color) {
            return `<div data-store="${storeName}" class="nfe-diagnostic-card bg-white p-4 rounded-lg shadow-md cursor-pointer hover:shadow-xl hover:-translate-y-1 transition-all duration-300 flex items-center justify-center">
                        <h3 class="text-lg font-semibold text-gray-700 text-center">Analisar ${storeName}</h3>
                    </div>`;
        }

        // ATUALIZADO: Função para renderizar a página de Conferência NFe com os novos cards
        function _renderNFeOverviewPage() {
            let filteredNFeByDate = _allNFeData;
            const { startDate, endDate } = _nfeTableState.filters;

            if (startDate || endDate) {
                filteredNFeByDate = _allNFeData.filter(nfe => {
                    const nfeDate = _parsePtBrDate(nfe.data_de_emissao);
                    if (!nfeDate) return false;
                    const startMatch = startDate ? nfeDate >= startDate : true;
                    const endMatch = endDate ? nfeDate <= endDate : true;
                    return startMatch && endMatch;
                });
            }

            if (!filteredNFeByDate || filteredNFeByDate.length === 0) {
                if (_noNFeMessageOverview) _noNFeMessageOverview.classList.remove('hidden');
                return;
            }
            
            if (_noNFeMessageOverview) _noNFeMessageOverview.classList.add('hidden');
            
            // ATUALIZADO: Renderiza a tabela se não for a visualização inicial
            if (!_nfeTableState.isInitialView) {
                _renderNFeDiagnosticTable(_nfeTableState.currentStoreFilter);
            } else {
                 if (_nfeDiagnosticTableContainer) _nfeDiagnosticTableContainer.innerHTML = '';
            }
        }
        
        async function _handleNFeConferenciaChange(event) {
            const selectElement = event.target;
            const nfeId = selectElement.dataset.nfeId;
            const newStatus = selectElement.value;
            const oldStatus = selectElement.dataset.currentStatus;

            if (newStatus === oldStatus) return;

            const confirmed = await _showConfirmationModal(
                "Confirmar Alteração",
                `Deseja alterar o status da Nota Fiscal ID <b>${nfeId}</b> para '<b>${newStatus}</b>'?`
            );

            if (confirmed) {
                _loadingOverlay.classList.remove('hidden');
                try {
                    const payload = {
                        id_nota: nfeId,
                        conferido: newStatus
                    };

                    const response = await fetch(NFE_CONFERENCIA_API_URL, {
                        method: 'POST',
                        mode: 'cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`Erro na rede (Status: ${response.status}): ${errorText}`);
                    }

                    // Update local data
                    const nfeToUpdate = _allNFeData.find(nfe => String(nfe.id_nota) === String(nfeId));
                    if (nfeToUpdate) {
                        nfeToUpdate.conferido = newStatus;
                        selectElement.dataset.currentStatus = newStatus; // Update the current status
                    }
                    
                    _renderNFeOverviewPage();
                    
                } catch (error) {
                    _showMessageModal("Erro na Alteração", `Falha ao alterar status: ${error.message}.`);
                    selectElement.value = oldStatus; // Revert on failure
                } finally {
                    _loadingOverlay.classList.add('hidden');
                }
            } else {
                selectElement.value = oldStatus; // Revert if user cancels
            }
        }


        function _renderNFeDiagnosticTable(storeFilter) {
            let filteredNFe = _allNFeData;
            const { startDate, endDate } = _nfeTableState.filters;

            if (startDate || endDate) {
                filteredNFe = filteredNFe.filter(nfe => {
                    const nfeDate = _parsePtBrDate(nfe.data_de_emissao);
                    if (!nfeDate) return false;
                    const startMatch = startDate ? nfeDate >= startDate : true;
                    const endMatch = endDate ? nfeDate <= endDate : true;
                    return startMatch && endMatch;
                });
            }
            
            const storeMap = { 'bling': 'Bling', 'mercado_livre': 'Mercado Livre', 'loja_integrada': 'Loja Integrada' };
            const storeName = storeMap[storeFilter] || 'Todos os Canais';

            if (storeFilter !== 'todos') {
                filteredNFe = filteredNFe.filter(nfe => nfe.origem_loja === storeName);
            }
            
            // Filtro de status de conferência
            if (_nfeTableState.conferenceStatusFilter === 'conferidas') {
                filteredNFe = filteredNFe.filter(nfe => nfe.conferido === 'Sim');
            } else if (_nfeTableState.conferenceStatusFilter === 'nao_conferidas') {
                filteredNFe = filteredNFe.filter(nfe => nfe.conferido !== 'Sim');
            }


            filteredNFe.sort((a, b) => {
                const sortKey = _nfeTableState.sortColumn;
                let valA = a[sortKey];
                let valB = b[sortKey];
                if (sortKey === 'data_de_emissao') {
                    valA = _parsePtBrDate(valA) || new Date(0);
                    valB = _parsePtBrDate(valB) || new Date(0);
                } else if (['valor_da_nota', 'valor_do_frete'].includes(sortKey)) {
                    valA = parseFloat(valA) || 0;
                    valB = parseFloat(valB) || 0;
                }
                const comparison = valA > valB ? 1 : (valA < valB ? -1 : 0);
                return _nfeTableState.sortDirection === 'asc' ? comparison : -comparison;
            });

            const headers = [
                { label: 'Nº DA NOTA', key: 'numero_da_nota' }, 
                { label: 'DATA DE EMISSÃO', key: 'data_de_emissao' },
                { label: 'CLIENTE', key: 'nome_do_cliente' },
                { label: 'VENDEDOR', key: 'nome_do_vendedor' },
                { label: 'VALOR', key: 'valor_da_nota' },
                { label: 'SITUAÇÃO', key: 'situacao' }
            ];

            let tableHtml = `
                <div class="bg-white rounded-lg shadow-md overflow-hidden">
                    <div class="p-4 bg-gray-50 border-b flex justify-between items-center">
                        <h3 class="text-xl font-bold text-gray-800">Diagnóstico de Vendas: ${storeName}</h3>
                        <button id="close-diagnostic-table-btn" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
                    </div>
                    <div id="nfe-diagnostic-table-content" class="overflow-auto max-h-[60vh]">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    ${headers.map(h => `<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" data-sort="${h.key}">${h.label} ${_renderNFeSortIcon(h.key)}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${filteredNFe.map(nfe => {
                                    const nfeDate = _parsePtBrDate(nfe.data_de_emissao);
                                    const isConferido = nfe.conferido === 'Sim';
                                    return `
                                    <tr class="${isConferido ? 'row-conferido' : 'row-nao-conferido'}">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-blue-600"><a href="${nfe.link_danfe || '#'}" target="_blank" rel="noopener noreferrer">${nfe.numero_da_nota || 'N/A'}</a></td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${nfeDate ? nfeDate.toLocaleDateString('pt-BR') : 'N/A'}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${nfe.nome_do_cliente || 'N/A'}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${nfe.nome_do_vendedor || 'N/A'}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${(parseFloat(nfe.valor_da_nota) || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${nfe.situacao || 'N/A'}</td>
                                    </tr>
                                `}).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            if (_nfeDiagnosticTableContainer) {
                _nfeDiagnosticTableContainer.innerHTML = tableHtml;
                _nfeDiagnosticTableContainer.querySelector('#close-diagnostic-table-btn').addEventListener('click', () => {
                    _nfeDiagnosticTableContainer.innerHTML = '';
                    _nfeTableState.isInitialView = true; // Reseta para o estado inicial ao fechar
                    _nfeTableState.currentStoreFilter = 'todos';
                    _nfeTableState.conferenceStatusFilter = 'todos';
                    _renderNFeOverviewPage(); // Re-renderiza os cards para remover o estado 'active'
                });
                _nfeDiagnosticTableContainer.querySelectorAll('.sortable-header').forEach(header => {
                    header.addEventListener('click', () => {
                        const sortKey = header.dataset.sort;
                        if (_nfeTableState.sortColumn === sortKey) {
                            _nfeTableState.sortDirection = _nfeTableState.sortDirection === 'asc' ? 'desc' : 'asc';
                        } else {
                            _nfeTableState.sortColumn = sortKey;
                            _nfeTableState.sortDirection = 'asc';
                        }
                        _renderNFeDiagnosticTable(storeFilter);
                    });
                });
            }
        }

        function _renderSalesTable(sortedMonths, salesData, selectedChannel) {
            if (!_salesTableContainer) return;

            const channelMap = {
                'bling': 'Bling',
                'mercado_livre': 'Mercado Livre',
                'loja_integrada': 'Loja Integrada'
            };
            const selectedChannelName = channelMap[selectedChannel];

            const formatCurrency = (value) => (value || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

            let tableHtml = `
                <div class="bg-white p-4 rounded-lg shadow-md">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Vendas Mensais Detalhadas</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mês/Ano</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider ${selectedChannelName === 'Bling' ? 'bg-green-100' : ''}">Bling</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider ${selectedChannelName === 'Mercado Livre' ? 'bg-yellow-100' : ''}">Mercado Livre</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider ${selectedChannelName === 'Loja Integrada' ? 'bg-red-100' : ''}">Loja Integrada</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Total Mês</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
            `;

            let totalBling = 0;
            let totalML = 0;
            let totalLI = 0;
            let grandTotal = 0;

            if (sortedMonths.length === 0) {
                tableHtml += `<tr><td colspan="5" class="text-center py-4 text-gray-500">Nenhum dado de venda para o período.</td></tr>`;
            } else {
                sortedMonths.forEach(monthKey => {
                    const monthData = salesData[monthKey];
                    const monthTotal = (monthData['Bling'] || 0) + (monthData['Mercado Livre'] || 0) + (monthData['Loja Integrada'] || 0);
                    
                    totalBling += (monthData['Bling'] || 0);
                    totalML += (monthData['Mercado Livre'] || 0);
                    totalLI += (monthData['Loja Integrada'] || 0);
                    grandTotal += monthTotal;

                    const [year, month] = monthKey.split('-');
                    const monthLabel = new Date(year, month - 1).toLocaleString('pt-BR', { month: 'long', year: 'numeric' });

                    tableHtml += `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${monthLabel.charAt(0).toUpperCase() + monthLabel.slice(1)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 text-right clickable-sales-cell ${selectedChannelName === 'Bling' ? 'bg-green-50 font-bold' : ''}" data-month-key="${monthKey}" data-channel="Bling">${formatCurrency(monthData['Bling'])}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 text-right clickable-sales-cell ${selectedChannelName === 'Mercado Livre' ? 'bg-yellow-50 font-bold' : ''}" data-month-key="${monthKey}" data-channel="Mercado Livre">${formatCurrency(monthData['Mercado Livre'])}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 text-right clickable-sales-cell ${selectedChannelName === 'Loja Integrada' ? 'bg-red-50 font-bold' : ''}" data-month-key="${monthKey}" data-channel="Loja Integrada">${formatCurrency(monthData['Loja Integrada'])}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-bold text-right">${formatCurrency(monthTotal)}</td>
                        </tr>
                    `;
                });
            }

            tableHtml += `
                            </tbody>
                            <tfoot class="bg-gray-100">
                                <tr>
                                    <th class="px-6 py-3 text-left text-sm font-bold text-gray-700 uppercase">Total Período</th>
                                    <th class="px-6 py-3 text-right text-sm font-bold text-gray-700 clickable-sales-cell ${selectedChannelName === 'Bling' ? 'bg-green-100' : ''}" data-month-key="period-total" data-channel="Bling">${formatCurrency(totalBling)}</th>
                                    <th class="px-6 py-3 text-right text-sm font-bold text-gray-700 clickable-sales-cell ${selectedChannelName === 'Mercado Livre' ? 'bg-yellow-100' : ''}" data-month-key="period-total" data-channel="Mercado Livre">${formatCurrency(totalML)}</th>
                                    <th class="px-6 py-3 text-right text-sm font-bold text-gray-700 clickable-sales-cell ${selectedChannelName === 'Loja Integrada' ? 'bg-red-100' : ''}" data-month-key="period-total" data-channel="Loja Integrada">${formatCurrency(totalLI)}</th>
                                    <th class="px-6 py-3 text-right text-sm font-extrabold text-gray-900 clickable-sales-cell" data-month-key="period-total" data-channel="Total">${formatCurrency(grandTotal)}</th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            `;

            _salesTableContainer.innerHTML = tableHtml;
        }


        /**
         * ATUALIZADO: Renderiza a página de dashboards.
         */
        function _renderDashboardsPage() {
            if (!_salesChartCanvas) return;

            const startDateValue = _dashboardStartDateInput.value;
            const endDateValue = _dashboardEndDateInput.value;

            const startDate = startDateValue ? new Date(startDateValue + 'T00:00:00') : null;
            const endDate = endDateValue ? new Date(endDateValue + 'T23:59:59') : null;

            let filteredNFe = _allNFeData.filter(nfe => {
                const nfeDate = _parsePtBrDate(nfe.data_de_emissao);
                if (!nfeDate) return false;
                const startMatch = startDate ? nfeDate >= startDate : true;
                const endMatch = endDate ? nfeDate <= endDate : true;
                return startMatch && endMatch;
            });

            // 1. Render Summary Cards
            const stores = ['Bling', 'Mercado Livre', 'Loja Integrada'];
            const storeData = stores.map(store => {
                const notes = filteredNFe.filter(nfe => nfe.origem_loja === store);
                const total = notes.reduce((sum, nfe) => sum + (parseFloat(nfe.valor_da_nota) || 0), 0);
                return { name: store, count: notes.length, total: total };
            });

            const grandTotal = storeData.reduce((sum, store) => sum + store.total, 0);
            const grandTotalCount = storeData.reduce((sum, store) => sum + store.count, 0);

            const colors = { 'Bling': 'bg-green-500', 'Mercado Livre': 'bg-yellow-500', 'Loja Integrada': 'bg-red-500' };

            let cardsHtml = storeData.map(store =>
                _createNFeCard(store.name.toLowerCase().replace(/ /g, '_'), store.name, store.count, store.total, colors[store.name])
            ).join('');
            cardsHtml += _createNFeCard('total', 'Total Geral', grandTotalCount, grandTotal, 'bg-gray-700');

            if (_dashboardSummaryCards) _dashboardSummaryCards.innerHTML = cardsHtml;

            // 2. Render Chart (usando o canal salvo no estado)
            _updateDashboardChart(_dashboardState.selectedChannel);
        }

        /**
         * ATUALIZADO: Atualiza o gráfico e a tabela do dashboard.
         */
        function _updateDashboardChart(selectedChannel) {
            _dashboardState.selectedChannel = selectedChannel; // Salva o canal selecionado

            if (!_salesChartCanvas || !_allNFeData) return;

            const startDateValue = _dashboardStartDateInput.value;
            const endDateValue = _dashboardEndDateInput.value;
            const startDate = startDateValue ? new Date(startDateValue + 'T00:00:00') : null;
            const endDate = endDateValue ? new Date(endDateValue + 'T23:59:59') : null;

            let filteredNFe = _allNFeData.filter(nfe => {
                const nfeDate = _parsePtBrDate(nfe.data_de_emissao);
                if (!nfeDate) return false;
                const startMatch = startDate ? nfeDate >= startDate : true;
                const endMatch = endDate ? nfeDate <= endDate : true;
                return startMatch && endMatch;
            });

            // --- LÓGICA DE AGREGAÇÃO DINÂMICA (DIA/MÊS) ---
            // ATUALIZADO: Adiciona 'last_month' para também exibir por dia.
            const aggregationLevel = ['current_month', 'last_month', '30'].includes(_dashboardState.currentDateFilterValue) ? 'day' : 'month';
            
            let salesData = {};
            let chartLabels = [];
            let sortedKeys = [];

            // Primeiro, sempre agregamos por mês para a tabela
            const salesByMonthForTable = {};
            filteredNFe.forEach(nfe => {
                const date = _parsePtBrDate(nfe.data_de_emissao);
                if (!date) return;
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                const store = nfe.origem_loja;
                const value = parseFloat(nfe.valor_da_nota) || 0;
                if (!salesByMonthForTable[monthKey]) salesByMonthForTable[monthKey] = { 'Bling': 0, 'Mercado Livre': 0, 'Loja Integrada': 0 };
                if (salesByMonthForTable[monthKey][store] !== undefined) salesByMonthForTable[monthKey][store] += value;
            });
            const sortedMonthsForTable = Object.keys(salesByMonthForTable).sort();

            // Agora, agregamos para o gráfico
            if (aggregationLevel === 'day') {
                filteredNFe.forEach(nfe => {
                    const date = _parsePtBrDate(nfe.data_de_emissao);
                    if (!date) return;
                    const dayKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                    const store = nfe.origem_loja;
                    const value = parseFloat(nfe.valor_da_nota) || 0;
                    if (!salesData[dayKey]) salesData[dayKey] = { 'Bling': 0, 'Mercado Livre': 0, 'Loja Integrada': 0 };
                    if (salesData[dayKey][store] !== undefined) salesData[dayKey][store] += value;
                });
                sortedKeys = Object.keys(salesData).sort();
                chartLabels = sortedKeys.map(key => {
                    const [year, month, day] = key.split('-');
                    return `${day}/${month}`;
                });
            } else { // 'month'
                salesData = salesByMonthForTable; // Reutiliza os dados já agregados
                sortedKeys = sortedMonthsForTable;
                chartLabels = sortedKeys.map(key => {
                    const [year, month] = key.split('-');
                    return new Date(year, month - 1).toLocaleString('pt-BR', { month: 'short', year: '2-digit' });
                });
            }

            const aggregatedData = sortedKeys.map(key => salesData[key]);
            
            const allDatasets = [
                { label: 'Bling', data: aggregatedData.map(d => d['Bling']), borderColor: 'rgba(34, 197, 94, 1)', backgroundColor: 'rgba(34, 197, 94, 0.2)', fill: true, tension: 0.1, channel: 'bling' },
                { label: 'Mercado Livre', data: aggregatedData.map(d => d['Mercado Livre']), borderColor: 'rgba(234, 179, 8, 1)', backgroundColor: 'rgba(234, 179, 8, 0.2)', fill: true, tension: 0.1, channel: 'mercado_livre' },
                { label: 'Loja Integrada', data: aggregatedData.map(d => d['Loja Integrada']), borderColor: 'rgba(239, 68, 68, 1)', backgroundColor: 'rgba(239, 68, 68, 0.2)', fill: true, tension: 0.1, channel: 'loja_integrada' }
            ];

            const chartDatasets = allDatasets.map(ds => {
                ds.hidden = selectedChannel !== 'total' && ds.channel !== selectedChannel;
                return ds;
            });

            if (_salesChartInstance) _salesChartInstance.destroy();
            
            const ctx = _salesChartCanvas.getContext('2d');

            // NOVO: Registra o plugin de datalabels
            Chart.register(ChartDataLabels);

            _salesChartInstance = new Chart(ctx, {
                type: 'line',
                data: { labels: chartLabels, datasets: chartDatasets },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { 
                        legend: { position: 'top' }, 
                        title: { display: true, text: 'Evolução de Vendas por Canal' },
                        // NOVO: Configuração do plugin de datalabels
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            offset: 8,
                            color: '#4A5568', // text-gray-700
                            font: { weight: 'bold', size: 10 },
                            formatter: function(value) {
                                if (value === 0) return ''; // Não mostra label para valor 0
                                // Formata o valor de forma compacta (ex: 15200 -> R$ 15,2k)
                                return 'R$ ' + (value / 1000).toFixed(1).replace('.', ',') + 'k';
                            }
                        }
                    },
                    scales: { y: { beginAtZero: true, ticks: { callback: (value) => 'R$ ' + value.toLocaleString('pt-BR') } } }
                }
            });

            // Renderiza a tabela de dados (sempre mensal)
            _renderSalesTable(sortedMonthsForTable, salesByMonthForTable, selectedChannel);
        }
        
        /**
         * ATUALIZADO: Define o intervalo de datas para o Dashboard.
         */
        function _setDateRange(value) {
            const today = new Date();
            let startDate, endDate;
            const formatDate = (date) => date.toISOString().split('T')[0];

            const startDateInput = _dashboardStartDateInput;
            const endDateInput = _dashboardEndDateInput;
            const stateToUpdate = _dashboardState;

            const days = parseInt(value, 10);
            if (!isNaN(days)) {
                endDate = today;
                startDate = new Date();
                startDate.setDate(endDate.getDate() - days);
            } else {
                switch (value) {
                    case 'all': startDate = null; endDate = null; break;
                    case 'current_month': startDate = new Date(today.getFullYear(), today.getMonth(), 1); endDate = today; break;
                    case 'last_month': startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1); endDate = new Date(today.getFullYear(), today.getMonth(), 0); break;
                    case 'last_3_months': endDate = new Date(today.getFullYear(), today.getMonth(), 0); startDate = new Date(endDate.getFullYear(), endDate.getMonth() - 2, 1); break;
                    case 'last_6_months': endDate = new Date(today.getFullYear(), today.getMonth(), 0); startDate = new Date(endDate.getFullYear(), endDate.getMonth() - 5, 1); break;
                }
            }
            
            stateToUpdate.currentDateFilterValue = value;
            startDateInput.value = startDate ? formatDate(startDate) : '';
            endDateInput.value = endDate ? formatDate(endDate) : '';
            
            _renderDashboardsPage();
        }

        /**
         * NOVO: Vincula os eventos dos botões do modal de ajuste de estoque.
         */
        function _bindStockAdjustmentModalEvents() {
            if (_closeStockAdjustmentModalBtn) {
                _closeStockAdjustmentModalBtn.addEventListener('click', () => _stockAdjustmentModal.classList.add('hidden'));
            }
            if (_cancelStockAdjustmentBtn) {
                _cancelStockAdjustmentBtn.addEventListener('click', () => _stockAdjustmentModal.classList.add('hidden'));
            }
            if (_confirmStockAdjustmentBtn) {
                _confirmStockAdjustmentBtn.addEventListener('click', _saveStockAdjustment);
            }
        }


        /**
         * NOVO: Configura os campos de busca para terem um botão de limpar ("X").
         */
        function _setupClearableInputs() {
            const inputsToSetup = [
                { input: _globalSearchInput, clearBtn: _clearGlobalSearchBtn },
                { input: _ordersSearchInput, clearBtn: _clearOrdersSearchBtn }
            ];

            inputsToSetup.forEach(({ input, clearBtn }) => {
                if (!input || !clearBtn) return;

                input.addEventListener('input', () => {
                    clearBtn.classList.toggle('hidden', input.value === '');
                });

                clearBtn.addEventListener('click', () => {
                    input.value = '';
                    clearBtn.classList.add('hidden');
                    // Dispara o evento 'input' para que a lógica de filtro/busca seja acionada
                    input.dispatchEvent(new Event('input', { bubbles: true }));
                    input.focus();
                });

                // Garante que o botão esteja no estado correto ao carregar a página
                clearBtn.classList.toggle('hidden', input.value === '');
            });
        }


        function _bindEvents() {
            const debouncedApplyGlobalFilters = debounce(_applyGlobalFilters, 300);
            const debouncedRenderConsolidatedOrdersTable = debounce(_renderConsolidatedOrdersTable, 300);
            
            if (_navPesquisar) _navPesquisar.addEventListener('click', (e) => { e.preventDefault(); _showPage('pesquisar'); });
            if (_navEstoque) _navEstoque.addEventListener('click', (e) => { e.preventDefault(); _showPage('estoque'); });
            if (_navGerenciarSaida) _navGerenciarSaida.addEventListener('click', (e) => { e.preventDefault(); _showPage('gerenciar-saida'); });
            if (_navDashboards) _navDashboards.addEventListener('click', (e) => { e.preventDefault(); _showPage('dashboards'); });
            if (_viewRequisitionsBtn) _viewRequisitionsBtn.addEventListener('click', (e) => { e.preventDefault(); _showPage('overview-requisitions'); });
            if (_requisitionBackBtn) _requisitionBackBtn.addEventListener('click', () => _showPage('estoque'));

            if (_refreshButton) _refreshButton.addEventListener('click', _fetchData); 
            if (_globalSearchInput) _globalSearchInput.addEventListener('input', debouncedApplyGlobalFilters);
            if (_globalCategoryCheckboxesContainer) _globalCategoryCheckboxesContainer.addEventListener('change', _applyGlobalFilters);
            if (_globalFilterButton) _globalFilterButton.addEventListener('click', (e) => { e.stopPropagation(); _globalFilterDropdown.classList.toggle('hidden'); });
            
            window.addEventListener('click', (e) => { 
                if (_globalFilterMenuContainer && !_globalFilterMenuContainer.contains(e.target)) _globalFilterDropdown.classList.add('hidden');
                if (_ordersFilterMenuContainer && !_ordersFilterMenuContainer.contains(e.target)) _ordersFilterDropdown.classList.add('hidden');
                if (_reportActionsMenuContainer && !_reportActionsMenuContainer.contains(e.target)) _reportActionsDropdown.classList.add('hidden');
            });

            if (_generateReportButton) _generateReportButton.addEventListener('click', _prepareRequisition);
            if (_clearSelectionBtn) _clearSelectionBtn.addEventListener('click', _clearSelection);
            if (_closeModalBtn) _closeModalBtn.addEventListener('click', () => _orderDetailsModal.classList.add('hidden'));
            if (_viewSaidasBtn) _viewSaidasBtn.addEventListener('click', () => _showPage('overview-saidas'));
            if (_createSaidaBtn) _createSaidaBtn.addEventListener('click', _generateSaidaReport);
            if (_clearSaidaSelectionBtn) _clearSaidaSelectionBtn.addEventListener('click', _clearSaidaSelection);
            if (_ordersSearchInput) _ordersSearchInput.addEventListener('input', (e) => {
                _ordersTableState.searchTerm = e.target.value;
                debouncedRenderConsolidatedOrdersTable();
            });
            if (_ordersFilterButton) _ordersFilterButton.addEventListener('click', (e) => { e.stopPropagation(); _ordersFilterDropdown.classList.toggle('hidden'); });
            if (_ordersStatusCheckboxesContainer) _ordersStatusCheckboxesContainer.addEventListener('change', (event) => {
                if (event.target.classList.contains('order-status-checkbox')) {
                    if (event.target.checked) _ordersTableState.statusFilters.add(event.target.value);
                    else _ordersTableState.statusFilters.delete(event.target.value);
                    debouncedRenderConsolidatedOrdersTable();
                }
            });

            if (_saidaBackBtn) _saidaBackBtn.addEventListener('click', () => _showPage('gerenciar-saida'));
            if (_saidaReportBackBtn) _saidaReportBackBtn.addEventListener('click', () => _showPage('gerenciar-saida'));
            if (_launchSaidaGarantiaBtn) _launchSaidaGarantiaBtn.addEventListener('click', () => _handleLaunchSaida('garantia'));
            if (_launchSaidaFabricaBtn) _launchSaidaFabricaBtn.addEventListener('click', () => _handleLaunchSaida('fabrica'));
            if (_ordersTableActionsButton) {
                _ordersTableActionsButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    _ordersTableActionsDropdown.classList.toggle('hidden');
                });
            }
            if (_ordersTableActionPrintGeneric) {
                _ordersTableActionPrintGeneric.addEventListener('click', (e) => {
                    e.preventDefault();
                    _printOrdersTableDirectly();
                    if (_ordersTableActionsDropdown) _ordersTableActionsDropdown.classList.add('hidden');
                });
            }
            if (_ordersTableActionPrintList) {
                _ordersTableActionPrintList.addEventListener('click', (e) => {
                    e.preventDefault();
                    _printOrdersTableDirectly();
                    if (_ordersTableActionsDropdown) _ordersTableActionsDropdown.classList.add('hidden');
                });
            }
            if (_ordersTableActionPrintSolicitation) {
                _ordersTableActionPrintSolicitation.addEventListener('click', (e) => {
                    e.preventDefault();
                    _printRequisitionSolicitation();
                    if (_ordersTableActionsDropdown) _ordersTableActionsDropdown.classList.add('hidden');
                });
            }
            if (_ordersTableActionExcel) {
                _ordersTableActionExcel.addEventListener('click', (e) => { e.preventDefault(); _exportOrdersTableToCSV(); if (_ordersTableActionsDropdown) _ordersTableActionsDropdown.classList.add('hidden'); });
            }

            if (_reportLaunchTerceirosBtn) _reportLaunchTerceirosBtn.addEventListener('click', () => _handleLaunchRequisition('terceiros')); 
            if (_reportLaunchFabricaBtn) _reportLaunchFabricaBtn.addEventListener('click', () => _handleLaunchRequisition('fabrica')); 
            if (_reportActionsButton) {
                _reportActionsButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    _reportActionsDropdown.classList.toggle('hidden');
                });
            }
            if (_reportActionPrintList) {
                _reportActionPrintList.addEventListener('click', (e) => {
                    e.preventDefault();
                    _printReportDirectly();
                    if (_reportActionsDropdown) _reportActionsDropdown.classList.add('hidden');
                });
            }
            if (_reportActionPrintReq) {
                _reportActionPrintReq.addEventListener('click', (e) => {
                    e.preventDefault();
                    _printReportSolicitation();
                    if (_reportActionsDropdown) _reportActionsDropdown.classList.add('hidden');
                });
            }
            if (_reportActionExcel) {
                _reportActionExcel.addEventListener('click', (e) => { e.preventDefault(); _exportReportToCSV(); if (_reportActionsDropdown) _reportActionsDropdown.classList.add('hidden'); });
            }
            if (_reportBackBtn) _reportBackBtn.addEventListener('click', () => _showPage('estoque')); 

            if (_messageModalOkBtn) _messageModalOkBtn.addEventListener('click', () => _messageModal.classList.add('hidden'));
            if (_closeMessageModalBtn) _closeMessageModalBtn.addEventListener('click', () => _messageModal.classList.add('hidden'));
            // NOVO: Eventos para o modal de requisição de terceiros
            if (_closeTerceirosReqModalBtn) _closeTerceirosReqModalBtn.addEventListener('click', () => _terceirosRequisitionModal.classList.add('hidden'));
            if (_cancelTerceirosReqBtn) _cancelTerceirosReqBtn.addEventListener('click', () => _terceirosRequisitionModal.classList.add('hidden'));
            if (_confirmTerceirosReqBtn) _confirmTerceirosReqBtn.addEventListener('click', _confirmTerceirosRequisition);
            if (_confirmPrintBtn) _confirmPrintBtn.addEventListener('click', _confirmPrintPreview);
            if (_closeTerceirosOrdersModalBtn) _closeTerceirosOrdersModalBtn.addEventListener('click', () => _terceirosOrdersModal.classList.add('hidden'));
            if (_closeNFeModalBtn) _closeNFeModalBtn.addEventListener('click', () => _nfeDetailsModal.classList.add('hidden'));
            if (_closeBrowserPrintFabricaModalBtn) _closeBrowserPrintFabricaModalBtn.addEventListener('click', () => _browserPrintFabricaModal.classList.add('hidden'));

            // --- Event Listeners para a página de Dashboards ---
            const dashboardDateInputs = [_dashboardStartDateInput, _dashboardEndDateInput];
            dashboardDateInputs.forEach(input => {
                if (input) {
                    input.addEventListener('change', () => {
                        document.querySelectorAll('[name="date-range"]').forEach(radio => radio.checked = false);
                        _dashboardState.currentDateFilterValue = 'custom';
                        _renderDashboardsPage();
                    });
                }
            });
            document.querySelectorAll('[name="date-range"]').forEach(radio => {
                radio.addEventListener('change', (event) => {
                    if (event.target.checked) {
                        _setDateRange(event.target.value);
                    }
                });
            });
            if (_dashboardClearFiltersBtn) {
                _dashboardClearFiltersBtn.addEventListener('click', () => {
                    const defaultRadio = document.querySelector('[name="date-range"][value="all"]');
                    if (defaultRadio) defaultRadio.checked = true;
                    _setDateRange('all');
                });
            }
            if (_dashboardSummaryCards) {
                _dashboardSummaryCards.addEventListener('click', (event) => {
                    const card = event.target.closest('[data-id]');
                    if (card) {
                        _updateDashboardChart(card.dataset.id);
                    }
                });
            }

            // Event listener para as células da tabela de vendas (delegado à página para maior robustez)
            if (_pageDashboards) {
                _pageDashboards.addEventListener('click', (event) => {
                    // Procura pelo elemento clicável mais próximo, garantindo que o clique funcione
                    const clickedCell = event.target.closest('.clickable-sales-cell');
                    if (clickedCell) {
                        const monthKey = clickedCell.dataset.monthKey;
                        const channel = clickedCell.dataset.channel;
                        _showSalesDetailsModal(monthKey, channel);
                    }
                });
            }

            // Event listener para o conteúdo do modal de detalhes de vendas
            if (_salesDetailsModalContent) {
                _salesDetailsModalContent.addEventListener('click', (event) => {
                    if (event.target.closest('.view-nfe-observation-btn')) {
                        const nfeId = event.target.closest('.view-nfe-observation-btn').dataset.nfeId;
                        _openNfeObservationModal(nfeId);
                    }
                });

                // Adiciona listeners para o tooltip de observação
                _salesDetailsModalContent.addEventListener('mouseover', (event) => {
                // ATUALIZADO: O tooltip agora é acionado pelo ícone de exclamação
                const exclamationIcon = event.target.closest('.nfe-observation-status-icon');
                if (exclamationIcon) {
                        _showObservationTooltip(event);
                    }
                });
                _salesDetailsModalContent.addEventListener('mouseout', (event) => {
                // ATUALIZADO: O tooltip agora é acionado pelo ícone de exclamação
                const exclamationIcon = event.target.closest('.nfe-observation-status-icon');
                if (exclamationIcon) {
                        _hideProductTooltip(); // Reutiliza a função de esconder tooltip
                    }
                });
            }

            // NOVO: Event listeners para o modal de observação
            if (_cancelNfeObservationBtn) {
                _cancelNfeObservationBtn.addEventListener('click', () => {
                    if (_nfeObservationModal) _nfeObservationModal.classList.add('hidden');
                });
            }
            if (_nfeObservationTextarea) {
                _nfeObservationTextarea.addEventListener('input', _updateObservationCharCount);
            }
            if (_saveNfeObservationBtn) {
                _saveNfeObservationBtn.addEventListener('click', _saveNfeObservation);
            }

            // NOVO: Event listeners para o modal de observação de requisição
            if (_cancelRequisitionObservationBtn) {
                _cancelRequisitionObservationBtn.addEventListener('click', () => {
                    if (_requisitionObservationModal) _requisitionObservationModal.classList.add('hidden');
                });
            }
            if (_requisitionObservationTextarea) {
                _requisitionObservationTextarea.addEventListener('input', _updateRequisitionObservationCharCount);
            }
            if (_saveRequisitionObservationBtn) {
                _saveRequisitionObservationBtn.addEventListener('click', _saveRequisitionObservation);
            }

            // Event listener para fechar o modal de detalhes de vendas
            if (_closeSalesDetailsModalBtn) {
                _closeSalesDetailsModalBtn.addEventListener('click', () => {
                    if (_salesDetailsModal) _salesDetailsModal.classList.add('hidden');
                });
            }

            // Event listener para o novo botão de exportar CSV
            if (_exportSalesDetailsCsvBtn) {
                _exportSalesDetailsCsvBtn.addEventListener('click', _exportSalesDetailsToCSV);
            }

        }

        function _cacheDomElements() {
            _pagePesquisar = document.getElementById('page-pesquisar-produto');
            _pageEstoque = document.getElementById('page-gerenciar-estoque');
            _pageOverviewSaidas = document.getElementById('page-overview-saidas');
            _pageOverviewRequisitions = document.getElementById('page-overview-requisitions');
            _pageSaidaReport = document.getElementById('page-saida-report');
            _pageReport = document.getElementById('page-report');
            _pageGerenciarSaida = document.getElementById('page-gerenciar-saida');
            _pageDashboards = document.getElementById('page-dashboards');
            _navPesquisar = document.getElementById('nav-pesquisar');
            _navEstoque = document.getElementById('nav-estoque');
            _navGerenciarSaida = document.getElementById('nav-gerenciar-saida');
            _navDashboards = document.getElementById('nav-dashboards');
            _refreshButton = document.getElementById('refresh-button');
            _loadingOverlay = document.getElementById('loading-overlay');
            _globalFilterBar = document.getElementById('global-filter-bar');
            _globalSearchInput = document.getElementById('global-search-input');
            _globalFilterButton = document.getElementById('global-filter-button');
            _globalFilterDropdown = document.getElementById('global-filter-dropdown');
            _globalCategoryCheckboxesContainer = document.getElementById('global-category-checkboxes');
            _selectedItemsCountDisplay = document.getElementById('selected-items-count');
            _clearSelectionBtn = document.getElementById('clear-selection-btn');
            _generateReportButton = document.getElementById('generate-report-button');
            _saidaActionsContainer = document.getElementById('saida-actions');
            _selectedSaidaItemsCount = document.getElementById('selected-saida-items-count');
            _createSaidaBtn = document.getElementById('create-saida-btn');
            _viewSaidasBtn = document.getElementById('view-saidas-btn');
            _clearSaidaSelectionBtn = document.getElementById('clear-saida-selection-btn');
            _stockActionsContainer = document.getElementById('stock-actions');
            _globalFilterButtonLabel = document.getElementById('global-filter-button-label');
            _globalFilterMenuContainer = document.getElementById('global-filter-menu-container');
            _product_list_container = document.getElementById('product-list-container');
            _product_details_container = document.getElementById('product-details-container');
            _details_placeholder = document.getElementById('details-placeholder');
            _product_details = document.getElementById('product-details');
            _saidaOverviewCards = document.getElementById('saida-overview-cards');
            _requisitionOverviewCardsContainer = document.getElementById('requisition-overview-cards');
            _ordersTableTitle = document.getElementById('orders-table-title');
            _ordersTableContent = document.getElementById('orders-table-content');
            _noOrdersMessage = document.getElementById('no-orders-message');
            _noOrdersMessageModal = document.getElementById('no-orders-message-modal');
            _ordersSearchInput = document.getElementById('orders-search-input');
            // NOVO: Cache dos elementos do menu de ações da tabela de pedidos
            _ordersTableActionsMenuContainer = document.getElementById('orders-table-actions-menu-container');
            _ordersTableActionsButton = document.getElementById('orders-table-actions-button');
            _ordersTableActionsDropdown = document.getElementById('orders-table-actions-dropdown');
            _ordersTableActionPrintGeneric = document.getElementById('orders-table-action-print-generic');
            _ordersTableActionPrintList = document.getElementById('orders-table-action-print-list');
            _ordersTableActionPrintSolicitation = document.getElementById('orders-table-action-print-solicitation');
            _ordersTableActionExcel = document.getElementById('orders-table-action-excel');
            _ordersFilterMenuContainer = document.getElementById('orders-filter-menu-container');
            _ordersFilterButton = document.getElementById('orders-filter-button');
            _ordersFilterButtonLabel = document.getElementById('orders-filter-button-label');
            _ordersFilterDropdown = document.getElementById('orders-filter-dropdown');
            _ordersStatusCheckboxesContainer = document.getElementById('orders-status-checkboxes');
            _clearGlobalSearchBtn = document.getElementById('clear-global-search-btn'); // NOVO
            _clearOrdersSearchBtn = document.getElementById('clear-orders-search-btn'); // NOVO
            _noNFeMessageOverview = document.getElementById('no-nfe-message-overview'); // Mantido para a mensagem
            _dashboardFilterBar = document.getElementById('dashboard-filter-bar');
            _dashboardStartDateInput = document.getElementById('dashboard-start-date');
            _dashboardEndDateInput = document.getElementById('dashboard-end-date');
            _dashboardSummaryCards = document.getElementById('dashboard-summary-cards');
            _salesChartCanvas = document.getElementById('sales-chart');
            _salesTableContainer = document.getElementById('sales-table-container'); 
            _dashboardClearFiltersBtn = document.getElementById('dashboard-clear-filters-btn'); 
            _orderDetailsModal = document.getElementById('order-details-modal');
            _closeModalBtn = document.getElementById('close-order-modal-btn');
            _modalOrderTitle = document.getElementById('modal-order-title');
            _modalOrderContent = document.getElementById('modal-order-content');
            _messageModal = document.getElementById('message-modal');
            _messageModalTitle = document.getElementById('message-modal-title');
            _messageModalContent = document.getElementById('message-modal-content');
            _messageModalOkBtn = document.getElementById('message-modal-ok-btn');
            _closeMessageModalBtn = document.getElementById('close-message-modal-btn');
            _reportActionBar = document.getElementById('report-action-bar');
            _reportLaunchTerceirosBtn = document.getElementById('report-launch-terceiros-btn');
            _reportLaunchFabricaBtn = document.getElementById('report-launch-fabrica-btn');
            _reportBackBtn = document.getElementById('report-back-btn');
            _pageReportContent = document.getElementById('page-report-content');
            _reportActionsMenuContainer = document.getElementById('report-actions-menu-container');
            _reportActionsButton = document.getElementById('report-actions-button');
            _reportActionsDropdown = document.getElementById('report-actions-dropdown');
            _reportActionPrintList = document.getElementById('report-action-print-list');
            _reportActionPrintReq = document.getElementById('report-action-print-req');
            _reportActionExcel = document.getElementById('report-action-excel');
            _printTableModal = document.getElementById('print-table-modal');
            _printModalTitle = document.getElementById('print-modal-title');
            _printModalContent = document.getElementById('print-modal-content');
            _cancelPrintBtn = document.getElementById('cancel-print-btn');
            _printArea = document.getElementById('print-area');
            _confirmPrintBtn = document.getElementById('confirm-print-btn');
            _confirmationModal = document.getElementById('confirmation-modal');
            _confirmationModalTitle = document.getElementById('confirmation-modal-title');
            _confirmationModalContent = document.getElementById('confirmation-modal-content');
            _confirmYesBtn = document.getElementById('confirm-yes-btn');
            _confirmNoBtn = document.getElementById('confirm-no-btn');
            // NOVO: Cache dos elementos do modal de requisição de terceiros
            _terceirosRequisitionModal = document.getElementById('terceiros-requisition-modal');
            _closeTerceirosReqModalBtn = document.getElementById('close-terceiros-req-modal-btn');
            _terceirosReqModalMessage = document.getElementById('terceiros-req-modal-message');
            _terceirosRequisitionCodeInput = document.getElementById('terceiros-requisition-code-input');
            _confirmTerceirosReqBtn = document.getElementById('confirm-terceiros-req-btn');
            _cancelTerceirosReqBtn = document.getElementById('cancel-terceiros-req-btn');
            _terceirosOrdersModal = document.getElementById('terceiros-orders-modal');
            _closeTerceirosOrdersModalBtn = document.getElementById('close-terceiros-orders-modal-btn');
            _nfeDetailsModal = document.getElementById('nfe-details-modal');
            _closeNFeModalBtn = document.getElementById('close-nfe-modal-btn');
            _nfeModalTitle = document.getElementById('nfe-modal-title');
            _printNFeModalTableBtn = document.getElementById('print-nfe-modal-table-btn');
            _nfeModalSearchInput = document.getElementById('nfe-modal-search-input');
            _nfeModalTableContent = document.getElementById('nfe-modal-table-content');
            _noNFeMessageModal = document.getElementById('no-nfe-message-modal');
            _browserPrintFabricaModal = document.getElementById('browser-print-fabrica-modal');
            _browserPrintFabricaContent = document.getElementById('browser-print-fabrica-content');
            _closeBrowserPrintFabricaModalBtn = document.getElementById('close-browser-print-fabrica-modal-btn');
            _customProductTooltip = document.createElement('div');
            // NOVO: Cache dos elementos do modal de detalhes de vendas
            _salesDetailsModal = document.getElementById('sales-details-modal');
            _closeSalesDetailsModalBtn = document.getElementById('close-sales-details-modal-btn');
            _salesDetailsModalTitle = document.getElementById('sales-details-modal-title');
            _salesDetailsModalContent = document.getElementById('sales-details-modal-content');
            _noSalesDetailsMessage = document.getElementById('no-sales-details-message');
            _exportSalesDetailsCsvBtn = document.getElementById('export-sales-details-csv-btn');
            // NOVO: Cache dos elementos do modal de observação
            _nfeObservationModal = document.getElementById('nfe-observation-modal');
            _nfeObservationModalInfo = document.getElementById('nfe-observation-modal-info');
            _nfeObservationHistory = document.getElementById('nfe-observation-history');
            _nfeObservationTextarea = document.getElementById('nfe-observation-textarea');
            _saveNfeObservationBtn = document.getElementById('save-nfe-observation-btn');
            _cancelNfeObservationBtn = document.getElementById('cancel-nfe-observation-btn');
            _nfeObservationCharCount = document.getElementById('nfe-observation-char-count');
            // NOVO: Cache dos elementos do modal de observação de requisição
            _requisitionObservationModal = document.getElementById('requisition-observation-modal');
            _requisitionObservationModalInfo = document.getElementById('requisition-observation-modal-info');
            _requisitionObservationHistory = document.getElementById('requisition-observation-history');
            _requisitionObservationTextarea = document.getElementById('requisition-observation-textarea');
            _saveRequisitionObservationBtn = document.getElementById('save-requisition-observation-btn');
            _cancelRequisitionObservationBtn = document.getElementById('cancel-requisition-observation-btn');
            _requisitionObservationCharCount = document.getElementById('requisition-observation-char-count');
            _customProductTooltip.id = 'custom-product-tooltip';
            _customProductTooltip.className = 'fixed hidden bg-white p-1 rounded-lg shadow-2xl border border-gray-200 z-[100]'; 
            _customProductTooltip.style.pointerEvents = 'none'; // Importante para não interferir com outros eventos
            _customProductTooltip.style.transition = 'opacity 0.2s ease-in-out'; 
            _customProductTooltip.style.opacity = '0'; 
            _customProductTooltip.style.width = 'max-content'; // Garante que o tooltip se ajuste ao conteúdo
            document.body.appendChild(_customProductTooltip);
            _viewRequisitionsBtn = document.getElementById('view-requisitions-btn');
            _requisitionActionBar = document.getElementById('requisition-action-bar');
            _saidaActionBar = document.getElementById('saida-action-bar');
            _saidaBackBtn = document.getElementById('saida-back-btn');
            _pageSaidaReportContent = document.getElementById('page-saida-report-content');
            _saidaReportActionBar = document.getElementById('saida-report-action-bar');
            _saidaReportBackBtn = document.getElementById('saida-report-back-btn');
            _launchSaidaGarantiaBtn = document.getElementById('launch-saida-garantia-btn');
            _launchSaidaFabricaBtn = document.getElementById('launch-saida-fabrica-btn');
            _requisitionBackBtn = document.getElementById('requisition-back-btn');
            // NOVO: Cache dos elementos do modal de ajuste de estoque
            _stockAdjustmentModal = document.getElementById('stock-adjustment-modal');
            _closeStockAdjustmentModalBtn = document.getElementById('close-stock-adjustment-modal-btn');
            _stockAdjustmentProductInfo = document.getElementById('stock-adjustment-product-info');
            _stockAdjustmentCurrentStock = document.getElementById('stock-adjustment-current-stock');
            _stockAdjustmentNewQuantity = document.getElementById('stock-adjustment-new-quantity');
            _confirmStockAdjustmentBtn = document.getElementById('confirm-stock-adjustment-btn');
            _cancelStockAdjustmentBtn = document.getElementById('cancel-stock-adjustment-btn');
        }

        function _setDefaultDateFilters() {
            // Dashboard default
            const dashboardDefaultRadio = document.querySelector('[name="date-range"][value="all"]');
            if (dashboardDefaultRadio) dashboardDefaultRadio.checked = true;
            _setDateRange('all');
        }

        return {
            /**
             * Inicializa a aplicação.
             */
            init: function() {
                _cacheDomElements();
                _bindEvents();
                _bindStockAdjustmentModalEvents(); // NOVO
                _setupClearableInputs(); // NOVO: Configura os botões de limpar
                _setDefaultDateFilters();
                
                if (typeof PesquisarProduto !== 'undefined') {
                    PesquisarProduto.init({
                        allProducts: _allProducts,
                        domElements: {
                            product_list_container: _product_list_container,
                            product_details_container: _product_details_container,
                            details_placeholder: _details_placeholder,
                            product_details: _product_details,
                        },
                        utilities: { 
                            createDetailItem,
                            showProductTooltip: _showProductTooltip, // Mantido para compatibilidade, mas o módulo usa o seu próprio
                            hideProductTooltip: _hideProductTooltip // Mantido para compatibilidade
                        },
                        openStockAdjustmentModal: _openStockAdjustmentModal // NOVO: Passa a função para o módulo
                    });
                } else {
                    console.error("Erro: Módulo PesquisarProduto não foi carregado corretamente.");
                    _showMessageModal("Erro de Carregamento", "Não foi possível carregar o módulo de pesquisa de produtos.");
                }
                _showPage('pesquisar');
                _fetchData();
            }
        };
    })();

    // CORREÇÃO: Expõe a função de inicialização diretamente no escopo global
    // para que o auth.js possa encontrá-la assim que o script for parseado.
    window.startApp = App.init;

    // O script auth.js, que é carregado antes, agora é responsável
    // por chamar window.startApp() quando estiver pronto.

</script>

</body>
</html>